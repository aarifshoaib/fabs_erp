{% load static %}
<!DOCTYPE html>
<html lang="en">
  {% block head %}
    {% include 'partials/head.html' %}
  {% endblock head %}
<style>
    .watermark {
    position: fixed;
    bottom: 10px;
    right: 10px;
    font-size: 12px;
    color: #888;
    opacity: 0.5;
    z-index: 9999;
    pointer-events: none;
}

</style>
  <body class="{% if request.path == '/chat' %} main-chat-blk {% else %} {% endif %}">
    {% if request.path == '/index' or request.path == '/leads-dashboard' or request.path == '/project-dashboard' %}
      <div class="preloader">
        <span class="loader"></span>
      </div>
    {% endif %}

    <div class="main-wrapper">
      {% block header %}
        {% include 'partials/topbar.html' %}
      {% endblock header %}

      {% block sidebar %}
        {% include 'partials/sidebar.html' %}
      {% endblock sidebar %}

      {% block content %}
      {{ block.super }}
  
  <!-- Job Form Modal -->
  <div class="offcanvas offcanvas-end" tabindex="-1" id="job-add" aria-labelledby="job-add-label">
      <div class="offcanvas-header">
          <h5 id="job-add-label">Add New Job</h5>
          <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
      </div>
      <div class="offcanvas-body">
          <form id="job-form" method="post">
              {% csrf_token %}
              {{ form.as_p }}
              <button type="submit" class="btn btn-primary">Save Job</button>
          </form>
      </div>
  </div>

      {% endblock content %}
    </div>

    {% block javascript %}
      {% include 'partials/script.html' %}
    {% endblock javascript %}

    
    {% block theme_settings %}
      {% include 'partials/theme-settings.html' %}
    {% endblock theme_settings %}
      
    <div class="watermark">Powered by Fabs</div>
  </body>
  
  <script type="text/javascript">
    $(document).ready(function () {
        // alert('a');
        $.ajax({
            type: 'GET',
            url: '/sidebar',
            success: function (response) {
                if (response.status == "success" && response.parent_menu_data.length > 0) {
                    var parent_menu_data = response.parent_menu_data;
                    var child_menu_data = response.child_menu_data;
                    var permission_data = response.permission_data;
                    let menu_ids = response.menu_ids;
                    console.log("--------------------------------")
                    console.log(menu_ids)
                    console.log(permission_data)
                    // console.log(child_menu_data)
                    let screen_name = '';
                    let menu_html = '';

                    const pathParts = window.location.pathname.split('/');
                    screen_name = '/' + (pathParts[1] || '');

                    if (pathParts[2]) {
                    screen_name += '/' + pathParts[2];
                    }

                    console.log(screen_name);


                    
                    let menu_id = 0;
                    child_menu_data.forEach(function(item) {
                        if (item.url == screen_name) {
                            menu_id = item.menu_id;
                        }
                    });
                    console.log(menu_id)

                    let permission = [];
                    permission_data.forEach(function(item) {
                        if (item.menu_id == menu_id) {
                            permission.push(item)
                        }
                    });
                    console.log(permission)
                    console.log("--------------------------------")

                    let add = false;
                    let view = false;
                    let edit = false;
                    let deletee = false;
                    let execute = false;

                    permission.forEach(function(item) {
                        if (item.add) {
                            add = true;
                        }
                        if (item.view) {
                            view = true;
                        }
                        if (item.edit) {
                            edit = true;
                        }
                        if (item.delete) {
                            deletee = true;
                        }
                        if (item.execute) {
                            execute = true;
                        }
                    });
                    
                    if (!add) {
                        $('.add-btn').detach();
                        $('form :input').prop('disabled', false);
                    }
                    if (!edit) {
                        // $('form :input').prop('disabled', true);
                        $('.edit-btn').detach();
                    }
                    if (!deletee){
                      $('.delete-btn').detach();
                    }
                    

                    $('ul.menu').empty(); // Clear existing menu

                    $.each(parent_menu_data, function (index, parent) {
                        var submenu_html = '';

                        // Find child menus related to this parent
                        var children = child_menu_data.filter(child => parseInt(child.parent_menu_id,10) === parent.menu_id);
                        console.log(children)

                        if (children.length > 0) {
                            submenu_html += '<ul>';
                            $.each(children, function (childIndex, child) {
                                submenu_html += `<li><a href="${child.url}">${child.screen_name}</a></li>`;
                            });
                            submenu_html += '</ul>';
                        }

                        menu_html += `
                            <li class="submenu">
                                <a href="javascript:void(0);">
                                    <i class="ti ti-layout-2"></i>
                                    <span>${parent.screen_name}</span>
                                    <span class="menu-arrow"></span>
                                </a>
                                ${submenu_html}
                            </li>
                        `;
                    });

                    $('ul.menu').append(menu_html);

                    
                    $('li.submenu > a').on('click', function () {
                        var $submenu = $(this).next('ul');
                        $submenu.slideToggle();
                        $(this).parent().toggleClass('active');
                    });

                }
            },
            error: function () {
                console.error('Failed to load sidebar menu.');
            }
        });
    });
</script>
<script src="{% static 'js/modal_script.js' %}"></script>
</html>
