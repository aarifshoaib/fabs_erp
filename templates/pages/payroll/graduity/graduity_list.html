{% extends "partials/base.html" %}
{% load static %}
{% block content %}
<div class="page-wrapper">
    <div class="content">
        <div class="row">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h4 class="card-title mb-0">Gratuity Settlements</h4>
                        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addGratuityModal">
                            <i class="ti ti-plus"></i> Add Gratuity
                        </button>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-bordered">
                                <thead>
                                    <tr>
                                        <th>Employee Code</th>
                                        <th>Employee Name</th>
                                        <th>Date of Joining</th>
                                        <th>Date of Exit</th>
                                        <th>Last Drawn Salary</th>
                                        <th>Eligible Gratuity</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for record in gratuity_list %}
                                    <tr>
                                        <td>{{ record.employee_code }}</td>
                                        <td>{{ record.employee_name }}</td>
                                        <td>{{ record.date_of_joining }}</td>
                                        <td>{{ record.date_of_exit }}</td>
                                        <td>{{ record.last_drawn_basic_salary }}</td>
                                        <td>{{ record.eligible_gratuity }}</td>
                                        <td>
                                            <span class="badge {% if record.gratuity_status == 'Paid' %}bg-success{% elif record.gratuity_status == 'Approved' %}bg-info{% else %}bg-warning{% endif %}">
                                                {{ record.gratuity_status }}
                                            </span>
                                        </td>
                                        <td>
                                            <button class="btn btn-sm btn-info edit-graduity-btn" data-id="{{ record.id }}">Edit</button>
                                            <form method="post" action="{% url 'delete_gratuity' record.id %}" style="display:inline;">
                                                {% csrf_token %}
                                                <button type="submit" class="btn btn-sm btn-danger" onclick="return confirm('Delete this record?')">Delete</button>
                                            </form>
                                        </td>
                                    </tr>
                                    {% empty %}
                                    <tr>
                                        <td colspan="8" class="text-center">No records found.</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        <!-- Pagination if needed -->
                        {% if gratuity_list.has_other_pages %}
                        <nav>
                            <ul class="pagination">
                                {% if gratuity_list.has_previous %}
                                <li class="page-item"><a class="page-link" href="?page={{ gratuity_list.previous_page_number }}">Previous</a></li>
                                {% endif %}
                                {% for num in gratuity_list.paginator.page_range %}
                                <li class="page-item {% if gratuity_list.number == num %}active{% endif %}">
                                    <a class="page-link" href="?page={{ num }}">{{ num }}</a>
                                </li>
                                {% endfor %}
                                {% if gratuity_list.has_next %}
                                <li class="page-item"><a class="page-link" href="?page={{ gratuity_list.next_page_number }}">Next</a></li>
                                {% endif %}
                            </ul>
                        </nav>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script>
     $(".edit-graduity-btn").click(function (event) {
        event.preventDefault();
        var id = $(this).data("id");
        
        // Show the edit modal
        var editModal = new bootstrap.Offcanvas(document.getElementById("editGratuityModal"));
        editModal.show();

        // Fetch gratuity details via AJAX
        $.ajax({
            url: '/get_gratuity_details/' + id + '/',  // Update this URL to match your Django URL pattern
            method: 'GET',
            success: function(response) {
                // Populate form fields with response data
                $('#edit_id').val(response.id);
                $('#edit_employee_code').val(response.employee_code);
                $('#edit_employee_name').val(response.employee_name);
                $('#edit_category').val(response.category);
                $('#edit_designation').val(response.designation);
                $('#edit_date_of_joining').val(response.date_of_joining);
                $('#edit_date_of_exit').val(response.date_of_exit);
                $('#edit_last_drawn_basic_salary').val(response.last_drawn_basic_salary);
                $('#edit_eligible_gratuity').val(response.eligible_gratuity);
                $('#edit_gratuity_status').val(response.gratuity_status);
                $('#edit_settlement_status').val(response.settlement_status);
                $('#edit_payment_mode').val(response.payment_mode);
                $('#edit_bank_name').val(response.bank_name);
                $('#edit_bank_account_no').val(response.bank_account_no);
                $('#edit_remarks').val(response.remarks);
                
                // Update form action URL
                $('#edit_gratuity_form').attr('action', '/update_gratuity/' + id + '/');
            },
            error: function(xhr, status, error) {
                console.error('Error fetching gratuity details:', error);
                alert('Error loading gratuity details. Please try again.');
            }
        });
    });
</script>

<!-- Add Modal -->
{% include "pages/payroll/graduity/graduity_modal.html"%}

{% endblock %}
