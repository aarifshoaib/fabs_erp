{% extends 'partials/base.html' %}
{% load static %}
{% block content %}
  <div class="page-wrapper">
    <div class="content">
      <div class="row">
        <div class="col-md-12">
          <!-- Page Header -->
          <div class="page-header">
            <div class="row align-items-center">
              <div class="col-8">
                <h4 class="page-title">User Master<span class="count-title">{{ users.count }}</span></h4>
              </div>
              <div class="col-4 text-end">
                <div class="head-icons">
                  <a href="{% url 'user_list' %}" data-bs-toggle="tooltip" data-bs-placement="top" data-bs-original-title="Refresh"><i class="ti ti-refresh-dot"></i></a>
                  <a href="javascript:void(0);" data-bs-toggle="tooltip" data-bs-placement="top" data-bs-original-title="Collapse" id="collapse-header"><i class="ti ti-chevrons-up"></i></a>
                </div>
              </div>
            </div>
          </div>
          <!-- /Page Header -->

          <div class="card">
            <div class="card-header">
              <!-- Search -->
              <div class="row align-items-center">
                <div class="col-sm-4">
                  <div class="icon-form mb-3 mb-sm-0">
                    <span class="form-icon"><i class="ti ti-search"></i></span>
                    <input type="text" class="form-control" placeholder="Search User" />
                  </div>
                </div>
                <div class="col-sm-8">
                  <div class="d-flex align-items-center flex-wrap row-gap-2 justify-content-sm-end">
                    <a href="javascript:void(0);" class="btn btn-primary" data-bs-toggle="offcanvas" data-bs-target="#offcanvas_add"><i class="ti ti-square-rounded-plus me-2"></i>Add User</a>
                  </div>
                </div>
              </div>
              <!-- /Search -->
            </div>

            <div class="card-body">
              <!-- Manage Users List -->
              <div class="table-responsive custom-table">
                <table class="table datatable">
                  <thead class="thead-light">
                    <tr>
                      <th>User ID</th>
                      <th>First Name</th>
                      <th>Last Name</th>
                      <th>Email</th>
                      <th>Gender</th>
                      <th>Status</th>
                      <th>Created On</th>
                      <th>Action</th>
                    </tr>
                  </thead>
                  <tbody>
                    {% for user in users %}
                    <tr>
                      <td>{{ user.user_id }}</td>
                      <td>{{ user.first_name }}</td>
                      <td>{{ user.last_name }}</td>
                      <td>{{ user.email }}</td>
                      <td>
                        {% for gender in gender_data %}
                            {% if user.gender == gender.base_value %}
                                {{ gender.base_description }}
                            {% endif %}
                        {% endfor %}
                    </td>                                       
                      <td>
                        <span class="badge {% if user.is_active %}badge-pill badge-status bg-success{% else %}badge-pill badge-status bg-danger{% endif %}">
                          {% if user.is_active %}Active{% else %}Inactive{% endif %}
                        </span>
                      </td>
                      <td>{{ user.created_on }}</td>
                      <td>
                        <div class="dropdown table-action">
                          <a href="#" class="action-icon" data-bs-toggle="dropdown" aria-expanded="false"><i class="fa fa-ellipsis-v"></i></a>
                          <div class="dropdown-menu dropdown-menu-right">
                            <a class="dropdown-item" href="javascript:void(0);" data-bs-toggle="offcanvas" data-bs-target="#offcanvas_edit_{{ user.user_master_id }}"><i class="ti ti-edit text-blue"></i> Edit</a>
                            <a class="dropdown-item" href="#" data-bs-toggle="modal" data-bs-target="#delete_user_{{ user.user_master_id }}"><i class="ti ti-trash text-danger"></i> Delete</a>
                          </div>
                        </div>
                      </td>
                    </tr>
                    <!-- Edit User Offcanvas -->
<div class="offcanvas offcanvas-end offcanvas-large" id="offcanvas_edit_{{ user.user_master_id }}">
  <div class="offcanvas-header border-bottom">
    <h5 class="offcanvas-title">Edit User</h5>
    <button type="button" class="btn-close custom-btn-close border p-1 me-0 d-flex align-items-center justify-content-center rounded-circle" data-bs-dismiss="offcanvas" aria-label="Close">
      <i class="ti ti-x"></i>
    </button>
  </div>
  <div class="offcanvas-body">
    <form id="editUserForm_{{ user.user_master_id }}" method="post" action="{% url 'user_update' user.user_master_id %}" enctype="multipart/form-data">
      {% csrf_token %}
      <div class="row">
        <!-- Left Column -->
        <div class="col-md-6">
          <div class="form-group mb-3">
            <label class="col-form-label">First Name <span class="text-danger">*</span></label>
            <input type="text" name="first_name" class="form-control" value="{{ user.first_name }}" required tabindex="1">
          </div>
          <div class="form-group mb-3">
            <label class="col-form-label">Last Name</label>
            <input type="text" name="last_name" class="form-control" value="{{ user.last_name }}" tabindex="2">
          </div>
          <div class="form-group mb-3">
            <label class="col-form-label">User ID <span class="text-danger">*</span></label>
            <input type="text" name="user_id" class="form-control" value="{{ user.user_id }}" readonly tabindex="3">
          </div>
          <div class="form-group mb-3">
            <label class="col-form-label">Password <span class="text-danger">*</span></label>
            <input type="password" name="password" class="form-control" value="{{ user.password }}" required tabindex="4">
            <div id="password_invalid_feedback_edit_{{ user.user_master_id }}" class="invalid-feedback"></div>
          </div>
          <div class="form-group mb-3">
            <label class="col-form-label">Gender <span class="text-danger">*</span></label>
            <select name="gender" class="form-control" required tabindex="5">
              <option value="">Select</option>
              {% for gender in gender_data %}
                <option value="{{ gender.base_value }}" {% if user.gender == gender.base_value %}selected{% endif %}>
                  {{ gender.base_description }}
                </option>
              {% endfor %}
            </select>
          </div>
          <div class="form-group mb-3">
            <label class="col-form-label">Date of Birth</label>
            <input type="date" name="dob" class="form-control" value="{{ user.dob|date:'Y-m-d' }}" tabindex="6">
          </div>
        </div>
        <!-- Right Column -->
        <div class="col-md-6">
          <div class="form-group mb-3">
            <label class="col-form-label">Profile Picture</label>
            <input type="file" name="profile_picture" class="form-control" tabindex="7">
            {% if user.profile_picture %}
              <img src="{{ user.profile_picture.url }}" alt="Profile Picture" class="img-thumbnail mt-2" width="100">
            {% endif %}
          </div>
          <div class="form-group mb-3">
            <label class="col-form-label">User Paycycles</label>
            <select name="user_paycycles" class="form-control" tabindex="8">
              <option value="">Select</option>
              {% for paycycle in paycycle_data %}
                <option value="{{ paycycle.base_value }}">{{ paycycle.base_description }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="form-group mb-3">
            <label class="col-form-label">Email <span class="text-danger">*</span></label>
            <input type="email" name="email" class="form-control" value="{{ user.email }}" required tabindex="9">
          </div>
          <div class="form-group mb-3">
            <label class="col-form-label">Employee Code</label>
            <select name="emp_code" class="form-control" required tabindex="10">
              <option value="">Select</option>
              {% for employee in employee_data %}
                <option value="{{ employee.emp_code }}" {% if user.emp_code == employee.emp_code %}selected{% endif %}>
                  {{ employee.emp_code }} - {{ employee.emp_name }}
                </option>
              {% endfor %}
            </select>
            <input type="hidden" name="created_by" value="{{ user.created_by }}">
          </div>
          <!-- Add hidden comp_code field -->
          <input type="hidden" name="comp_code" value="1000">
          <div class="form-group form-check">
            <input type="checkbox" name="is_active" class="form-check-input" id="is_active_{{ user.user_master_id }}" {% if user.is_active %}checked{% endif %} tabindex="11">
            <label class="form-check-label" for="is_active_{{ user.user_master_id }}">Active</label>
          </div>
        </div>
      </div>
      <div class="d-flex align-items-center justify-content-end">
        <button type="button" data-bs-dismiss="offcanvas" class="btn btn-light me-2" tabindex="12">Cancel</button>
        <button type="submit" class="btn btn-primary" tabindex="13">Update</button>
      </div>
    </form>
  </div>
</div>
                    <!-- Delete User Modal -->
                    <div class="modal fade" id="delete_user_{{ user.user_master_id }}" tabindex="-1" aria-labelledby="deleteUserModalLabel" aria-hidden="true">
                      <div class="modal-dialog">
                        <div class="modal-content">
                          <div class="modal-header">
                            <h5 class="modal-title" id="deleteUserModalLabel">Delete User</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close">
                              <i class="ti ti-x"></i>
                            </button>
                          </div>
                          <div class="modal-body">
                            Are you sure you want to delete this user?
                          </div>
                          <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                            <form id="deleteUserForm_{{ user.user_master_id }}" method="post" action="{% url 'user_delete' user.user_master_id %}">
                              {% csrf_token %}
                              <button type="submit" class="btn btn-danger">Delete</button>
                            </form>
                          </div>
                        </div>
                      </div>
                    </div>
                    <!-- /Delete User Modal -->
                    {% endfor %}
                  </tbody>
                </table>
              </div>
              <!-- /Manage Users List -->
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Add User Offcanvas -->
  <div class="offcanvas offcanvas-end offcanvas-large" tabindex="-1" id="offcanvas_add">
    <div class="offcanvas-header border-bottom">
      <h5 class="offcanvas-title">Add User</h5>
      <button type="button" class="btn-close custom-btn-close border p-1 me-0 d-flex align-items-center justify-content-center rounded-circle" data-bs-dismiss="offcanvas" aria-label="Close">
        <i class="ti ti-x"></i>
      </button>
    </div>
    <div class="offcanvas-body">
      <form id="addUserForm" class="needs-validation" method="post" action="{% url 'user_create' %}" enctype="multipart/form-data" novalidate>
        {% csrf_token %}
        <div id="general_error" class="alert alert-danger d-none"></div>
        <div class="row">
          <!-- Left Column -->
          <div class="col-md-6">
            <div class="form-group mb-3">
              <label class="col-form-label">First Name <span class="text-danger">*</span></label>
              <input type="text" name="first_name" class="form-control" required tabindex="1">
              <div class="invalid-feedback">Please enter a first name.</div>
            </div>
            <div class="form-group mb-3">
              <label class="col-form-label">Last Name</label>
              <input type="text" name="last_name" class="form-control" tabindex="2">
            </div>
            <div class="form-group mb-3">
              <label class="col-form-label">User ID <span class="text-danger">*</span></label>
              <input type="text" name="user_id" id="user_id" class="form-control" required tabindex="3">
              <div id="user_id_invalid_feedback" class="invalid-feedback"></div>
              <div id="user_id_valid_feedback" class="valid-feedback"></div>
            </div>
            <div class="form-group mb-3">
              <label class="col-form-label">Password <span class="text-danger">*</span></label>
              <input type="password" name="password" class="form-control" required tabindex="4">
              <div id="password_invalid_feedback" class="invalid-feedback"></div>
            </div>
            <div class="form-group mb-3">
              <label class="col-form-label">Gender <span class="text-danger">*</span></label>
              <select name="gender" class="form-control" required tabindex="5">
                <option value="">Select</option>
                {% for gender in gender_data %}
                  <option value="{{ gender.base_value }}">{{ gender.base_description }}</option>
                {% endfor %}
              </select>
              <div class="invalid-feedback">Please select a gender.</div>
            </div>
            <div class="form-group mb-3">
              <label class="col-form-label">Date of Birth</label>
              <input type="date" name="dob" class="form-control" tabindex="6">
            </div>
          </div>
          <!-- Right Column -->
          <div class="col-md-6">
            <div class="form-group mb-3">
              <label class="col-form-label">Profile Picture</label>
              <input type="file" name="profile_picture" class="form-control" tabindex="7">
            </div>
            <div class="form-group mb-3">
              <label class="col-form-label">User Paycycles</label>
              <select name="user_paycycles" class="form-control select2" multiple="multiple" tabindex="8">
                {% for paycycle in paycycle_data %}
                  <option value="{{ paycycle.base_value }}">{{ paycycle.base_description }}</option>
                {% endfor %}
              </select>
            </div>
            <div class="form-group mb-3">
              <label class="col-form-label">Email <span class="text-danger">*</span></label>
              <input type="email" name="email" class="form-control" required tabindex="9">
              <div class="invalid-feedback">Please enter a valid email address.</div>
            </div>
            <div class="form-group mb-3">
              <label class="col-form-label">Employee Code</label>
              <select name="emp_code" id="emp_code" class="form-control" required onchange="fetchEmployeeData(this.value)">
                <option value="">Select</option>
                {% for employee in employee_data %}
                  <option value="{{ employee.emp_code }}"
                          data-firstname="{{ employee.emp_name }}"
                          data-surname="{{ employee.surname }}"
                          data-dob="{{ employee.dob|date:'Y-m-d' }}"
                          data-gender="{{ employee.emp_sex }}">
                    {{ employee.emp_code }} - {{ employee.emp_name }}
                  </option>
                {% endfor %}
              </select>
              <input type="hidden" name="created_by" value="4">
            </div>
            <!-- Add hidden comp_code field -->
            <input type="hidden" name="comp_code" value="1000">
            <div class="form-group form-check mb-3">
              <input type="checkbox" name="is_active" class="form-check-input" id="is_active" checked tabindex="11">
              <label class="form-check-label" for="is_active">Active</label>
            </div>
          </div>
        </div>
        <div class="d-flex align-items-center justify-content-end">
          <button type="button" data-bs-dismiss="offcanvas" class="btn btn-light me-2" tabindex="12">Cancel</button>
          <button type="submit" class="btn btn-primary" tabindex="13">Save</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    function fetchEmployeeData(empCode) {
  console.log("Selected Employee Code:", empCode);

  let selectedOption = document.querySelector(`#emp_code option[value="${empCode}"]`);

  if (selectedOption) {
    // Extract data
    let firstName = selectedOption.dataset.firstname || "";
    let surname = selectedOption.dataset.surname || "";
    let dob = selectedOption.dataset.dob || "";
    let gender = selectedOption.dataset.gender || "";

    console.log("Fetched Data:", { firstName, surname, dob, gender });

    // Update fields directly
    let firstNameField = document.querySelector('#offcanvas_add input[name="first_name"]');
    let surnameField = document.querySelector('#offcanvas_add input[name="last_name"]');
    let dobField = document.querySelector('#offcanvas_add input[name="dob"]');
    let genderField = document.querySelector('#offcanvas_add select[name="gender"]');

    if (firstNameField) {
      firstNameField.value = firstName;
      firstNameField.dispatchEvent(new Event("input", { bubbles: true }));
    } else {
      console.error("First Name field not found!");
    }

    if (surnameField) {
      surnameField.value = surname;
      surnameField.dispatchEvent(new Event("input", { bubbles: true }));
    } else {
      console.error("Last Name field not found!");
    }

    if (dobField) {
      dobField.value = dob;
      dobField.dispatchEvent(new Event("input", { bubbles: true }));
    } else {
      console.error("Date of Birth field not found!");
    }

    if (genderField) {
      genderField.value = gender;
      genderField.dispatchEvent(new Event("change", { bubbles: true }));
    } else {
      console.error("Gender field not found!");
    }

    console.log("Updated Form Fields Successfully!");
  } else {
    console.error("Error: Selected option not found in dropdown!");
  }
}

// Ensure script runs after page loads
document.addEventListener("DOMContentLoaded", function () {
  let offcanvasElement = document.getElementById("offcanvas_add");

  offcanvasElement.addEventListener("shown.bs.offcanvas", function () {
    console.log("Offcanvas is fully shown.");

    let empCodeDropdown = document.getElementById("emp_code");
    if (empCodeDropdown) {
      empCodeDropdown.addEventListener("change", function () {
        console.log("Dropdown changed. Fetching employee data...");
        fetchEmployeeData(this.value);
      });
    } else {
      console.error("Error: Employee Code dropdown not found!");
    }
  });
});
  </script>

      <script>
        // Password Validation Function
        function validatePassword(password) {
            const minLength = 8;
            const hasUpperCase = /[A-Z]/.test(password);
            const hasLowerCase = /[a-z]/.test(password);
            const hasNumber = /[0-9]/.test(password);
            const hasSpecialChar = /[!@#$%^&*(),.?":{}|<>]/.test(password);

            return password.length >= minLength && hasUpperCase && hasLowerCase && hasNumber && hasSpecialChar;
        }

        // User ID Availability Check
        document.getElementById("user_id").addEventListener("blur", function () {
            let userId = this.value.trim();
            let validFeedback = document.getElementById("user_id_valid_feedback");
            let invalidFeedback = document.getElementById("user_id_invalid_feedback");

            if (!userId) {
                invalidFeedback.textContent = "User ID is required.";
                invalidFeedback.style.display = "block";
                validFeedback.style.display = "none";
                return;
            }

            fetch("{% url 'user_create' %}", {
                method: "POST",
                headers: {
                    "Content-Type": "application/x-www-form-urlencoded",
                    "X-CSRFToken": document.querySelector("[name=csrfmiddlewaretoken]").value,
                },
                body: new URLSearchParams({
                    "user_id": userId,
                    "check_availability": "true",
                }),
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === "error") {
                    invalidFeedback.textContent = data.message;
                    invalidFeedback.style.display = "block";
                    validFeedback.style.display = "none";
                } else {
                    validFeedback.textContent = data.message;
                    validFeedback.style.display = "block";
                    invalidFeedback.style.display = "none";
                }
            })
            .catch(error => {
                console.error("Error:", error);
            });
        });

        // Form Submission with Password Validation
        document.getElementById("addUserForm").addEventListener("submit", function (event) {
            event.preventDefault();

            let form = this;
            let formData = new FormData(form);
            let generalErrorDiv = document.getElementById("general_error");
            let password = formData.get("password");

            // Password Validation
            if (!validatePassword(password)) {
                let passwordError = document.getElementById("password_invalid_feedback");
                passwordError.textContent = "Password must contain at least one uppercase letter, one lowercase letter, one number, one special character, and be at least 8 characters long.";
                passwordError.style.display = "block";
                return;
            }

            document.querySelectorAll(".invalid-feedback").forEach(el => el.style.display = "none");
            generalErrorDiv.classList.add("d-none");
            generalErrorDiv.textContent = "";

            fetch(form.action, {
                method: "POST",
                headers: {
                    "X-CSRFToken": document.querySelector("[name=csrfmiddlewaretoken]").value,
                },
                body: formData,
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === "error") {
                    let fieldName = data.field;
                    if (fieldName === "general") {
                        generalErrorDiv.textContent = data.message;
                        generalErrorDiv.classList.remove("d-none");
                    } else {
                        let errorElement = document.getElementById(fieldName + "_invalid_feedback");
                        if (errorElement) {
                            errorElement.textContent = data.message;
                            errorElement.style.display = "block";
                        }
                    }
                } else if (data.status === "success") {
                    if (data.redirect_url) {
                        window.location.href = data.redirect_url;
                    }
                }
            })
            .catch(error => {
                console.error("Error:", error);
            });
        });

        // Edit User Form Submission with Password Validation and Redirect
        document.querySelectorAll("[id^=editUserForm_]").forEach(form => {
      form.addEventListener("submit", function (event) {
          event.preventDefault();

          let formData = new FormData(form);
          let password = formData.get("password");

          // Password Validation
          if (!validatePassword(password)) {
              let passwordError = document.getElementById("password_invalid_feedback_edit_" + form.id.split("_").pop());
              passwordError.textContent = "Password must contain at least one uppercase letter, one lowercase letter, one number, one special character, and be at least 8 characters long.";
              passwordError.style.display = "block";
              return;
          }

          fetch(form.action, {
              method: "POST",
              headers: {
                  "X-CSRFToken": document.querySelector("[name=csrfmiddlewaretoken]").value,
              },
              body: formData,
          })
          .then(response => response.json())
          .then(data => {
              if (data.status === "error") {
                  alert(data.message); // Show error message if any
              } else if (data.status === "success") {
                  // Redirect to the user list page after successful update
                  window.location.href = "{% url 'user_list' %}";
              }
          })
          .catch(error => {
              console.error("Error:", error);
          });
      });
  });

</script>
      </div>
    </div>
    {% endblock content %}