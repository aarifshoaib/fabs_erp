<!-- Add Purchase Order Modal -->
<div class="offcanvas offcanvas-end" tabindex="-1" id="offcanvas_add" style="width: 1000px !important;">
    <div class="offcanvas-header">
        <h5 class="offcanvas-title">Add New Purchase Order</h5>
        <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
    </div>
    <div class="offcanvas-body">
        <form id="addPOForm" method="post" action="{% url 'purchase_order_add' %}">
            {% csrf_token %}
            <div class="row">
                <div class="col-md-3">
                    <div class="form-group">
                        <label>PO Date <span class="text-danger">*</span></label>
                        <input type="date" class="form-control" name="tran_date" required>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="form-group">
                        <label>PO Number <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" name="tran_numb" required>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="form-group">
                        <label>Reference Number</label>
                        <select class="form-select" name="refn_numb">
                            <option value="">Select PR Number</option>
                            {% for pr in pr_items_data %}
                            <option value="{{ pr.ordr_numb }}" data-ordr-numb="{{ pr.ordr_numb }}">{{ pr.ordr_numb }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="form-group">
                        <label>Reference Date</label>
                        <input type="date" class="form-control" name="refn_date">
                    </div>
                </div>
            </div>

            <div class="row mt-3">
                <div class="col-md-3">
                    <div class="form-group">
                        <label>Supplier Code <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" name="supl_code" required>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="form-group">
                        <label>Supplier Name <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" name="supl_name" required>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="form-group">
                        <label>Contact Person</label>
                        <input type="text" class="form-control" name="cont_name">
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="form-group">
                        <label>Mobile Number</label>
                        <input type="text" class="form-control" name="mobl_numb">
                    </div>
                </div>
            </div>

            <div class="row mt-3">
                <div class="col-md-3">
                    <div class="form-group">
                        <label>Telephone</label>
                        <input type="text" class="form-control" name="teln_numb">
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="form-group">
                        <label>Email</label>
                        <input type="email" class="form-control" name="mail_addr">
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="form-group">
                        <label>Remarks</label>
                        <input type="text" class="form-control" name="tran_remk">
                    </div>
                </div>
            </div>

            <div class="row mt-3">
                <div class="col-md-12">
                    <div class="form-group">
                        <label>Address</label>
                        <input type="text" class="form-control" name="supl_add1" placeholder="Address Line 1">
                    </div>
                </div>
            </div>

            <div class="row mt-2">
                <div class="col-md-12">
                    <div class="form-group">
                        <input type="text" class="form-control" name="supl_add2" placeholder="Address Line 2">
                    </div>
                </div>
            </div>

            <div class="row mt-2">
                <div class="col-md-12">
                    <div class="form-group">
                        <input type="text" class="form-control" name="supl_add3" placeholder="Address Line 3">
                    </div>
                </div>
            </div>

            <div class="row mt-4">
                <div class="col-md-12">
                    <h6>Items</h6>
                    <div id="items-container-add"></div>
                    <button type="button" class="btn btn-secondary mt-2" id="add-item-add">
                        <i class="ti ti-plus me-2"></i>Add Item
                    </button>
                </div>
            </div>

            <div class="row mt-4">
                <div class="col-md-3">
                    <div class="form-group">
                        <label>Total Amount</label>
                        <input type="number" step="0.01" class="form-control" name="totl_amnt" readonly>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="form-group">
                        <label>Discount %</label>
                        <input type="number" step="0.01" class="form-control" name="disc_prct">
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="form-group">
                        <label>Discount Amount</label>
                        <input type="number" step="0.01" class="form-control" name="disc_amnt" readonly>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="form-group">
                        <label>Tax %</label>
                        <input type="number" step="0.01" class="form-control" name="taxx_prct">
                    </div>
                </div>
            </div>

            <div class="row mt-3">
                <div class="col-md-3">
                    <div class="form-group">
                        <label>Tax Amount</label>
                        <input type="number" step="0.01" class="form-control" name="taxx_amnt" readonly>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="form-group">
                        <label>LPO Amount</label>
                        <input type="number" step="0.01" class="form-control" name="lpoo_amnt">
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="form-group">
                        <label>Status</label>
                        <select class="form-select" name="stat_code">
                            <option value="ACT">Active</option>
                            <option value="INA">Inactive</option>
                        </select>
                    </div>
                </div>
            </div>

            <div class="text-end mt-4">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="offcanvas">Cancel</button>
                <button type="submit" class="btn btn-primary">Save</button>
            </div>
        </form>
    </div>
</div>

<!-- Edit Purchase Order Modal -->
<div class="offcanvas offcanvas-end" tabindex="-1" id="offcanvas_edit" style="width: 1000px !important;">
    <div class="offcanvas-header">
        <h5 class="offcanvas-title">Edit Purchase Order</h5>
        <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
    </div>
    <div class="offcanvas-body">
        <form id="editPOForm" method="post" action="{% url 'purchase_order_edit' %}">
            {% csrf_token %}
            <input type="hidden" id="po_id" name="po_id">
            <div class="row">
                <div class="col-md-3">
                    <div class="form-group">
                        <label>PO Date <span class="text-danger">*</span></label>
                        <input type="date" class="form-control" id="tran_date" name="tran_date" required>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="form-group">
                        <label>PO Number <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="tran_numb" name="tran_numb" required>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="form-group">
                        <label>Reference Number</label>
                        <select class="form-select" id="refn_numb" name="refn_numb">
                            <option value="">Select PR Number</option>
                            {% for pr in pr_items_data %}
                            <option value="{{ pr.ordr_numb }}" data-ordr-numb="{{ pr.ordr_numb }}">{{ pr.ordr_numb }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="form-group">
                        <label>Reference Date</label>
                        <input type="date" class="form-control" id="refn_date" name="refn_date">
                    </div>
                </div>
            </div>

            <div class="row mt-3">
                <div class="col-md-3">
                    <div class="form-group">
                        <label>Supplier Code <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="supl_code" name="supl_code" required>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="form-group">
                        <label>Supplier Name <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="supl_name" name="supl_name" required>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="form-group">
                        <label>Contact Person</label>
                        <input type="text" class="form-control" id="cont_name" name="cont_name">
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="form-group">
                        <label>Mobile Number</label>
                        <input type="text" class="form-control" id="mobl_numb" name="mobl_numb">
                    </div>
                </div>
            </div>

            <div class="row mt-3">
                <div class="col-md-3">
                    <div class="form-group">
                        <label>Telephone</label>
                        <input type="text" class="form-control" id="teln_numb" name="teln_numb">
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="form-group">
                        <label>Email</label>
                        <input type="email" class="form-control" id="mail_addr" name="mail_addr">
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="form-group">
                        <label>Remarks</label>
                        <input type="text" class="form-control" id="tran_remk" name="tran_remk">
                    </div>
                </div>
            </div>

            <div class="row mt-3">
                <div class="col-md-12">
                    <div class="form-group">
                        <label>Address</label>
                        <input type="text" class="form-control" id="supl_add1" name="supl_add1" placeholder="Address Line 1">
                    </div>
                </div>
            </div>

            <div class="row mt-2">
                <div class="col-md-12">
                    <div class="form-group">
                        <input type="text" class="form-control" id="supl_add2" name="supl_add2" placeholder="Address Line 2">
                    </div>
                </div>
            </div>

            <div class="row mt-2">
                <div class="col-md-12">
                    <div class="form-group">
                        <input type="text" class="form-control" id="supl_add3" name="supl_add3" placeholder="Address Line 3">
                    </div>
                </div>
            </div>

            <div class="row mt-4">
                <div class="col-md-12">
                    <h6>Items</h6>
                    <div id="items-container-edit"></div>
                    <button type="button" class="btn btn-secondary mt-2" id="add-item-edit">
                        <i class="ti ti-plus me-2"></i>Add Item
                    </button>
                </div>
            </div>

            <div class="row mt-4">
                <div class="col-md-3">
                    <div class="form-group">
                        <label>Total Amount</label>
                        <input type="number" step="0.01" class="form-control" id="totl_amnt" name="totl_amnt" readonly>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="form-group">
                        <label>Discount %</label>
                        <input type="number" step="0.01" class="form-control" id="disc_prct" name="disc_prct">
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="form-group">
                        <label>Discount Amount</label>
                        <input type="number" step="0.01" class="form-control" id="disc_amnt" name="disc_amnt" readonly>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="form-group">
                        <label>Tax %</label>
                        <input type="number" step="0.01" class="form-control" id="taxx_prct" name="taxx_prct">
                    </div>
                </div>
            </div>

            <div class="row mt-3">
                <div class="col-md-3">
                    <div class="form-group">
                        <label>Tax Amount</label>
                        <input type="number" step="0.01" class="form-control" id="taxx_amnt" name="taxx_amnt" readonly>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="form-group">
                        <label>LPO Amount</label>
                        <input type="number" step="0.01" class="form-control" id="lpoo_amnt" name="lpoo_amnt">
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="form-group">
                        <label>Status</label>
                        <select class="form-select" id="stat_code" name="stat_code">
                            <option value="ACT">Active</option>
                            <option value="INA">Inactive</option>
                        </select>
                    </div>
                </div>
            </div>

            <div class="text-end mt-4">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="offcanvas">Cancel</button>
                <button type="submit" class="btn btn-primary">Update</button>
            </div>
        </form>
    </div>
</div>

<!-- Delete Purchase Order Modal -->
<div class="modal fade" id="delete_po" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Delete Purchase Order</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete this purchase order?</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirmDelete">Delete</button>
            </div>
        </div>
    </div>
</div>

<script>
    $(document).ready(function () {
        // Handle PR selection
        $("#refn_numb").on("change", function() {
            var selectedOrdrNumb = $(this).find("option:selected").data("ordr-numb");
            if (selectedOrdrNumb) {
                // Clear existing items
                $("#items-tbody-add").empty();
                $("#items-tbody-edit").empty();
                
                // Fetch PR items
                $.ajax({
                    url: "{% url 'get_pr_items' %}",
                    type: "GET",
                    data: { 'ordr_numb': selectedOrdrNumb },
                    success: function(response) {
                        if (response.status === "success") {
                            // Add items from PR
                            response.items.forEach(function(item) {
                                addItemRowAdd(item);
                            });
                            // Recalculate totals
                            calculateTotalAmount();
                        } else {
                            alert(response.message || "Error fetching PR items");
                        }
                    },
                    error: function(xhr, status, error) {
                        alert("Error fetching PR items: " + error);
                    }
                });
            } else {
                // Clear items when no PR is selected
                $("#items-tbody-add").empty();
                $("#items-tbody-edit").empty();
                calculateTotalAmount();
            }
        });
    });
</script> 