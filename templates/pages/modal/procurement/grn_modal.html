<!-- Add GRN Modal -->
<div class="offcanvas offcanvas-end" tabindex="-1" id="offcanvas_add" style="width: 1000px !important;">
    <div class="offcanvas-header">
        <h5 class="offcanvas-title">Add New GRN</h5>
        <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
    </div>
    <div class="offcanvas-body">
        <form id="addGRNForm" action="{% url 'grn_add' %}" method="post">
            {% csrf_token %}
            <div class="row">
                <div class="col-md-6">
                    <div class="form-group">
                        <label>Date</label>
                        <input type="date" class="form-control" name="tran_date" required>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="form-group">
                        <label>GRN Number</label>
                        <input type="text" class="form-control" name="tran_numb" required>
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col-md-6">
                    <div class="form-group">
                        <label>Warehouse</label>
                        <select class="form-control" name="ware_code" required>
                            <option value="">Select Warehouse</option>
                            {% for warehouse in warehouses %}
                            <option value="{{ warehouse.ware_code }}">{{ warehouse.ware_name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="form-group">
                        <label>Supplier</label>
                        <select class="form-control" name="supl_code" required>
                            <option value="">Select Supplier</option>
                            {% for supplier in suppliers %}
                            <option value="{{ supplier.supl_code }}">{{ supplier.supl_name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col-md-6">
                    <div class="form-group">
                        <label>LPO Number</label>
                        <select class="form-control" name="lpoo_numb" id="lpoo_numb" required>
                            <option value="">Select LPO</option>
                            {% for po in pos %}
                            <option value="{{ po.tran_numb }}">{{ po.tran_numb }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="form-group">
                        <label>LPO Date</label>
                        <input type="date" class="form-control" name="lpoo_date" id="lpoo_date" readonly>
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col-md-12">
                    <div class="form-group">
                        <label>Remarks</label>
                        <textarea class="form-control" name="tran_remk" rows="3"></textarea>
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col-md-12">
                    <div class="form-group">
                        <label>Status</label>
                        <select class="form-control" name="stat_code" required>
                            <option value="ACT">Active</option>
                            <option value="INA">Inactive</option>
                        </select>
                    </div>
                </div>
            </div>
            <div class="row mt-3">
                <div class="col-md-12">
                    <div class="form-group">
                        <label>Items</label>
                        <div id="items-container-add"></div>
                    </div>
                </div>
            </div>
            <div class="row mt-3">
                <div class="col-md-12">
                    <button type="submit" class="btn btn-primary">Save</button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="offcanvas">Cancel</button>
                </div>
            </div>
        </form>
    </div>
</div>

<!-- Delete GRN Modal -->
<div class="modal fade" id="delete_grn" tabindex="-1" aria-labelledby="deleteGRNLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteGRNLabel">Delete GRN</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                Are you sure you want to delete this GRN?
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirmDelete">Delete</button>
            </div>
        </div>
    </div>
</div>

<script>
$(document).ready(function() {
    // Create initial table structure for add form
    function createInitialTableAdd() {
        var tableHtml = `
            <table class="table table-bordered">
                <thead>
                    <tr>
                        <th>Item Code</th>
                        <th>Description</th>
                        <th>Unit</th>
                        <th>Quantity</th>
                        <th>In Pieces</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody id="items-tbody-add">
                </tbody>
            </table>
        `;
        $("#items-container-add").html(tableHtml);
    }

    // Add Item Row for add form
    function addItemRowAdd(item) {
        var itemHtml = `
            <tr>
                <td>
                    <input type="text" class="form-control" name="item_code_${item.id || Date.now()}" value="${item.item_code || ''}" readonly>
                </td>
                <td>
                    <input type="text" class="form-control" name="item_desc_${item.id || Date.now()}" value="${item.item_desc || ''}" readonly>
                </td>
                <td>
                    <input type="text" class="form-control" name="item_unit_${item.id || Date.now()}" value="${item.item_unit || ''}" readonly>
                </td>
                <td>
                    <input type="number" step="0.01" class="form-control" name="item_qnty_${item.id || Date.now()}" value="${item.item_qnty || ''}" readonly>
                </td>
                <td>
                    <input type="number" step="0.01" class="form-control item-in-pcs" name="item_in_pcs_${item.id || Date.now()}" value="0" required>
                </td>
                <td>
                    <button type="button" class="btn btn-danger btn-sm remove-item">
                        <i class="ti ti-trash"></i>
                    </button>
                </td>
            </tr>
        `;
        $("#items-tbody-add").append(itemHtml);
    }

    // Initialize tables when document is ready
    createInitialTableAdd();

    // Handle LPO number change for add form
    $("#lpoo_numb").on("change", function() {
        var lpooNumb = $(this).val();
        if (lpooNumb) {
            $.ajax({
                url: "{% url 'get_po_items' %}",
                type: "GET",
                data: { 'lpoo_numb': lpooNumb },
                success: function(response) {
                    if (response.details) {
                        // Clear existing items
                        $("#items-container-add").empty();
                        createInitialTableAdd();
                        
                        // Add items from PO
                        response.details.forEach(function(detail) {
                            // Calculate remaining quantity
                            var remainingQty = detail.item_qnty - (detail.recv_qnty || 0);
                            
                            // Only add items that have remaining quantity
                            if (remainingQty > 0) {
                                addItemRowAdd({
                                    item_code: detail.item_code,
                                    item_desc: detail.item_desc,
                                    item_unit: detail.item_unit,
                                    item_qnty: remainingQty
                                });
                            }
                        });
                    }
                },
                error: function(xhr, status, error) {
                    alert("Error loading PO items: " + error);
                }
            });
        }
    });

    // Validate in pieces input
    $(document).on("input", ".item-in-pcs", function() {
        var row = $(this).closest("tr");
        var quantity = parseFloat(row.find("input[name^='item_qnty_']").val()) || 0;
        var inPieces = parseFloat($(this).val()) || 0;
        
        if (inPieces < 0) {
            alert("In Pieces cannot be negative");
            $(this).val(0);
            return;
        }
        
        if (inPieces > quantity) {
            alert("In Pieces cannot be greater than available quantity");
            $(this).val(quantity);
            return;
        }
    });

    // Form submission for add
    $("#addGRNForm").on("submit", function(e) {
        e.preventDefault();
        
        // Prevent double submission
        if ($(this).data('submitting')) {
            return;
        }
        $(this).data('submitting', true);
        
        // Validate all in pieces values
        var isValid = true;
        var hasItems = false;
        
        $(".item-in-pcs").each(function() {
            var row = $(this).closest("tr");
            var quantity = parseFloat(row.find("input[name^='item_qnty_']").val()) || 0;
            var inPieces = parseFloat($(this).val()) || 0;
            
            if (inPieces > 0) {
                hasItems = true;
            }
            
            if (inPieces < 0) {
                alert("In Pieces cannot be negative");
                isValid = false;
                return false;
            }
            
            if (inPieces > quantity) {
                alert("In Pieces cannot be greater than available quantity");
                isValid = false;
                return false;
            }
        });
        
        if (!hasItems) {
            alert("Please enter In Pieces for at least one item");
            isValid = false;
        }
        
        if (!isValid) {
            $(this).data('submitting', false);
            return;
        }
        
        // Collect all item IDs
        var itemIds = [];
        $("#items-tbody-add tr").each(function() {
            var inputs = $(this).find("input");
            var itemId = inputs.first().attr("name").split("_")[2];
            itemIds.push(itemId);
        });
        
        // Add items array to form data
        var formData = new FormData(this);
        itemIds.forEach(function(itemId) {
            formData.append("items[]", itemId);
        });
    });

    // Remove Item
    $(document).on("click", ".remove-item", function() {
        $(this).closest("tr").remove();
    });
});
</script> 