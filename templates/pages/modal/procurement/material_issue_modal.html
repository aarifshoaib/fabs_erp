<!-- Add Material Issue Modal -->
<div class="offcanvas offcanvas-end" tabindex="-1" id="offcanvas_add" style="width: 1000px !important;">
    <div class="offcanvas-header">
        <h5 class="offcanvas-title">Add New Material Issue</h5>
        <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
    </div>
    <div class="offcanvas-body">
        <form id="addIssueForm" method="post" action="{% url 'material_issue_add' %}">
            {% csrf_token %}
            <div class="row">
                <div class="col-md-3">
                    <div class="form-group">
                        <label>MI Date <span class="text-danger">*</span></label>
                        <input type="date" class="form-control" name="tran_date" required>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="form-group">
                        <label>MR Number <span class="text-danger">*</span></label>
                        <select class="form-select" name="refn_numb" required>
                            <option value="">Select MR</option>
                            {% for mr in material_requests %}
                            <option value="{{ mr.ordr_numb }}" data-date="{{ mr.ordr_date|date:'Y-m-d' }}" data-job="{{ mr.job_code }}">{{ mr.ordr_numb }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="form-group">
                        <label>MR Date</label>
                        <input type="date" class="form-control" name="refn_date" readonly>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="form-group">
                        <label>Job Code</label>
                        <input type="text" class="form-control" name="job_code" readonly>
                    </div>
                </div>
            </div>

            <div class="row mt-3">
                <div class="col-md-3">
                    <div class="form-group">
                        <label>Warehouse Code <span class="text-danger">*</span></label>
                        <select class="form-select" name="ware_code" required>
                            <option value="">Select Warehouse</option>
                            {% for warehouse in warehouses %}
                            <option value="{{ warehouse.ware_code }}">{{ warehouse.ware_code }} - {{ warehouse.ware_name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
            </div>

            <div class="row mt-4">
                <div class="col-md-12">
                    <h6>Items</h6>
                    <div class="table-responsive">
                        <table class="table table-bordered">
                            <thead>
                                <tr>
                                    <th>Item Code</th>
                                    <th>Description</th>
                                    <th>UOM</th>
                                    <th>MR Qty</th>
                                    <th>Issued Qty</th>
                                    <th>Balance</th>
                                    <th>Stock Qty</th>
                                    <th>Issue Qty</th>
                                </tr>
                            </thead>
                            <tbody id="items-tbody">
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div class="text-end mt-4">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="offcanvas">Cancel</button>
                <button type="submit" class="btn btn-primary">Save</button>
            </div>
        </form>
    </div>
</div>

<!-- Delete Material Issue Modal -->
<div class="modal fade" id="delete_issue" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Delete Material Issue</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete this material issue?</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirmDelete">Delete</button>
            </div>
        </div>
    </div>
</div>

<script>
    $(document).ready(function() {
        // Handle MR selection
        $("select[name='refn_numb']").on("change", function() {
            var selectedOption = $(this).find("option:selected");
            var mrDate = selectedOption.data("date");
            var jobCode = selectedOption.data("job");
            var selectedMrNumber = $(this).val();
            
            console.log("Selected MR:", {
                number: selectedMrNumber,
                date: mrDate,
                jobCode: jobCode
            });
            
            $("input[name='refn_date']").val(mrDate);
            $("input[name='job_code']").val(jobCode);
            
            if (selectedMrNumber) {
                // Fetch MR items
                $.ajax({
                    url: "{% url 'get_mr_items' %}",
                    type: "GET",
                    data: { 'ordr_numb': selectedMrNumber },
                    success: function(response) {
                        console.log("MR items response:", response);
                        
                        if (response.status === "success") {
                            $("#items-tbody").empty();
                            
                            if (response.items && response.items.length > 0) {
                                response.items.forEach(function(item) {
                                    console.log("Processing item:", item);
                                    var row = `
                                        <tr>
                                            <td>${item.item_code}</td>
                                            <td>${item.item_desc}</td>
                                            <td>${item.item_unit}</td>
                                            <td>${item.item_qnty}</td>
                                            <td>${item.issued_qty || 0}</td>
                                            <td>${item.balance || item.item_qnty}</td>
                                            <td class="stock-qty">0</td>
                                            <td>
                                                <input type="number" step="0.01" class="form-control issue-qty" 
                                                    name="issue_qty_${item.item_code}" 
                                                    max="${item.balance || item.item_qnty}" 
                                                    min="0"
                                                    data-balance="${item.balance || item.item_qnty}">
                                            </td>
                                        </tr>
                                    `;
                                    $("#items-tbody").append(row);
                                });
                                
                                // If warehouse is already selected, fetch stock quantities
                                var selectedWarehouse = $("select[name='ware_code']").val();
                                if (selectedWarehouse) {
                                    fetchStockQuantities(selectedWarehouse);
                                }
                            } else {
                                console.log("No items found in response");
                                alert("No items found for this Material Request");
                            }
                        } else {
                            console.error("Error in response:", response.message);
                            alert(response.message || "Error fetching MR items");
                        }
                    },
                    error: function(xhr, status, error) {
                        console.error("AJAX error:", {
                            status: status,
                            error: error,
                            response: xhr.responseText
                        });
                        alert("Error fetching MR items: " + error);
                    }
                });
            } else {
                $("input[name='refn_date']").val('');
                $("input[name='job_code']").val('');
                $("#items-tbody").empty();
            }
        });

        // Function to fetch stock quantities
        function fetchStockQuantities(warehouseCode) {
            console.log("Fetching stock quantities for warehouse:", warehouseCode);
            
            // Get all item codes from the table
            var itemCodes = [];
            $("#items-tbody tr").each(function() {
                var itemCode = $(this).find("td:first").text();
                itemCodes.push(itemCode);
            });
            
            if (itemCodes.length === 0) {
                console.log("No items found in table");
                return;
            }
            
            $.ajax({
                url: "{% url 'get_warehouse_stock' %}",
                type: "GET",
                data: { 
                    'ware_code': warehouseCode,
                    'item_codes': itemCodes.join(',')
                },
                success: function(response) {
                    console.log("Stock quantities response:", response);
                    
                    if (response.status === "success") {
                        // First, set all stock quantities to 0
                        $(".stock-qty").text("0");
                        
                        // Then update with actual stock quantities
                        if (response.stocks && response.stocks.length > 0) {
                            response.stocks.forEach(function(stock) {
                                console.log("Processing stock:", stock);
                                var $row = $(`tr:has(td:contains('${stock.item_code}'))`);
                                $row.find(".stock-qty").text(stock.baln_qnty || 0);
                                
                                // Update max value of issue quantity input
                                var $issueQtyInput = $row.find(".issue-qty");
                                var balance = parseFloat($issueQtyInput.data("balance")) || 0;
                                var stockQty = parseFloat(stock.baln_qnty) || 0;
                                var maxQty = Math.min(balance, stockQty);
                                $issueQtyInput.attr("max", maxQty);
                                
                                // If current value exceeds new max, adjust it
                                var currentQty = parseFloat($issueQtyInput.val()) || 0;
                                if (currentQty > maxQty) {
                                    $issueQtyInput.val(maxQty);
                                }
                            });
                        } else {
                            console.log("No stock quantities found");
                        }
                    } else {
                        console.error("Error in response:", response.message);
                        // If error, set all stock quantities to 0
                        $(".stock-qty").text("0");
                        alert(response.message || "Error fetching stock quantities");
                    }
                },
                error: function(xhr, status, error) {
                    console.error("AJAX error:", {
                        status: status,
                        error: error,
                        response: xhr.responseText
                    });
                    // If error, set all stock quantities to 0
                    $(".stock-qty").text("0");
                    alert("Error fetching stock quantities: " + error);
                }
            });
        }

        // Handle warehouse selection
        $("select[name='ware_code']").on("change", function() {
            var warehouseCode = $(this).val();
            console.log("Selected warehouse:", warehouseCode);
            
            if (warehouseCode) {
                fetchStockQuantities(warehouseCode);
            } else {
                // If no warehouse selected, set all stock quantities to 0
                $(".stock-qty").text("0");
            }
        });

        // Handle issue quantity input
        $(document).on("input", ".issue-qty", function() {
            var $input = $(this);
            var issueQty = parseFloat($input.val()) || 0;
            var balance = parseFloat($input.data("balance")) || 0;
            var stockQty = parseFloat($input.closest("tr").find(".stock-qty").text()) || 0;
            var maxQty = Math.min(balance, stockQty);
            
            console.log("Issue quantity input:", {
                issueQty: issueQty,
                balance: balance,
                stockQty: stockQty,
                maxQty: maxQty
            });
            
            if (issueQty > maxQty) {
                $input.val(maxQty);
                alert("Issue quantity cannot exceed the minimum of balance quantity and stock quantity");
            }
        });

        // Form submission
        $("#addIssueForm").on("submit", function(e) {
            e.preventDefault();
            
            // Validate issue quantities
            var isValid = true;
            $("#items-tbody tr").each(function() {
                var $row = $(this);
                var issueQty = parseFloat($row.find(".issue-qty").val()) || 0;
                var balance = parseFloat($row.find(".issue-qty").data("balance")) || 0;
                var stockQty = parseFloat($row.find(".stock-qty").text()) || 0;
                
                if (issueQty > balance) {
                    alert("Issue quantity cannot exceed balance quantity");
                    isValid = false;
                    return false;
                }
                if (issueQty > stockQty) {
                    alert("Issue quantity cannot exceed stock quantity");
                    isValid = false;
                    return false;
                }
            });
            
            if (!isValid) {
                return;
            }
            
            // Submit form
            $.ajax({
                url: $(this).attr("action"),
                type: "POST",
                data: $(this).serialize(),
                success: function(response) {
                    if (response.status === "success") {
                        alert(response.message);
                        location.reload();
                    } else {
                        alert(response.message || "Error saving material issue");
                    }
                },
                error: function(xhr, status, error) {
                    alert("Error saving material issue: " + error);
                }
            });
        });

        // Delete Issue
        $("#confirmDelete").on("click", function() {
            var issueId = $(".delete-btn").data("issue-id");
            console.log("Deleting issue ID:", issueId);
            
            $.ajax({
                url: "{% url 'material_issue_delete' %}",
                type: "POST",
                data: {
                    'issue_id': issueId,
                    'csrfmiddlewaretoken': '{{ csrf_token }}'
                },
                success: function(response) {
                    console.log("Delete response:", response);
                    
                    if (response.status === 'success') {
                        alert(response.message);
                        location.reload();
                    } else {
                        alert(response.message || "Error deleting issue");
                    }
                },
                error: function(xhr, status, error) {
                    console.error("AJAX error:", {
                        status: status,
                        error: error,
                        response: xhr.responseText
                    });
                    alert("Error deleting issue. Please try again.");
                }
            });
            $("#delete_issue").modal("hide");
        });
    });
</script> 