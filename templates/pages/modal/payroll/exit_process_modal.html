{% load static %}

<!-- Exit Process Modal -->
<div class="offcanvas offcanvas-end" tabindex="-1" id="exit_process_modal" style="width: 1200px !important;">
    <div class="offcanvas-header border-bottom">
        <h5 class="offcanvas-title" id="exit_process_modal_title">Exit Process</h5>
        <button type="button" class="btn-close" data-bs-dismiss="offcanvas"></button>
    </div>
    <div class="offcanvas-body">
        <form id="exitProcessForm" method="post" enctype="multipart/form-data" action="{% url 'create_exit_process' %}">
            {% csrf_token %}
            
            <!-- Hidden field for offboarding ID -->
            <input type="hidden" name="offboarding_id" id="offboarding_id_hidden">
            
            <!-- Offboarding Selection -->
            <div class="mb-4">
                <h6>Offboarding Selection</h6>
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label class="col-form-label">Offboarding <span class="text-danger">*</span></label>
                        <select name="offboarding_select" id="offboarding_select" class="form-control">
                            <option value="">Select Offboarding</option>
                            {% for offboarding in offboardings %}
                            <option value="{{ offboarding.offboarding_id }}">{{ offboarding.emp_code }} - {{ offboarding.emp_name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
            </div>

            <!-- Employee Details Display -->
            <div class="mb-4" id="employee_details_section" style="display: none;">
                <h6>Employee Details</h6>
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label class="col-form-label">Employee Code</label>
                        <div class="form-control-plaintext" id="emp_code_display"></div>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="col-form-label">Employee Name</label>
                        <div class="form-control-plaintext" id="emp_name_display"></div>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="col-form-label">Designation</label>
                        <div class="form-control-plaintext" id="designation_display"></div>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="col-form-label">Department</label>
                        <div class="form-control-plaintext" id="department_display"></div>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="col-form-label">Offboarding Type</label>
                        <div class="form-control-plaintext" id="offboarding_type_display"></div>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="col-form-label">Offboarding Date</label>
                        <div class="form-control-plaintext" id="offboarding_date_display"></div>
                    </div>
                </div>
            </div>

            <!-- Existing Exit Process Data (Accordion) -->
            <div class="mb-4" id="existing_data_section" style="display: none;">
                <div class="accordion" id="existingDataAccordion">
                    <div class="accordion-item">
                        <h2 class="accordion-header" id="existingDataHeader">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#existingDataCollapse" aria-expanded="false" aria-controls="existingDataCollapse">
                                <i class="fas fa-history me-2"></i>Existing Exit Process Data
                            </button>
                        </h2>
                        <div id="existingDataCollapse" class="accordion-collapse collapse" aria-labelledby="existingDataHeader" data-bs-parent="#existingDataAccordion">
                            <div class="accordion-body">
                                <!-- Dynamic category tables will be populated here -->
                                <div id="categoryTablesContainer">
                                    <!-- Tables will be generated dynamically -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Exit Process Multi-Entry Section -->
            <div class="mb-4">
                <h6>Exit Process Details</h6>
                <div class="table-responsive">
                    <table class="table" id="exitProcessTable">
                        <thead>
                            <tr>
                                <th>Category</th>
                                <th>Type</th>
                                <th>Date</th>
                                <th>Remarks</th>
                                <th>File Upload</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>
                                    <select name="cancellation_category[]" class="form-control">
                                        <option value="">Select Category</option>
                                        <!-- Categories will be loaded dynamically -->
                                    </select>
                                </td>
                                <td>
                                    <select name="cancellation_type[]" class="form-control">
                                        <option value="">Select Type</option>
                                        <!-- Types will be loaded dynamically -->
                                    </select>
                                </td>
                                <td>
                                    <input type="date" name="cancellation_date[]" class="form-control">
                                </td>
                                <td>
                                    <input type="text" name="remarks[]" class="form-control" placeholder="Enter remarks">
                                </td>
                                <td>
                                    <input type="file" name="file_path[]" class="form-control" accept="application/pdf,image/*">
                                    <div class="file-preview"></div>
                                </td>
                                <td>
                                    <button type="button" class="btn btn-danger btn-sm" onclick="removeExitProcessRow(this)">
                                        <i class="fas fa-times"></i>
                                    </button>
                                    <button type="button" class="btn btn-primary btn-sm" onclick="addExitProcessRow()">
                                        <i class="fas fa-plus"></i>
                                    </button>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Form Actions -->
            <div class="d-flex justify-content-end gap-2">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="offcanvas">Cancel</button>
                <button type="submit" class="btn btn-primary" id="submit_btn">Save</button>
            </div>
        </form>
    </div>
</div>

<script>
// Function to add new row to exit process table
function addExitProcessRow() {
    const tableBody = document.querySelector('#exitProcessTable tbody');
    const newRow = document.createElement('tr');
    newRow.innerHTML = `
        <td>
            <select name="cancellation_category[]" class="form-control">
                <option value="">Select Category</option>
                <!-- Categories will be loaded dynamically -->
            </select>
        </td>
        <td>
            <select name="cancellation_type[]" class="form-control">
                <option value="">Select Type</option>
                <!-- Types will be loaded dynamically -->
            </select>
        </td>
        <td>
            <input type="date" name="cancellation_date[]" class="form-control">
        </td>
        <td>
            <input type="text" name="remarks[]" class="form-control" placeholder="Enter remarks">
        </td>
        <td>
            <input type="file" name="file_path[]" class="form-control" accept="application/pdf,image/*">
            <div class="file-preview"></div>
        </td>
        <td>
            <button type="button" class="btn btn-danger btn-sm" onclick="removeExitProcessRow(this)">
                <i class="fas fa-times"></i>
            </button>
            <button type="button" class="btn btn-primary btn-sm" onclick="addExitProcessRow()">
                <i class="fas fa-plus"></i>
            </button>
        </td>
    `;
    tableBody.appendChild(newRow);
    
    // Populate the new row with categories and types
    populateDropdowns(newRow);
}

// Function to remove row from exit process table
function removeExitProcessRow(button) {
    const row = button.closest('tr');
    const tableBody = document.querySelector('#exitProcessTable tbody');
    
    if (tableBody.rows.length > 1) {
        row.remove();
    } else {
        alert("At least one row must remain.");
    }
}

// Function to handle offboarding selection change
function handleOffboardingSelection() {
    const offboardingSelect = document.getElementById('offboarding_select');
    const employeeDetailsSection = document.getElementById('employee_details_section');
    
    if (offboardingSelect.value) {
        // Set the hidden field value
        document.getElementById('offboarding_id_hidden').value = offboardingSelect.value;
        
        // Fetch offboarding details
        fetch(`/get_employee_offboarding_details/?offboarding_id=${offboardingSelect.value}`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Populate employee details
                    document.getElementById('emp_code_display').textContent = data.employee.emp_code;
                    document.getElementById('emp_name_display').textContent = data.employee.emp_name;
                    document.getElementById('designation_display').textContent = data.employee.designation;
                    document.getElementById('department_display').textContent = data.employee.department;
                    document.getElementById('offboarding_type_display').textContent = data.offboarding.offboarding_type;
                    document.getElementById('offboarding_date_display').textContent = data.offboarding.offboarding_date;
                    
                    // Show employee details section
                    employeeDetailsSection.style.display = 'block';
                } else {
                    alert('Failed to fetch offboarding details');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error fetching offboarding details');
            });
    } else {
        // Clear hidden field
        document.getElementById('offboarding_id_hidden').value = '';
        // Hide employee details section
        employeeDetailsSection.style.display = 'none';
    }
}

// Function to handle form submission
function handleExitProcessSubmit(event) {
    // Remove this function - we'll use direct form submission
    return true;
}

// Function to view exit process details
function viewExitProcess(exitProcessId) {
    fetch(`/get_exit_process_details/?exit_process_id=${exitProcessId}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Populate employee details
                document.getElementById('emp_code_display').textContent = data.data.emp_code;
                document.getElementById('emp_name_display').textContent = data.data.emp_name;
                document.getElementById('designation_display').textContent = data.data.designation;
                document.getElementById('department_display').textContent = data.data.department;
                document.getElementById('offboarding_type_display').textContent = data.data.offboarding_type;
                document.getElementById('offboarding_date_display').textContent = data.data.offboarding_date;
                
                // Populate exit process details
                const tableBody = document.querySelector('#exitProcessTable tbody');
                tableBody.innerHTML = '';
                
                data.data.exit_process_details.forEach(detail => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${detail.cancellation_category}</td>
                        <td>${detail.cancellation_type}</td>
                        <td>${detail.cancellation_date}</td>
                        <td>${detail.remarks || '-'}</td>
                        <td>
                            ${detail.file_path ? 
                                `<a href="${detail.file_path}" target="_blank" class="btn btn-sm btn-primary">
                                    <i class="fas fa-eye"></i> View
                                </a>` : 
                                'No file'
                            }
                        </td>
                    `;
                    tableBody.appendChild(row);
                });
                
                // Show the view modal
                const modal = bootstrap.Offcanvas.getInstance(document.getElementById('exit_process_modal'));
                modal.show();
            } else {
                alert(data.message || 'Failed to fetch exit process details');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error fetching exit process details');
        });
}

// Event listeners
document.addEventListener('DOMContentLoaded', function() {
    // Offboarding selection change
    const offboardingSelect = document.getElementById('offboarding_select');
    if (offboardingSelect) {
        offboardingSelect.addEventListener('change', handleOffboardingSelection);
    }
    
    // Remove form submission event listener - using direct form submission
    
    // File preview functionality
    document.addEventListener('change', function(e) {
        if (e.target.type === 'file' && e.target.name === 'file_path[]') {
            const file = e.target.files[0];
            const preview = e.target.parentNode.querySelector('.file-preview');
            
            if (file) {
                preview.innerHTML = `
                    <small class="text-muted">${file.name}</small>
                `;
            } else {
                preview.innerHTML = '';
            }
        }
    });
    
    // Load cancellation data when page loads
    loadCancellationData();
});

// Function to open add exit process modal
function openAddExitProcessModal() {
    // Reset form
    document.getElementById('exitProcessForm').reset();
    document.getElementById('employee_details_section').style.display = 'none';
    
    // Reset table to one row
    const tableBody = document.querySelector('#exitProcessTable tbody');
    tableBody.innerHTML = `
        <tr>
            <td>
                <select name="cancellation_category[]" class="form-control">
                    <option value="">Select Category</option>
                    <!-- Categories will be loaded dynamically -->
                </select>
            </td>
            <td>
                <select name="cancellation_type[]" class="form-control">
                    <option value="">Select Type</option>
                    <!-- Types will be loaded dynamically -->
                </select>
            </td>
            <td>
                <input type="date" name="cancellation_date[]" class="form-control">
            </td>
            <td>
                <input type="text" name="remarks[]" class="form-control" placeholder="Enter remarks">
            </td>
            <td>
                <input type="file" name="file_path[]" class="form-control" accept="application/pdf,image/*">
                <div class="file-preview"></div>
            </td>
            <td>
                <button type="button" class="btn btn-danger btn-sm" onclick="removeExitProcessRow(this)">
                    <i class="fas fa-times"></i>
                </button>
                <button type="button" class="btn btn-primary btn-sm" onclick="addExitProcessRow()">
                    <i class="fas fa-plus"></i>
                </button>
            </td>
        </tr>
    `;
    
    // Populate dropdowns after creating the row
    populateAllDropdowns();
    
    // Update modal title
    document.getElementById('exit_process_modal_title').textContent = 'Add Exit Process';
    
    // Show modal
    const modal = new bootstrap.Offcanvas(document.getElementById('exit_process_modal'));
    modal.show();
}

// Function to load and populate cancellation categories and types
function loadCancellationData() {
    // Load categories
    fetch('/get_cancellation_categories/')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                window.cancellationCategories = data.categories;
                populateAllDropdowns();
            }
        })
        .catch(error => {
            console.error('Error loading categories:', error);
        });
    
    // Types will be loaded dynamically based on category selection
}

// Function to populate dropdowns in a specific row
function populateDropdowns(row) {
    const categorySelect = row.querySelector('select[name="cancellation_category[]"]');
    const typeSelect = row.querySelector('select[name="cancellation_type[]"]');
    
    // Populate categories
    if (window.cancellationCategories) {
        categorySelect.innerHTML = '<option value="">Select Category</option>';
        window.cancellationCategories.forEach(category => {
            const option = document.createElement('option');
            option.value = category.base_value;
            option.textContent = category.base_description;
            categorySelect.appendChild(option);
        });
    }
    
    // Add event listener for category change
    categorySelect.addEventListener('change', function() {
        const selectedCategory = this.value;
        if (selectedCategory) {
            loadSubCategoriesForType(typeSelect, selectedCategory);
        } else {
            typeSelect.innerHTML = '<option value="">Select Type</option>';
        }
    });
}

// Function to load sub-categories for type dropdown
function loadSubCategoriesForType(typeSelect, categoryCode) {
    fetch(`/get_sub_cancellation_categories/?parent_code=${categoryCode}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                typeSelect.innerHTML = '<option value="">Select Type</option>';
                data.sub_categories.forEach(subCategory => {
                    const option = document.createElement('option');
                    option.value = subCategory.base_value;
                    option.textContent = subCategory.base_description;
                    typeSelect.appendChild(option);
                });
            } else {
                typeSelect.innerHTML = '<option value="">No types available</option>';
            }
        })
        .catch(error => {
            console.error('Error loading sub-categories:', error);
            typeSelect.innerHTML = '<option value="">Error loading types</option>';
        });
}

// Function to populate all dropdowns in the table
function populateAllDropdowns() {
    const rows = document.querySelectorAll('#exitProcessTable tbody tr');
    rows.forEach(row => {
        populateDropdowns(row);
    });
}
</script>