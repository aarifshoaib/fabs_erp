{% load static %}

<!-- Add Employee Offcanvas -->
<div class="offcanvas offcanvas-end " tabindex="-1" id="offcanvas_add">
    <div class="offcanvas-header border-bottom">
        <h4 id = 'form-head'>Employee Form</h4>
        <button type="button"
            class="btn-close custom-btn-close border p-1 me-0 d-flex align-items-center justify-content-center rounded-circle"
            data-bs-dismiss="offcanvas" aria-label="Close">
            <i class="ti ti-x"></i>
        </button>
    </div>
    <div class="offcanvas-body">
        <form id="addEmployeeForm" method="post" action="{% url 'create_employee' %}" enctype="multipart/form-data" class="needs-validation" novalidate onsubmit="return validateForm()">
            {% csrf_token %}

            <!-- Collapsible Sections -->
            <div class="accordion" id="employeeAccordion_add" style="width: 1350px;">

                                <!-- Personal Details -->
                <div class="accordion-item">
                    <h2 class="accordion-header" id="headingPersonalDetails_add">
                        <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#collapsePersonalDetails_add" aria-expanded="true" aria-controls="collapsePersonalDetails_add">
                            Employee Details
                        </button>
                    </h2>
                    <div id="collapsePersonalDetails_add" class="accordion-collapse collapse show" aria-labelledby="headingPersonalDetails_add" data-bs-parent="#employeeAccordion_add">
                        <div class="accordion-body">
                            <input type="hidden" id="emp_id" name="emp_id">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="col-form-label" id="profile_picture_label">Profile Picture</label>
                                        <input type="file" name="profile_picture" id="profile_picture" class="form-control" accept="image/*">
                                        <div id="profile_picture_preview" class="mt-2"></div>
                                        <div class="invalid-feedback">Please upload a profile picture.</div>
                                        <small class="form-text text-muted">Maximum file size: 5MB</small>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="col-form-label" id="emp_code_label">Employee Code </label>
                                        <input type="text" name="emp_code" id="emp_code" class="form-control" readonly>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="mb-3">
                                        <label class="col-form-label" id="emp_name_passport_label">Employee Name (As per Passport) <span class="text-danger">*</span></label>
                                        <input type="text" name="emp_name_passport" id="emp_name_passport" class="form-control" required>
                                        <div class="invalid-feedback">Please provide the employee's name as per passport.</div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="mb-3">
                                        <label class="col-form-label" id="surname_label">Surname <span class="text-danger">*</span></label>
                                        <input type="text" name="surname" id="surname" class="form-control" required>
                                        <div class="invalid-feedback">Please provide a surname.</div>
                                    </div>
                                </div>
                                <div class="col-md-2">
                                    <div class="mb-3">
                                        <label class="col-form-label" id="emp_name_label">Employee status<span class="text-danger">*</span></label>
                                        <select name="emp_status" id="emp_status" class="form-select">
                                            <option value="">Select</option>
                                            {% for statuses in status_data %}
                                                <option value="{{ statuses.base_value }}">{{ statuses.base_description }}</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                </div>
                                <div class="col-md-2">
                                    <div class="mb-3">
                                        <label class="col-form-label" id="emp_name_label">Reason<span class="text-danger">*</span></label>
                                        <select name="emp_reason" id="emp_reason" class="form-select">
                                            <option value="">Select</option>
                                            {% for statuses in pass_data %}
                                                <option value="{{ statuses.base_value }}">{{ statuses.base_description }}</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="col-form-label" id="dob_label">Date of Birth <span class="text-danger">*</span></label>
                                        <input type="date" name="dob" id="dob" class="form-control" required>
                                        <div class="invalid-feedback">Please provide a date of birth.</div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="col-form-label" id="emp_sex_label">Gender <span class="text-danger">*</span></label>
                                        <select name="emp_sex" id="emp_sex" class="form-select" required>
                                            <option value="">Select</option>
                                            {% for gender in gender_data %}
                                                <option value="{{ gender.base_value }}">{{ gender.base_description }}</option>
                                            {% endfor %}
                                        </select>
                                        <div class="invalid-feedback">Please select a gender.</div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="col-form-label" id="nationality_label">Nationality<span class="text-danger">*</span></label>
                                        <select name="nationality" id="nationality" class="form-select" required>
                                            <option value="">Select</option>
                                            {% for nation in nationality_data %}
                                            <option value="{{ nation.base_value }}">{{ nation.base_description }}</option>
                                            {% endfor %}
                                        </select>
                                        <div class="invalid-feedback">Please select a Nationality</div>
                                    </div>
                                </div>
                                <!-- Designation (Dropdown) -->
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="col-form-label" id="designation_label">Designation <span class="text-danger">*</span> </label>
                                        <select name="designation" id="designation" class="form-control" required>
                                            <option value="">Select</option>
                                            {% for statuses in desig_data %}
                                                <option value="{{ statuses.base_value }}">{{ statuses.base_description }}</option>
                                            {% endfor %}
                                        </select>
                                        <div class="invalid-feedback">Please select a designation.</div>
                                    </div>
                                </div>
                                <!-- Date of Join -->
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="col-form-label" id="date_of_join_label">Date of Join <span class="text-danger">*</span> </label>
                                        <input type="date" name="date_of_join" id="date_of_join" class="form-control" required>
                                        <div class="invalid-feedback">Please Select Date of Join</div>
                                    </div>
                                </div>

                                <!-- Date of Rejoin -->
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="col-form-label" id="date_of_rejoin_label">Date of Rejoin</label>
                                        <input type="date" name="date_of_rejoin" id="date_of_rejoin" class="form-control">
                                    </div>
                                </div>
                                <!-- Qualification before Marital Status -->
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="col-form-label" id="qualification_label">Qualification</label>
                                        <input type="text" name="qualification" id="qualification" class="form-control">
                                    </div>
                                </div>
                                <!-- Marital Status moved after Qualification -->
                                <div class="col-md-6">
                    <div class="mb-3">
                        <label class="col-form-label" id="emp_marital_status_label">Marital Status</label>
                        <select name="emp_marital_status" id="emp_marital_status" class="form-select">
                            <option value="">Select</option>
                            {% for status in mar_status_data %}
                            <option value="{{ status.base_value }}">
                                {{ status.base_description }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="col-form-label" id="spouse_name_label">Spouse Name</label>
                                        <input type="text" name="spouse_name" id="spouse_name" class="form-control">
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="col-form-label" id="father_name_label">Father Name</label>
                                        <input type="text" name="father_name" id="father_name" class="form-control">
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="col-form-label" id="mother_name_label">Mother Name</label>
                                        <input type="text" name="mother_name" id="mother_name" class="form-control">
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="col-form-label" id="religion_label">Religion</label>
                                        <input type="text" name="religion" id="religion" class="form-control">
                                    </div>
                                </div>        
                                <!-- Status and Sub Status (Same Line) -->
                                <!-- <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="col-form-label">Status <span class="text-danger">*</span></label>
                                        <select name="emp_status" class="form-select" required>
                                            <option value="">Select</option>
                                            {% for statuses in status_data %}
                                                <option value="{{ statuses.base_value }}">{{ statuses.base_description }}</option>
                                            {% endfor %}
                                        </select>
                                        <div class="invalid-feedback">Please select a status.</div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="col-form-label">Sub Status</label>
                                        <select name="emp_sub_status" class="form-select">
                                            <option value="">Select</option>
                                            {% for sub in sub_status_data %}
                                                <option value="{{ sub.base_value }}">{{ sub.base_description }}</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                </div> -->

                                <!-- passport Release and Reason (Next Line) -->
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="col-form-label" id="passport_release_label">Passport Control</label>
                                        <select name="passport_release" id="passport_release" class="form-select">
                                            <option value="">Select</option>
                                            <option value="Yes">Yes</option>
                                            <option value="No">No</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="col-form-label" id="release_reason_label">Release Reason</label>
                                        <select name="release_reason" id="release_reason" class="form-select">
                                            <option value="">Select</option>
                                            {% for status in pass_data %}
                                            <option value="{{ status.base_value }}">
                                                {{ status.base_description }}
                                            </option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                </div>                        

                                <!-- Department (Dropdown) -->
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="col-form-label" id="department_label">Department <span class="text-danger">*</span> </label>
                                        <select name="department" id="department" class="form-control" required>
                                            <option value="">Select</option>
                                            {% for statuses in dept_data %}
                                                <option value="{{ statuses.base_value }}">{{ statuses.base_description }}</option>
                                            {% endfor %}
                                        </select>
                                        <div class="invalid-feedback">Please select a department.</div>
                                    </div>
                                </div>

                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="col-form-label" id="staff_category_label">Category <span class="text-danger">*</span></label>
                                        <select name="staff_category" id="staff_category" class="form-select" required>
                                            <option value="">Select</option>
                                            {% for statuses in staff_category_data %}
                                                <option value="{{ statuses.base_value }}">{{ statuses.base_description }}</option>
                                            {% endfor %}
                                        </select>
                                        <div class="invalid-feedback">Please select a category.</div>
                                    </div>
                                </div>
                                
                                <!-- Dependent Count -->
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="col-form-label" id="depend_count_label">Dependent Count</label>
                                        <input type="number" name="depend_count" id="depend_count" class="form-control" min="0">
                                    </div>
                                </div>
                                
                                <!-- Child Count -->
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="col-form-label" id="child_count_label">Child Count</label>
                                        <input type="number" name="child_count" id="child_count" class="form-control" min="0">
                                    </div>
                                </div>
                                
                                <script>
                                document.addEventListener('DOMContentLoaded', function() {
                                    const categorySelect = document.getElementById('staff_category');
                                    const dependCount = document.getElementById('depend_count');
                                    const childCount = document.getElementById('child_count');
                                
                                    categorySelect.addEventListener('change', function() {
                                        if (this.value === 'FIELD_STAFF') {
                                            // Disable both fields for field-staff
                                            dependCount.disabled = true;
                                            childCount.disabled = true;
                                            
                                            // Clear any existing values
                                            dependCount.value = '';
                                            childCount.value = '';
                                        } else {
                                            // Enable fields for other categories
                                            dependCount.disabled = false;
                                            childCount.disabled = false;
                                        }
                                    });
                                
                                    // Initialize state on page load
                                    if (categorySelect.value === 'FIELD_STAFF') {
                                        dependCount.disabled = true;
                                        childCount.disabled = true;
                                    }

                                    // Passport Control and Release Reason functionality
                                    const passportRelease = document.getElementById('passport_release');
                                    const releaseReason = document.getElementById('release_reason');
                                
                                    passportRelease.addEventListener('change', function() {
                                        if (this.value === 'No') {
                                            // Enable release reason when passport control is Yes
                                            releaseReason.disabled = false;
                                        } else {
                                            // Disable and clear release reason when passport control is No or empty
                                            releaseReason.disabled = true;
                                            releaseReason.value = '';
                                        }
                                    });
                                
                                    // Initialize passport control state on page load
                                    if (passportRelease.value !== 'Yes') {
                                        releaseReason.disabled = true;
                                    }
                                });
                                </script>

                                <!-- <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="col-form-label">Height (cm)</label>
                                        <input type="number" name="height" class="form-control">
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="col-form-label">Weight (kg)</label>
                                        <input type="number" name="weight" class="form-control">
                                    </div>
                                </div> -->
                                <!-- <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="col-form-label">Family Status</label>
                                        <input type="text" name="family_status" class="form-control">
                                    </div>
                                </div> -->
                            </div>
                        </div>
                    </div>
                </div>

                                <!-- Contact Information -->
                <div class="accordion-item">
                    <h2 class="accordion-header" id="headingContactInfo_add">
                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                            data-bs-target="#collapseContactInfo_add" aria-expanded="false" aria-controls="collapseContactInfo_add">
                            Contact Information
                        </button>
                    </h2>
                    <div id="collapseContactInfo_add" class="accordion-collapse collapse" aria-labelledby="headingContactInfo_add"
                        data-bs-parent="#employeeAccordion_add">
                        <div class="accordion-body">
                            <div class="shadow p-4 rounded bg-light">
                                <div class="row">
                                    
                                    <!-- Left Side: Residential Address -->
                                    <div class="col-md-6">
                                        <h5 class="mt-3">Permanent Address</h5>
                                        <div class="mb-3">
                                            <label class="col-form-label">Address Line 1 <span class="text-danger">*</span></label>
                                            <input type="text" name="res_addr_line1" id="res_addr_line1" class="form-control" required>
                                            <div class="invalid-feedback">Please provide an address line 1.</div>
                                        </div>
                                        <div class="mb-3">
                                            <label class="col-form-label">Address Line 2</label>
                                            <input type="text" name="res_addr_line2" id="res_addr_line2" class="form-control">
                                        </div>
                                        <div class="mb-3">
                                            <label class="col-form-label">City <span class="text-danger">*</span></label>
                                            <input type="text" name="res_city" id="res_city" class="form-control" required>
                                            <div class="invalid-feedback">Please provide a city.</div>
                                        </div>
                                        <div class="mb-3">
                                            <label class="col-form-label">State <span class="text-danger">*</span></label>
                                            <input type="text" name="res_state" id="res_state" class="form-control" required>
                                            <div class="invalid-feedback">Please provide a state.</div>
                                        </div>
                                        <div class="mb-3">
                                            <label class="col-form-label">Country Code</label>
                                            <input type="text" name="res_country_code" id="res_country_code" class="form-control">
                                        </div>
                                        <div class="mb-3">
                                            <label class="col-form-label">Phone Number</label>
                                            <input type="text" name="res_phone_no" id="res_phone_no" class="form-control">
                                        </div>
                                    </div>

                                    <!-- Right Side: Local Residence -->
                                    <div class="col-md-6">
                                        <h5 class="mt-3">UAE Address</h5>
                                        <div class="mb-3">
                                            <label class="col-form-label">Address Line 1</label>
                                            <input type="text" name="local_addr_line1" id="local_addr_line1" class="form-control">
                                        </div>
                                        <div class="mb-3">
                                            <label class="col-form-label">Address Line 2</label>
                                            <input type="text" name="local_addr_line2" id="local_addr_line2" class="form-control">
                                        </div>
                                        <div class="mb-3">
                                            <label class="col-form-label">City </label>
                                            <input type="text" name="local_city" id="local_city" class="form-control" >
                                            
                                        </div>
                                        <div class="mb-3">
                                            <label class="col-form-label">State </label>
                                            <input type="text" name="local_state" id="local_state" class="form-control" >
                                            
                                        </div>
                                        <div class="mb-3">
                                            <label class="col-form-label">Country Code </label>
                                            <input type="text" name="local_country_code" id="local_country_code" class="form-control" >
                                            
                                        </div>
                                        <div class="mb-3">
                                            <label class="col-form-label">Phone Number </label>
                                            <input type="text" name="local_phone_no" id="local_phone_no" class="form-control">
                                        </div>
                                    </div>

                                </div>
                            </div>
                        </div>
                    </div>
                </div>


                <!-- Payment Details -->
                {% if request.session.user_salary == "Yes" %}
                <div class="accordion-item">
    <h2 class="accordion-header" id="headingPaymentDetails_add">
        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" 
            data-bs-target="#collapsePaymentDetails_add" aria-expanded="false" aria-controls="collapsePaymentDetails_add">
            Salary Details
        </button>
    </h2>
    <div id="collapsePaymentDetails_add" class="accordion-collapse collapse" aria-labelledby="headingPaymentDetails_add"
        data-bs-parent="#employeeAccordion_add">
        <div class="accordion-body">
            <div class="row">
                <!-- Existing Fields -->
                <div class="col-md-6">
                    <div class="mb-3">
                        <label class="col-form-label">Process Cycle</label>
                        <select name="process_cycle" id="process_cycle" class="form-control">
                            <option value="">Select</option>
                            {% for paycycle in paycycle_data %}
                                <option value="{{ paycycle.base_value }}">{{ paycycle.base_value }}-{{ paycycle.base_description }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>

                <div class="col-md-6">
                    <div class="mb-3">
                        <label class="col-form-label">Basic Pay <span class="text-danger">*</span></label>
                        <input type="number" name="basic_pay" id="basic_pay" class="form-control" required min="0" step="0.01">
                        <div class="invalid-feedback">Please enter a valid basic pay amount (greater than or equal to 0).</div>
                    </div>
                </div>

                <!-- <div class="col-md-6">
                    <div class="mb-3">
                        <label class="col-form-label">Allowance <span class="text-danger">*</span></label>
                        <input type="number" name="allowance" class="form-control" required min="0" step="0.01" id="allowance">
                        <div class="invalid-feedback">Please enter a valid allowance amount (greater than or equal to 0).</div>
                    </div>
                </div> -->

                <div class="col-md-6">
                    <div class="mb-3">
                        <label class="col-form-label">Grade</label>
                        <select name="grade_code" id="grade_code" class="form-control">
                            <option value="">Select</option>
                            {% for statuses in grade_code_data %}
                                <option value="{{ statuses.grade_code }}">{{ statuses.grade_code }} - {{ statuses.grade_desc }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>

                <div class="col-md-6">
                    <div class="mb-3">
                        <label class="col-form-label">Select Job </label>
                        <select name="prj_code" id="prj_code" class="form-control">
                            <option value="">Select</option>
                            {% for statuses in project_data %}
                                <option value="{{ statuses.prj_code }}">{{ statuses.prj_code }} - {{ statuses.prj_name }}</option>
                            {% endfor %}
                        </select>
                        <!-- <div class="invalid-feedback">Please select a Job.</div> -->
                    </div>
                </div>
                
                <div class="col-md-6">
                    <div class="mb-3">
                        <label class="col-form-label">Job Sub Location</label>
                        <select name="sub_location" id="sub_location" class="form-control">
                            <option value="">Select</option>
                            {% for statuses in pro_sub_location_data %}
                                <option value="{{ statuses.base_value }}">{{ statuses.base_description }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="mb-3">
                        <label class="col-form-label">Contract Notice Period</label>
                        <input type="number" name="contract_notice_period" id="contract_notice_period" class="form-control" min="0" step="0.01">
                    </div>
                </div>
            <!-- Multi Entry Section -->
            <div class="mt-4">
                <h5>Additional Earnings/Deductions</h5>
                <table class="table" id="multiEntryTable_add">
                    <thead>
                        <tr>
                            <th>Type</th>
                            <th>Code</th>
                            <th>Amount</th>
                            <th>Prorated Flag</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>
                                <select name="entry_type[]" class="form-control entry-type" >
                                    <option value="">Select Type</option>
                                    <option value="EARNINGS">Earnings</option>
                                    <option value="DEDUCTION">Deduction</option>
                                </select>
                            </td>
                            <td>
                                <select name="entry_code[]" class="form-control code-dropdown" >
                                    <option value="">Select Code</option>
                                    <!-- Options will be populated dynamically -->
                                </select>
                            </td>
                            <td>
                                <input type="number" name="entry_amount[]" class="form-control" min="0" step="0.01">
                            </td>
                            <td>
                                <select name="entry_proated_flag[]" class="form-control">
                                    <option value="Yes">Yes</option>
                                    <option value="No">No</option>
                                </select>
                            </td>
                            <td>
                                <button type="button" class="btn btn-danger remove-entry">Remove</button>
                            </td>
                        </tr>
                    </tbody>
                </table>
                <button type="button" class="btn btn-primary" id="addEntry_add">Add Entry</button>
            </div>
            <!-- Salary Summary Fields -->
            <div class="col-md-12">
                <div class="card bg-light">
                    <div class="card-body">
                        <h6 class="card-title">Salary Summary</h6>
                        <div class="row">
                            <div class="col-md-3">
                                <div class="mb-3">
                                    <label class="col-form-label fw-bold">Basic Pay:</label>
                                    <div class="form-control-plaintext" id="display_basic_pay">0.00</div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="mb-3">
                                    <label class="col-form-label fw-bold">Total Earnings:</label>
                                    <div class="form-control-plaintext text-success" id="total_earnings">0.00</div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="mb-3">
                                    <label class="col-form-label fw-bold">Total Deductions:</label>
                                    <div class="form-control-plaintext text-danger" id="total_deductions">0.00</div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="mb-3">
                                    <label class="col-form-label fw-bold">Total Salary:</label>
                                    <div class="form-control-plaintext text-primary fw-bold" id="total_salary">0.00</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div>
        </div>
    </div>
    {% endif %}

<script>
    document.getElementById('addEntry_add').addEventListener('click', function() {
    const tableBody = document.querySelector('#multiEntryTable_add tbody');
    const newRow = document.createElement('tr');
    newRow.innerHTML = `
        <td>
            <select name="entry_type[]" class="form-control entry-type" required>
                <option value="">Select Type</option>
                <option value="EARNINGS">Earnings</option>
                <option value="DEDUCTION">Deduction</option>
            </select>
        </td>
        <td>
            <select name="entry_code[]" class="form-control code-dropdown" required>
                <option value="">Select Code</option>
                <!-- Options will be populated dynamically -->
            </select>
        </td>
        <td>
            <input type="number" name="entry_amount[]" class="form-control" required min="0" step="0.01">
        </td>
        <td>
            <select name="entry_proated_flag[]" class="form-control">
                <option value="Yes">Yes</option>
                <option value="No">No</option>
            </select>
        </td>
        <td><button type="button" class="btn btn-danger remove-entry">Remove</button></td>
    `;
    tableBody.appendChild(newRow);
});

// Event delegation for dynamically added rows
document.querySelector('#multiEntryTable_add').addEventListener('change', function(e) {
    if (e.target.classList.contains('entry-type')) {
        const selectedType = e.target.value;
        const codeDropdown = e.target.closest('tr').querySelector('.code-dropdown');

        // Clear previous options
        codeDropdown.innerHTML = '<option value="">Select Code</option>';

        if (selectedType) {
            fetch(`/fetch_codes?type=${selectedType}`)
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        data.codes.forEach(code => {
                            const option = document.createElement('option');
                            option.value = code[0]; // Assuming base_value is the first element
                            option.textContent = code[1]; // Assuming base_description is the second element
                            codeDropdown.appendChild(option);
                        });
                    }
                })
                .catch(error => console.error('Error fetching codes:', error));
        }
    }
});

document.querySelector('#multiEntryTable_add').addEventListener('click', function(e) {
    if (e.target.classList.contains('remove-entry')) {
        e.target.closest('tr').remove();
        calculateSalaryTotals(); // Recalculate totals when row is removed
    }
});

// Function to calculate salary totals
function calculateSalaryTotals() {
    let basicPay = parseFloat(document.getElementById('basic_pay').value) || 0;
    let totalEarnings = 0;
    let totalDeductions = 0;

    // Calculate earnings and deductions from the multi-entry table
    const rows = document.querySelectorAll('#multiEntryTable_add tbody tr');
    rows.forEach(row => {
        const typeSelect = row.querySelector('select[name="entry_type[]"]');
        const amountInput = row.querySelector('input[name="entry_amount[]"]');
        
        if (typeSelect && amountInput) {
            const type = typeSelect.value;
            const amount = parseFloat(amountInput.value) || 0;
            
            if (type === 'EARNINGS') {
                totalEarnings += amount;
            } else if (type === 'DEDUCTION') {
                totalDeductions += amount;
            }
        }
    });

    // Calculate total salary
    const totalSalary = basicPay + totalEarnings - totalDeductions;

    // Update display fields
    document.getElementById('display_basic_pay').textContent = basicPay.toFixed(2);
    document.getElementById('total_earnings').textContent = totalEarnings.toFixed(2);
    document.getElementById('total_deductions').textContent = totalDeductions.toFixed(2);
    document.getElementById('total_salary').textContent = totalSalary.toFixed(2);
}

// Add event listeners for basic pay and multi-entry table changes
document.addEventListener('DOMContentLoaded', function() {
    // Listen for basic pay changes
    const basicPayInput = document.getElementById('basic_pay');
    if (basicPayInput) {
        basicPayInput.addEventListener('input', calculateSalaryTotals);
    }

    // Listen for changes in the multi-entry table
    document.addEventListener('input', function(e) {
        if (e.target.matches('#multiEntryTable_add input[name="entry_amount[]"]')) {
            calculateSalaryTotals();
        }
    });

    document.addEventListener('change', function(e) {
        if (e.target.matches('#multiEntryTable_add select[name="entry_type[]"]')) {
            calculateSalaryTotals();
        }
    });

    // Initial calculation
    calculateSalaryTotals();
});
</script>
                <!-- Account Details -->
<div class="accordion-item">
    <h2 class="accordion-header" id="headingAccountDetails_add">
        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseAccountDetails_add" aria-expanded="false" aria-controls="collapseAccountDetails_add">
            Account Details
        </button>
    </h2>
    <div id="collapseAccountDetails_add" class="accordion-collapse collapse" aria-labelledby="headingAccountDetails_add" data-bs-parent="#employeeAccordion_add">
        <div class="accordion-body">
            <div class="row">
                <div class="col-md-6">
                    <div class="mb-3">
                        <label class="col-form-label">Bank Name</label>
                        <select name="employee_bank" id="employee_bank" class="form-control">
                            <option value="">Select Bank</option>
                            {% for bank in bank_data %}
                            <option value="{{ bank.base_type }}">{{ bank.base_description }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="mb-3">
                        <label class="col-form-label">Branch Name</label>
                        <select name="bank_branch" id="bank_branch" class="form-control">
                            <option value="">Select Branch</option>
                            {% for branch in branch_data %}
                            <option value="{{ branch.base_type }}">{{ branch.base_description }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="mb-3">
                        <label class="col-form-label">Account No</label>
                        <input type="text" name="account_no" id="account_no" class="form-control">
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="mb-3">
                        <label class="col-form-label">IBAN Number</label>
                        <input type="text" name="iban_number" id="iban_number" class="form-control">
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Accommodation Details -->
<div class="accordion-item">
    <h2 class="accordion-header" id="headingCampDetails_add">
        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseCampDetails_add" aria-expanded="false" aria-controls="collapseCampDetails_add">
            Accommodation Details
        </button>
    </h2>
    <div id="collapseCampDetails_add" class="accordion-collapse collapse" aria-labelledby="headingCampDetails_add" data-bs-parent="#employeeAccordion_add">
        <div class="accordion-body">
            <div class="row">
                <div class="col-md-6">
                    <!-- Left side fields -->
                    <div class="mb-3">
                        <label class="col-form-label">Accommodation By</label>
                        <select name="camp_type" id="campType_add" class="form-control" onchange="handleCampTypeChange_add()">
                            <option value="">Select</option>
                            <option value="self">Self</option>
                            <option value="by_company">By Company</option>
                        </select>
                    </div>
                    <div id="campDetails_add" style="display: none;">
                        <div class="mb-3">
                            <label class="col-form-label">Accommodation Detail</label>
                            <select name="camp_inside_outside" id="campInsideOutside_add" class="form-control" onchange="handleInsideOutsideChange_add()">
                                <option value="">Select</option>
                                <option value="camp">Camp</option>
                                <option value="client_accommodation">Client Accommodation</option>
                                <option value="outside">Outside</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <!-- Right side fields -->
                    <div id="inCampDetails_add" style="display: none;">
                        <div class="mb-3">
                            <label class="col-form-label">Select Camp</label>
                            <select name="camp_code" id="select_camp" class="form-control">
                                <option value="">Select Camp</option>
                                {% for camp in camp_data %}
                                <option value="{{ camp.camp_code }}">{{ camp.camp_code }}-{{ camp.camp_name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="col-form-label">Accommodation Type</label>
                            <select name="accommodation_type" id="accommodation_type" class="form-control">
                                <option value="">Select Accommodation Type</option>
                                {% for accommodation in accommodation_type_data %}
                                <option value="{{ accommodation.base_value }}">{{ accommodation.base_description }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="col-form-label">Room No</label>
                            <input type="text" name="room_no" id="room_no" class="form-control">
                        </div>
                    </div>
                    <div id="clientAccommodationDetails_add" style="display: none;">
                        <div class="mb-3">
                            <label class="col-form-label">Client Name</label>
                            <input type="text" name="client_name" id="client_name" class="form-control">
                        </div>
                        <div class="mb-3">
                            <label class="col-form-label">Location</label>
                            <input type="text" name="client_location" id="client_location" class="form-control">
                        </div>
                    </div>
                    <div id="outsideDetails_add" style="display: none;">
                        <div class="mb-3">
                            <label class="col-form-label">Location</label>
                            <input type="text" name="outside_location" id="outside_location" class="form-control">
                        </div>
                        <div class="mb-3">
                            <label class="col-form-label">Room Rent</label>
                            <input type="number" name="room_rent" id="room_rent" class="form-control" min="0" step="0.01">
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    function handleCampTypeChange_add() {
        const campType = document.getElementById('campType_add').value;
        const campDetails = document.getElementById('campDetails_add');
        const inCampDetails = document.getElementById('inCampDetails_add');
        const clientAccommodationDetails = document.getElementById('clientAccommodationDetails_add');
        const outsideDetails = document.getElementById('outsideDetails_add');

        // Reset all fields when camp type changes
        document.getElementById('campInsideOutside_add').value = '';
        document.getElementById('select_camp').value = '';
        document.getElementById('room_no').value = '';
        document.getElementById('client_name').value = '';
        document.getElementById('client_location').value = '';
        document.getElementById('outside_location').value = '';
        document.getElementById('room_rent').value = '';
        document.getElementById('accommodation_type').value = '';
        if (campType === 'by_company') {
            campDetails.style.display = 'block';
        } else {
            campDetails.style.display = 'none';
            inCampDetails.style.display = 'none';
            clientAccommodationDetails.style.display = 'none';
            outsideDetails.style.display = 'none';
        }
    }

    function handleInsideOutsideChange_add() {
        const insideOutside = document.getElementById('campInsideOutside_add').value;
        const inCampDetails = document.getElementById('inCampDetails_add');
        const clientAccommodationDetails = document.getElementById('clientAccommodationDetails_add');
        const outsideDetails = document.getElementById('outsideDetails_add');

        // Reset all fields when accommodation type changes
        document.getElementById('select_camp').value = '';
        document.getElementById('room_no').value = '';
        document.getElementById('client_name').value = '';
        document.getElementById('client_location').value = '';
        document.getElementById('outside_location').value = '';
        document.getElementById('room_rent').value = '';
        document.getElementById('accommodation_type').value = '';
        document.getElementById('accommodation_type').value = '';
        if (insideOutside === 'camp') {
            inCampDetails.style.display = 'block';
            clientAccommodationDetails.style.display = 'none';
            outsideDetails.style.display = 'none';
        } else if (insideOutside === 'client_accommodation') {
            inCampDetails.style.display = 'none';
            clientAccommodationDetails.style.display = 'block';
            outsideDetails.style.display = 'none';
        } else if (insideOutside === 'outside') {
            inCampDetails.style.display = 'none';
            clientAccommodationDetails.style.display = 'none';
            outsideDetails.style.display = 'block';
        } else {
            inCampDetails.style.display = 'none';
            clientAccommodationDetails.style.display = 'none';
            outsideDetails.style.display = 'none';
        }
    }
</script>
<!-- /Accommodation Details -->




<!-- Travel Document Detail -->
<div class="accordion-item">
    <h2 class="accordion-header" id="headingTravelDocumentDetail_add">
        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseTravelDocumentDetail_add" aria-expanded="false" aria-controls="collapseTravelDocumentDetail_add">
            Travel Document Detail
        </button>
    </h2>
    <div id="collapseTravelDocumentDetail_add" class="accordion-collapse collapse" aria-labelledby="headingTravelDocumentDetail_add" data-bs-parent="#employeeAccordion_add">
        <div class="accordion-body">
            <div class="row">
                <div class="col-md-6">
                    <div class="mb-3">
                        <label class="col-form-label">Issued Date</label>
                        <input type="date" id="issued_date" name="issued_date" class="form-control">
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="mb-3">
                        <label class="col-form-label">Expiry Date</label>
                        <input type="date" id="expiry_date" name="expiry_date" class="form-control">
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="mb-3">
                        <label class="col-form-label">Passport Document Upload</label>
                        <input type="file" name="passport_document" id="passport_document" class="form-control" accept="application/pdf,image/*">
                        <div id="passport_document_preview"></div>
                        <small class="form-text text-muted">Maximum file size: 5MB</small>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="mb-3">
                        <label class="col-form-label">Passport No.</label>
                        <input type="text" name="passport_details" id="passport_details" class="form-control">
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="mb-3">
                        <label class="col-form-label">Passport Issued Country</label>
                        <select name="passport_issued_country" id="passport_issued_country" class="form-control">
                            <option value="">Select Country</option>
                            {% for country in country_data %}
                            <option value="{{ country.base_value }}">{{ country.base_description }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="mb-3">
                        <label class="col-form-label">Passport Place Of Issue</label>
                        <select name="passport_place_of_issue" id="passport_place_of_issue" class="form-control">
                            <option value="">Select Place</option>
                            {% for place in place_data %}
                            <option value="{{ place.base_value }}">{{ place.base_description }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="mb-3">
                        <label class="col-form-label">Travel Requirement</label>
                        <select name="ecnr" id="ecnr" class="form-control">
                            <option value="">Select</option>
                            {% for ecnr in ecnr_data %}
                            <option value="{{ ecnr.base_value }}">{{ ecnr.base_description }}</option>
                            {% endfor %}  
                        </select>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Visa Details -->
<div class="accordion-item">
    <h2 class="accordion-header" id="headingVisaDetails_add">
        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseVisaDetails_add" aria-expanded="false" aria-controls="collapseVisaDetails_add">
            Visa Details
        </button>
    </h2>
    <div id="collapseVisaDetails_add" class="accordion-collapse collapse" aria-labelledby="headingVisaDetails_add" data-bs-parent="#employeeAccordion_add">
        <div class="accordion-body">
            <div class="row">
                <div class="col-md-6">
                    <div class="mb-3">
                        <label class="col-form-label">Visa No</label>
                        <input type="text" name="visa_no" id="visa_no" class="form-control" placeholder="Enter Visa Number">
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="mb-3">
                        <label class="col-form-label">Visa Document Upload</label>
                        <input type="file" name="visa_document" id="visa_document" class="form-control" accept="application/pdf,image/*">
                        <div id="visa_document_preview"></div>
                        <small class="form-text text-muted">Maximum file size: 5MB</small>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="mb-3">
                        <label class="col-form-label">Visa Issued</label>
                        <input type="date" name="visa_issued" id="visa_issued" class="form-control">
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="mb-3">
                        <label class="col-form-label">Visa Expiry</label>
                        <input type="date" name="visa_expiry" id="visa_expiry" class="form-control">
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="mb-3">
                        <label class="col-form-label">Visa Issued Emirate</label>
                        <select name="visa_issued_emirate" id="visa_issued_emirate" class="form-select">
                            <option value="">Select Emirate</option>
                            {% for emirate in emirates_list %}
                            <option value="{{ emirate.base_value }}">
                                {{ emirate.base_description }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="mb-3">
                        <label class="col-form-label">Visa Designation</label>
                        <input type="text" name="visa_designation" id="visa_designation" class="form-control">
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="mb-3">
                        <label class="col-form-label">Emirates Id</label>
                        <input type="text" name="emirates_no" id="emirates_no" class="form-control" placeholder="Enter Emirates Id">
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="mb-3">
                        <label class="col-form-label">Emirates Id Document Upload</label>
                        <input type="file" name="emirate_document" id="emirate_document" class="form-control" accept="application/pdf,image/*">
                        <div id="emirate_document_preview"></div>
                        <small class="form-text text-muted">Maximum file size: 5MB</small>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="mb-3">
                        <label class="col-form-label">Emirates Id Issued</label>
                        <input type="date" name="emirate_issued" id="emirate_issued" class="form-control">
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="mb-3">
                        <label class="col-form-label">Emirates Id Expiry</label>
                        <input type="date" name="emirate_expiry" id="emirate_expiry" class="form-control">
                    </div>
                </div>

                <div class="col-md-6">
                    <div class="mb-3">
                        <label class="col-form-label">UID Number</label>
                        <input type="text" name="uid_number" id="uid_number" class="form-control" placeholder="Enter UID Number">
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="mb-3">
                        <label class="col-form-label">Personal Mohre Code</label>
                        <input type="text" name="mohra_number" id="mohra_number" class="form-control" placeholder="Enter Mohra Number">
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="mb-3">
                        <label class="col-form-label">Mohre Name</label>
                        <input type="text" name="mohra_name" id="mohra_name" class="form-control" placeholder="Enter Mohra Name">
                    </div>
                </div>
                
                <!-- <div class="col-md-6">
                    <div class="mb-3">
                        <label class="col-form-label">Mohre Designation</label>
                        <input type="text" name="mohra_designation" id="mohra_designation" class="form-control" placeholder="Enter Mohra Designation">
                    </div>
                </div>                 -->
                <div class="col-md-6">
                    <div class="mb-3">
                        <label class="col-form-label">Work Permit Number</label>
                        <input type="text" name="work_permit_number" id="work_permit_number" class="form-control" placeholder="Enter Work Permit Number">
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="mb-3">
                        <label class="col-form-label">Work Permit Expiry</label>
                        <input type="date" name="work_permit_expiry" id="work_permit_expiry" class="form-control">
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="mb-3">
                        <label class="col-form-label">Work Permit Document Upload</label>
                        <input type="file" name="work_permit_document" id="work_permit_document" class="form-control" accept="application/pdf,image/*">
                        <div id="work_permit_document_preview"></div>
                        <small class="form-text text-muted">Maximum file size: 5MB</small>
                    </div>
                </div>

                <!-- Inside/Outside Dropdown -->
                <div class="col-md-6">
                    <div class="mb-3">
                        <label class="col-form-label">Location</label>
                        <select id="locationSelect_add" class="form-control" name="visa_location">
                            <option value="">Select</option>
                            <option value="inside">Inside</option>
                            <option value="outside">Outside</option>
                        </select>
                    </div>
                </div>

                <!-- Change Status (Enable/Disable based on Selection) -->
                <div class="col-md-6">
                    <div class="mb-3">
                        <label class="col-form-label">Change Status</label>
                        <input type="file" id="changeStatusFile_add" name="change_status_file" class="form-control mt-2" accept="application/pdf,image/*" disabled>
                        <div id="changeStatusFile_preview"></div>
                        <small class="form-text text-muted">Maximum file size: 5MB</small>
                    </div>
                </div>

                <div class="col-md-6">
                    <div class="mb-3">
                        <label class="col-form-label">ILOE No</label>
                        <input type="text" name="iloe_no" id="iloe_no" class="form-control" >
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="mb-3">
                        <label class="col-form-label">ILOE Document</label>
                        <input type="file" name="iloe_document" id="iloe_document" class="form-control" accept="application/pdf,image/*">
                        <div id="iloe_document_preview"></div>
                        <small class="form-text text-muted">Maximum file size: 5MB</small>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="mb-3">
                        <label class="col-form-label">ILOE Expiry Date</label>
                        <input type="date" name="iloe_expiry" id="iloe_expiry" class="form-control">
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    document.getElementById('locationSelect_add').addEventListener('change', function () {
        
        var changeStatusFile = document.getElementById('changeStatusFile_add');

        if (this.value === 'inside') {
            
            changeStatusFile.removeAttribute('disabled');
        } else {
            
            changeStatusFile.setAttribute('disabled', 'disabled');
        }
    });
</script>

<!-- Add Document Uploads Section -->
<div class="accordion-item">
    <h2 class="accordion-header" id="headingDocumentUploads_add">
        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseDocumentUploads_add" aria-expanded="false" aria-controls="collapseDocumentUploads_add">
            Document Uploads
        </button>
    </h2>
    <div id="collapseDocumentUploads_add" class="accordion-collapse collapse" aria-labelledby="headingDocumentUploads_add" data-bs-parent="#employeeAccordion_add">
        <div class="accordion-body">
            <small class="form-text text-muted mb-3">Maximum file size: 5MB for all document uploads</small>
            <table class="table" id="documentUploadTable_add">
                <thead>
                    <tr>
                        <th>Document Type</th>
                        <th>File Upload</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>
                            <select class="form-select" id="document_type" name="document_type[]">
                                {% for document in doc_data %}
                                    <option value="{{ document.base_value }}">{{ document.base_description }}</option>  <!-- Adjust 'name' to the actual field you want to display -->
                                {% endfor %}
                            </select>
                        </td>
                        <td>
                            <input type="file" id="document_file" name="document_file[]" class="form-control" accept="application/pdf,image/*">
                        </td>
                        <td>
                            <button type="button" class="btn btn-danger" onclick="removeRow_add(this)">
                                <i class="fas fa-times"></i>
                            </button>
                            <button type="button" class="btn btn-primary" onclick="addRow_add()">
                                <i class="fas fa-plus"></i>
                            </button>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<script>
    function addRow_add() {
        const table = document.getElementById('documentUploadTable_add').getElementsByTagName('tbody')[0];
        const newRow = table.insertRow();
        newRow.innerHTML = `
            <td>
                <select class="form-select" name="document_type[]">
                    {% for document in doc_data %}
                        <option value="{{ document.base_value }}">{{ document.base_description }}</option>
                    {% endfor %}
                </select>
            </td>
            <td>
                <input type="file" name="document_file[]" class="form-control" accept="application/pdf,image/*">
            </td>
            <td>
                <button type="button" class="btn btn-danger" onclick="removeRow_add(this)">
                    <i class="fas fa-times"></i>
                </button>
                <button type="button" class="btn btn-primary" onclick="addRow_add()">
                    <i class="fas fa-plus"></i>
                </button>
            </td>
        `;
        
        // Add file size validation to the new file input
        const newFileInput = newRow.querySelector('input[type="file"]');
        newFileInput.addEventListener('change', function() {
            const files = this.files;
            if (files.length > 0) {
                for (let i = 0; i < files.length; i++) {
                    if (!validateFileSize(files[i])) {
                        this.value = ''; // Clear the input
                        return false;
                    }
                }
            }
        });
    }

    function removeRow_add(button, documentId = null) {
            const row = button.closest('tr');
            const tableBody = document.querySelector('#documentUploadTable_add tbody');
            
            if (!tableBody) {
                console.error('Table body not found');
                return;
            }
            
            // If this is an existing document (has documentId), add it to documents_to_remove
            if (documentId) {
                let documentsToRemove = document.getElementById('documents_to_remove');
                
                if (!documentsToRemove) {
                    documentsToRemove = document.createElement('input');
                    documentsToRemove.type = 'hidden';
                    documentsToRemove.id = 'documents_to_remove';
                    documentsToRemove.name = 'documents_to_remove';
                    const table = document.getElementById('documentUploadTable_add');
                    if (table && table.parentNode) {
                        table.parentNode.appendChild(documentsToRemove);
                    }
                }
                
                // Get current values and add new documentId
                const currentValues = documentsToRemove.value ? documentsToRemove.value.split(',') : [];
                if (!currentValues.includes(documentId.toString())) {
                    currentValues.push(documentId.toString());
                    documentsToRemove.value = currentValues.join(',');
                }
            }
            
            // Ensure at least one row remains
            if (tableBody.rows.length > 1) {
                row.remove();
            } else {
                // Show warning message
                const message = document.createElement('div');
                message.className = 'alert alert-warning mt-3';
                message.innerText = "At least one row must remain.";
                
                // Insert after table
                const table = document.getElementById('documentUploadTable_add');
                if (table && table.parentNode) {
                    table.parentNode.insertBefore(message, table.nextSibling);
                    
                    // Remove after 3 seconds
                    setTimeout(() => message.remove(), 3000);
                }
            }
        }

</script>

<!-- Add Dependent Details Section -->
<div class="accordion-item">
    <h2 class="accordion-header" id="headingDependentDetails_add">
        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" 
                data-bs-target="#collapseDependentDetails_add" aria-expanded="false" 
                aria-controls="collapseDependentDetails_add">
            Dependent Details
        </button>
    </h2>
    <div id="collapseDependentDetails_add" class="accordion-collapse collapse" 
         aria-labelledby="headingDependentDetails_add" data-bs-parent="#employeeAccordion_add">
        <div class="accordion-body">
            <small class="form-text text-muted mb-3">Maximum file size: 5MB for all dependent document uploads</small>
            <table class="table" id="dependentsTable_add">
                <thead>
                    <tr>
                        <th>Relationship</th>
                        <th>Document Type</th>
                        <th>Document Number</th>
                        <th>Issued Date</th>
                        <th>Expiry Date</th>
                        <th>File Upload</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>
                            <input type="hidden" name="dependent_id[]" value="">
                            <select class="form-select" name="dependent_relationship[]">
                                {% for relative in relatives_data %}
                                    <option value="{{ relative.base_value }}">{{ relative.base_description }}</option>
                                {% endfor %}
                            </select>
                        </td>
                        <td>
                            <select class="form-select" name="dependent_doc_type[]">
                                {% for document in other_documents_data %}
                                    <option value="{{ document.base_value }}">{{ document.base_description }}</option>
                                {% endfor %}
                            </select>
                        </td>
                        <td><input type="text" name="dependent_doc_number[]" class="form-control"></td>
                        <td><input type="date" name="dependent_issued_date[]" class="form-control"></td>
                        <td><input type="date" name="dependent_expiry_date[]" class="form-control"></td>
                        <td>
                            <input type="file" name="dependent_doc_file[]" class="form-control" accept="application/pdf,image/*">
                            <div class="dependent-file-preview"></div>
                        </td>
                        <td>
                            <button type="button" class="btn btn-danger" onclick="removeDependentRow_add(this)">
                                <i class="fas fa-times"></i>
                            </button>
                            <button type="button" class="btn btn-primary" onclick="addDependentRow_add()">
                                <i class="fas fa-plus"></i>
                            </button>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<script>
function addDependentRow_add() {
    const tableBody = document.querySelector('#dependentsTable_add tbody');
    const newRow = document.createElement('tr');
    newRow.innerHTML = `
        <td>
            <input type="hidden" name="dependent_id[]" value="">
            <select class="form-select" name="dependent_relationship[]">
                {% for relative in relatives_data %}
                    <option value="{{ relative.base_value }}">{{ relative.base_description }}</option>
                {% endfor %}
            </select>
        </td>
        <td>
            <select class="form-select" name="dependent_doc_type[]">
                {% for document in other_documents_data %}
                    <option value="{{ document.base_value }}">{{ document.base_description }}</option>
                {% endfor %}
            </select>
        </td>
        <td><input type="text" name="dependent_doc_number[]" class="form-control"></td>
        <td><input type="date" name="dependent_issued_date[]" class="form-control"></td>
        <td><input type="date" name="dependent_expiry_date[]" class="form-control"></td>
        <td>
            <input type="file" name="dependent_doc_file[]" class="form-control" accept="application/pdf,image/*">
            <div class="dependent-file-preview"></div>
        </td>
        <td>
            <button type="button" class="btn btn-danger" onclick="removeDependentRow_add(this)">
                <i class="fas fa-times"></i>
            </button>
            <button type="button" class="btn btn-primary" onclick="addDependentRow_add()">
                <i class="fas fa-plus"></i>
            </button>
        </td>
    `;
    tableBody.appendChild(newRow);
    
    // Add file size validation to the new file input
    const newFileInput = newRow.querySelector('input[type="file"]');
    newFileInput.addEventListener('change', function() {
        const files = this.files;
        if (files.length > 0) {
            for (let i = 0; i < files.length; i++) {
                if (!validateFileSize(files[i])) {
                    this.value = ''; // Clear the input
                    return false;
                }
            }
        }
    });
}

function removeDependentRow_add(button, dependentId = null) {
    const row = button.closest('tr');
    const tableBody = document.querySelector('#dependentsTable_add tbody');
    
    if (!tableBody) {
        console.error('Table body not found');
        return;
    }
    
    // If this is an existing dependent (has dependentId), add it to dependents_to_remove
    if (dependentId) {
        let dependentsToRemove = document.getElementById('dependents_to_remove');
        
        if (!dependentsToRemove) {
            dependentsToRemove = document.createElement('input');
            dependentsToRemove.type = 'hidden';
            dependentsToRemove.id = 'dependents_to_remove';
            dependentsToRemove.name = 'dependents_to_remove';
            const table = document.getElementById('dependentsTable_add');
            if (table && table.parentNode) {
                table.parentNode.appendChild(dependentsToRemove);
            }
        }
        
        // Get current values and add new dependentId
        const currentValues = dependentsToRemove.value ? dependentsToRemove.value.split(',') : [];
        if (!currentValues.includes(dependentId.toString())) {
            currentValues.push(dependentId.toString());
            dependentsToRemove.value = currentValues.join(',');
        }
    }
    
    // Ensure at least one row remains
    if (tableBody.rows.length > 1) {
        row.remove();
    } else {
        // Show warning message
        const message = document.createElement('div');
        message.className = 'alert alert-warning mt-3';
        message.innerText = "At least one row must remain.";
        
        // Insert after table
        const table = document.getElementById('dependentsTable_add');
        if (table && table.parentNode) {
            table.parentNode.insertBefore(message, table.nextSibling);
            
            // Remove after 3 seconds
            setTimeout(() => message.remove(), 3000);
        }
    }
}
</script>

<!-- License and Passes Details Section -->
<div class="accordion-item">
    <h2 class="accordion-header" id="headingLicenseDetails_add">
        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                data-bs-target="#collapseLicenseDetails_add" aria-expanded="false"
                aria-controls="collapseLicenseDetails_add">
            License and Passes Details
        </button>
    </h2>
    <div id="collapseLicenseDetails_add" class="accordion-collapse collapse"
         aria-labelledby="headingLicenseDetails_add" data-bs-parent="#employeeAccordion_add">
        <div class="accordion-body">
            <small class="form-text text-muted mb-3">Maximum file size: 5MB for all license and passes document uploads</small>
            <table class="table" id="licensePassesTable_add">
                <thead>
                    <tr>
                        <th>Document Type</th>
                        <th>Document Number</th>
                        <th>Issued Date</th>
                        <th>Expiry Date</th>
                        <th>Work Location</th>
                        <th>Emirate Issued</th>
                        <th>Category</th>
                        <th>File Upload</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>
                            <input type="hidden" name="license_id[]" value="">
                            <select class="form-select doc-type-select" name="license_doc_type[]" onchange="toggleCategoryColumn(this)">
                                <option value="">-- Select --</option>
                                {% for lp in lp_data %}
                                    <option value="{{ lp.base_value }}">{{ lp.base_description }}</option>
                                {% endfor %}
                            </select>
                        </td>
                        <td><input type="text" name="license_doc_number[]" class="form-control"></td>
                        <td><input type="date" name="license_issued_date[]" class="form-control"></td>
                        <td><input type="date" name="license_expiry_date[]" class="form-control"></td>
                        <td>
                            <select class="form-select" name="work_location[]">
                                {% for location in work_location_data %}
                                    <option value="{{ location.base_value }}">{{ location.base_description }}</option>
                                {% endfor %}
                            </select>
                        </td>
                        <td>
                            <select class="form-select" name="emirate_issued[]">
                                {% for emirate in emirates_list %}
                                    <option value="{{ emirate.base_value }}">{{ emirate.base_description }}</option>
                                {% endfor %}
                            </select>
                        </td>
                        <td>
                            <select class="form-select category-column" name="license_category[]" style="display:none;">
                                <option value="">-- Select Category --</option>
                                <option value="light">Light</option>
                                <option value="heavy">Heavy</option>
                                <option value="high">High</option>
                            </select>
                        </td>
                        <td>
                            <input type="file" name="license_doc_file[]" class="form-control" accept="application/pdf,image/*">
                            <div class="license-file-preview"></div>
                        </td>
                        <td>
                            <button type="button" class="btn btn-danger" onclick="removeLicenseRow_add(this)">
                                <i class="fas fa-times"></i>
                            </button>
                            <button type="button" class="btn btn-primary" onclick="addLicenseRow_add()">
                                <i class="fas fa-plus"></i>
                            </button>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<script>
function toggleCategoryColumn(selectEl) {
    const row = selectEl.closest('tr');
    const categoryCol = row.querySelector('.category-column');
    // Show category column for any license-related option (you may need to adjust this based on your L&P data)
    if (selectEl.value && selectEl.value.toLowerCase().includes('license')) {
        categoryCol.style.display = '';
    } else {
        categoryCol.style.display = 'none';
        categoryCol.value = ''; // Reset value
    }
}

function addLicenseRow_add() {
    const tableBody = document.querySelector('#licensePassesTable_add tbody');
    const newRow = document.createElement('tr');
    
    // Get the first row to extract the L&P options
    const firstRow = tableBody.querySelector('tr');
    const firstSelect = firstRow.querySelector('select[name="license_doc_type[]"]');
    const lpOptions = Array.from(firstSelect.options).map(option => 
        `<option value="${option.value}">${option.textContent}</option>`
    ).join('');
    
    newRow.innerHTML = `
        <td>
            <input type="hidden" name="license_id[]" value="">
            <select class="form-select doc-type-select" name="license_doc_type[]" onchange="toggleCategoryColumn(this)">
                ${lpOptions}
            </select>
        </td>
        <td><input type="text" name="license_doc_number[]" class="form-control"></td>
        <td><input type="date" name="license_issued_date[]" class="form-control"></td>
        <td><input type="date" name="license_expiry_date[]" class="form-control"></td>
        <td>
            <select class="form-select" name="work_location[]">
                {% for location in work_location_data %}
                    <option value="{{ location.base_value }}">{{ location.base_description }}</option>
                {% endfor %}
            </select>
        </td>
        <td>
            <select class="form-select" name="emirate_issued[]">
                {% for emirate in emirates_list %}
                    <option value="{{ emirate.base_value }}">{{ emirate.base_description }}</option>
                {% endfor %}
            </select>
        </td>
        <td>
            <select class="form-select category-column" name="license_category[]" style="display:none;">
                <option value="">-- Select Category --</option>
                <option value="light">Light</option>
                <option value="heavy">Heavy</option>
                <option value="high">High</option>
            </select>
        </td>
        <td>
            <input type="file" name="license_doc_file[]" class="form-control" accept="application/pdf,image/*">
            <div class="license-file-preview"></div>
        </td>
        <td>
            <button type="button" class="btn btn-danger" onclick="removeLicenseRow_add(this)">
                <i class="fas fa-times"></i>
            </button>
            <button type="button" class="btn btn-primary" onclick="addLicenseRow_add()">
                <i class="fas fa-plus"></i>
            </button>
        </td>
    `;
    tableBody.appendChild(newRow);
    
    // Add file size validation to the new file input
    const newFileInput = newRow.querySelector('input[type="file"]');
    newFileInput.addEventListener('change', function() {
        const files = this.files;
        if (files.length > 0) {
            for (let i = 0; i < files.length; i++) {
                if (!validateFileSize(files[i])) {
                    this.value = ''; // Clear the input
                    return false;
                }
            }
        }
    });
}

function removeLicenseRow_add(button, licenseId = null) {
    const row = button.closest('tr');
    const tableBody = document.querySelector('#licensePassesTable_add tbody');
    
    if (!tableBody) {
        console.error('Table body not found');
        return;
    }
    
    // If this is an existing license (has licenseId), add it to licenses_to_remove
    if (licenseId && licenseId !== '') {
        let licensesToRemove = document.getElementById('licenses_to_remove');
        
        if (!licensesToRemove) {
            licensesToRemove = document.createElement('input');
            licensesToRemove.type = 'hidden';
            licensesToRemove.id = 'licenses_to_remove';
            licensesToRemove.name = 'licenses_to_remove';
            const table = document.getElementById('licensePassesTable_add');
            if (table && table.parentNode) {
                table.parentNode.appendChild(licensesToRemove);
            }
        }
        
        // Get current values and add new licenseId
        const currentValues = licensesToRemove.value ? licensesToRemove.value.split(',') : [];
        if (!currentValues.includes(licenseId.toString())) {
            currentValues.push(licenseId.toString());
            licensesToRemove.value = currentValues.join(',');
        }
    }
    
    // Ensure at least one row remains
    if (tableBody.rows.length > 1) {
        row.remove();
    } else {
        // Show warning message
        const message = document.createElement('div');
        message.className = 'alert alert-warning mt-3';
        message.innerText = "At least one row must remain.";
        
        // Insert after table
        const table = document.getElementById('licensePassesTable_add');
        if (table && table.parentNode) {
            table.parentNode.insertBefore(message, table.nextSibling);
            
            // Remove after 3 seconds
            setTimeout(() => message.remove(), 3000);
        }
    }
}
</script>

<!-- Recruitment Information -->
<div class="accordion-item">
    <h2 class="accordion-header" id="headingRecruitmentInfo_add">
        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
            data-bs-target="#collapseRecruitmentInfo_add" aria-expanded="false" aria-controls="collapseRecruitmentInfo_add">
            Recruitment Information
        </button>
    </h2>
    <div id="collapseRecruitmentInfo_add" class="accordion-collapse collapse" aria-labelledby="headingRecruitmentInfo_add"
        data-bs-parent="#employeeAccordion_add">
        <div class="accordion-body">
            <table class="table" id="recruitmentInfoTable_add">
                <thead>
                    <tr>
                        <th>Agent Name</th>
                        <th>Location</th>
                        <th>Change Status</th>
                        <th>Recruitment From</th>
                        <th>Date</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>
                            <input type="hidden" name="recruitment_id[]" value="">
                            <select class="form-select" name="agent_name[]">
                                <option value="">Select Agent</option>
                                {% for agent in agent_data %}
                                <option value="{{ agent.base_value }}">{{ agent.base_description }}</option>
                                {% endfor %}
                            </select>
                        </td>
                        <td>
                            <select class="form-select" name="location[]">
                                <option value="">Select Location</option>
                                {% for location in location_data %}
                                <option value="{{ location.base_value }}">{{ location.base_description }}</option>
                                {% endfor %}
                            </select>
                        </td>
                        <td>
                            <select class="form-select" name="change_status[]">
                                <option value="">Select</option>
                                <option value="inside">Inside</option>
                                <option value="outside">Outside</option>
                            </select>
                        </td>
                        <td>
                            <input type="text" name="recruitment_from[]" class="form-control" placeholder="Enter Recruitment From">
                        </td>
                        <td>
                            <input type="date" name="recruitment_date[]" class="form-control">
                        </td>
                        <td>
                            <button type="button" class="btn btn-danger" onclick="removeRecruitmentRow_add(this)">
                                <i class="fas fa-times"></i>
                            </button>
                            <button type="button" class="btn btn-primary" onclick="addRecruitmentRow_add()">
                                <i class="fas fa-plus"></i>
                            </button>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<script>
    function addRecruitmentRow_add() {
        const table = document.getElementById('recruitmentInfoTable_add').getElementsByTagName('tbody')[0];
        const newRow = table.insertRow();
        newRow.innerHTML = `
            <td>
                <select class="form-select" name="agent_name[]">
                    <option value="">Select Agent</option>
                    {% for agent in agent_data %}
                    <option value="{{ agent.base_value }}">{{ agent.base_description }}</option>
                    {% endfor %}
                </select>
            </td>
            <td>
                <select class="form-select" name="location[]">
                    <option value="">Select Location</option>
                    {% for location in location_data %}
                    <option value="{{ location.base_value }}">{{ location.base_description }}</option>
                    {% endfor %}
                </select>
            </td>
            <td>
                <select class="form-select" name="change_status[]">
                    <option value="">Select</option>
                    <option value="inside">Inside</option>
                    <option value="outside">Outside</option>
                </select>
            </td>
            <td>
                <input type="text" name="recruitment_from[]" class="form-control" placeholder="Enter Recruitment From">
            </td>
            <td>
                <input type="date" name="recruitment_date[]" class="form-control">
            </td>
            <td>
                <button type="button" class="btn btn-danger" onclick="removeRecruitmentRow_add(this)">
                    <i class="fas fa-times"></i>
                </button>
                <button type="button" class="btn btn-primary" onclick="addRecruitmentRow_add()">
                    <i class="fas fa-plus"></i>
                </button>
            </td>
        `;
    }

    function removeRecruitmentRow_add(button, recruitmentId = null) {
            const row = button.closest('tr');
            const tableBody = document.querySelector('#recruitmentInfoTable_add tbody');
            
            if (!tableBody) {
                console.error('Table body not found');
                return;
            }
            
            // If this is an existing recruitment (has recruitmentId), add it to recruitments_to_remove
            if (recruitmentId && recruitmentId !== '') {
                let recruitmentsToRemove = document.getElementById('recruitments_to_remove');
                
                if (!recruitmentsToRemove) {
                    recruitmentsToRemove = document.createElement('input');
                    recruitmentsToRemove.type = 'hidden';
                    recruitmentsToRemove.id = 'recruitments_to_remove';
                    recruitmentsToRemove.name = 'recruitments_to_remove';
                    const table = document.getElementById('recruitmentInfoTable_add');
                    if (table && table.parentNode) {
                        table.parentNode.appendChild(recruitmentsToRemove);
                    }
                }
                
                // Get current values and add new recruitmentId
                const currentValues = recruitmentsToRemove.value ? recruitmentsToRemove.value.split(',') : [];
                if (!currentValues.includes(recruitmentId.toString())) {
                    currentValues.push(recruitmentId.toString());
                    recruitmentsToRemove.value = currentValues.join(',');
                }
            }
            
            // Ensure at least one row remains
            if (tableBody.rows.length > 1) {
                row.remove();
            } else {
                // Show warning message
                const message = document.createElement('div');
                message.className = 'alert alert-warning mt-3';
                message.innerText = "At least one row must remain.";
                
                // Insert after table
                const table = document.getElementById('recruitmentInfoTable_add');
                if (table && table.parentNode) {
                    table.parentNode.insertBefore(message, table.nextSibling);
                    
                    // Remove after 3 seconds
                    setTimeout(() => message.remove(), 3000);
                }
            }
        }
</script>
            

            <div class="d-flex align-items-center justify-content-end mt-4">
                <button type="button" data-bs-dismiss="offcanvas" class="btn btn-light me-2">Cancel</button>
                <button type="submit" class="btn btn-primary create-btn">Save</button>
            </div>
        </form>
    </div>
</div>
<!-- /Add Employee Offcanvas -->

<script>
document.querySelectorAll('input[name="depend_count"], input[name="child_count"]').forEach(function(input) {
    input.addEventListener('input', function() {
        if (parseInt(this.value) < 0) {
            alert(this.name.replace('_', ' ') + ' cannot be negative!');
            this.value = '';
        }
    });
});

// File size validation function (5MB = 5 * 1024 * 1024 bytes)
function validateFileSize(file, maxSizeMB = 5) {
    console.log('validateFileSize called with file:', file.name, 'Size:', file.size, 'Max size:', maxSizeMB, 'MB');
    const maxSizeBytes = maxSizeMB * 1024 * 1024;
    if (file && file.size > maxSizeBytes) {
        console.log('File size validation failed. File size:', file.size, 'Max allowed:', maxSizeBytes);
        alert(`File size must be ${maxSizeMB}MB or less. Selected file size: ${(file.size / (1024 * 1024)).toFixed(2)}MB`);
        return false;
    }
    console.log('File size validation passed');
    return true;
}

// Add file size validation to all file inputs
document.addEventListener('DOMContentLoaded', function() {
    console.log('DOMContentLoaded: Setting up file size validation for all file inputs');
    
    // Function to apply validation to file inputs
    function applyFileSizeValidation() {
        const fileInputs = document.querySelectorAll('input[type="file"]');
        console.log('Found', fileInputs.length, 'file input elements');
        
        fileInputs.forEach(function(input, index) {
            // Remove existing event listeners to avoid duplicates
            input.removeEventListener('change', input.fileSizeValidationHandler);
            
            // Create new event listener
            input.fileSizeValidationHandler = function() {
                console.log('File input change event triggered for input', index);
                const files = this.files;
                if (files.length > 0) {
                    for (let i = 0; i < files.length; i++) {
                        console.log('Validating file:', files[i].name, 'Size:', files[i].size);
                        if (!validateFileSize(files[i])) {
                            this.value = ''; // Clear the input
                            return false;
                        }
                    }
                }
            };
            
            // Add the event listener
            input.addEventListener('change', input.fileSizeValidationHandler);
        });
    }
    
    // Apply validation immediately
    applyFileSizeValidation();
    
    // Also apply validation after a short delay to catch any dynamically loaded content
    setTimeout(applyFileSizeValidation, 100);
    setTimeout(applyFileSizeValidation, 500);
    setTimeout(applyFileSizeValidation, 1000);
    
    // Additional event delegation approach to catch all file input changes
    document.addEventListener('change', function(e) {
        if (e.target.type === 'file') {
            console.log('Event delegation: File input change detected');
            const files = e.target.files;
            if (files.length > 0) {
                for (let i = 0; i < files.length; i++) {
                    console.log('Event delegation: Validating file:', files[i].name, 'Size:', files[i].size);
                    if (!validateFileSize(files[i])) {
                        e.target.value = ''; // Clear the input
                        return false;
                    }
                }
            }
        }
    });
});

document.addEventListener('DOMContentLoaded', function() {
    var dobInput = document.getElementById('dob');
    if (dobInput) {
        var today = new Date();
        var year = today.getFullYear() - 16;
        var month = String(today.getMonth() + 1).padStart(2, '0');
        var day = String(today.getDate()).padStart(2, '0');
        var maxDate = year + '-' + month + '-' + day;
        dobInput.max = maxDate;
    }
});

function validateIssueExpiry(issueInput, expiryInput, label) {
    if (!issueInput.value || !expiryInput.value) return;
    const issueDate = new Date(issueInput.value);
    const expiryDate = new Date(expiryInput.value);

    if (issueDate.getTime() === expiryDate.getTime()) {
        alert(label + ' Issue and Expiry date cannot be the same.');
        expiryInput.value = '';
        expiryInput.focus();
    } else if (expiryDate < issueDate) {
        alert(label + ' Expiry date must be after Issue date.');
        expiryInput.value = '';
        expiryInput.focus();
    }
}

// For single fields
function setupSingleDateValidation(issueId, expiryId, label) {
    const issueInput = document.getElementById(issueId);
    const expiryInput = document.getElementById(expiryId);
    if (issueInput && expiryInput) {
        issueInput.addEventListener('blur', function() {
            validateIssueExpiry(issueInput, expiryInput, label);
        });
        expiryInput.addEventListener('blur', function() {
            validateIssueExpiry(issueInput, expiryInput, label);
        });
    }
}

// For table rows (multiple fields)
function setupTableDateValidation(issueSelector, expirySelector, label) {
    document.addEventListener('blur', function(e) {
        if (e.target.matches(issueSelector) || e.target.matches(expirySelector)) {
            // Find the row
            const row = e.target.closest('tr');
            if (!row) return;
            const issueInput = row.querySelector(issueSelector);
            const expiryInput = row.querySelector(expirySelector);
            if (issueInput && expiryInput) {
                validateIssueExpiry(issueInput, expiryInput, label);
            }
        }
    });
}

// Setup for single fields
setupSingleDateValidation('issued_date', 'expiry_date', 'Travel Document');
setupSingleDateValidation('visa_issued', 'visa_expiry', 'Visa');
setupSingleDateValidation('emirate_issued', 'emirate_expiry', 'Emirates ID');

// Setup for tables (dynamic rows)
setupTableDateValidation('input[name="dependent_issued_date[]"]', 'input[name="dependent_expiry_date[]"]', 'Dependent');
setupTableDateValidation('input[name="license_issued_date[]"]', 'input[name="license_expiry_date[]"]', 'License/Pass');

// Validate Basic Salary and all Amount fields (including dynamic)
function setupNonNegativeValidation() {
    // For static fields
    const basicPay = document.getElementById('basic_pay');
    if (basicPay) {
        basicPay.addEventListener('input', function() {
            if (parseFloat(this.value) < 0) {
                alert('Basic salary cannot be negative!');
                this.value = '';
            }
        });
    }

    // For all amount fields (including dynamic)
    document.addEventListener('input', function(e) {
        if (e.target.matches('input[name="entry_amount[]"]')) {
            if (parseFloat(e.target.value) < 0) {
                alert('Amount cannot be negative!');
                e.target.value = '';
            }
        }
    });
}

document.addEventListener('DOMContentLoaded', function() {
    setupNonNegativeValidation();
    
    // Clear validation errors when user starts typing or selecting
    const form = document.getElementById('addEmployeeForm');
    if (form) {
        form.addEventListener('input', function(e) {
            if (e.target.classList.contains('is-invalid')) {
                e.target.classList.remove('is-invalid');
                e.target.style.borderColor = '';
                e.target.style.boxShadow = '';
            }
        });
        
        form.addEventListener('change', function(e) {
            if (e.target.classList.contains('is-invalid')) {
                e.target.classList.remove('is-invalid');
                e.target.style.borderColor = '';
                e.target.style.boxShadow = '';
            }
        });
    }
});

// Form validation function
function validateForm() {
    const mandatoryFields = [
        { id: 'emp_name_passport', label: 'Employee Name (As per Passport)' },
        { id: 'surname', label: 'Surname' },
        { id: 'dob', label: 'Date of Birth' },
        { id: 'emp_sex', label: 'Gender' },
        { id: 'nationality', label: 'Nationality' },
        { id: 'designation', label: 'Designation' },
        { id: 'date_of_join', label: 'Date of Join' },
        { id: 'department', label: 'Department' },
        { id: 'res_addr_line1', label: 'Address Line 1' },
        { id: 'res_city', label: 'City' },
        { id: 'res_state', label: 'State' },
        { id: 'staff_category', label: 'Category' }
    ];

    // Add salary fields if user has salary permissions
    const userSalary = '{{ request.session.user_salary }}';
    if (userSalary === 'Yes') {
        mandatoryFields.push(
            { id: 'basic_pay', label: 'Basic Pay' }
        );
    }

    const missingFields = [];

    mandatoryFields.forEach(field => {
        const element = document.getElementById(field.id);
        if (element) {
            if (element.type === 'select-one') {
                if (!element.value || element.value === '') {
                    missingFields.push(field.label);
                }
            } else {
                if (!element.value || element.value.trim() === '') {
                    missingFields.push(field.label);
                }
            }
        }
    });

    // Validate file sizes before form submission
    const fileInputs = document.querySelectorAll('input[type="file"]');
    let hasFileSizeError = false;
    
    fileInputs.forEach(function(input) {
        const files = input.files;
        if (files.length > 0) {
            for (let i = 0; i < files.length; i++) {
                if (!validateFileSize(files[i])) {
                    hasFileSizeError = true;
                    break;
                }
            }
        }
    });
    
    if (hasFileSizeError) {
        return false;
    }

    if (missingFields.length > 0) {
        const fieldNames = missingFields.join('\n• ');
        const message = 'Please fill in the following mandatory fields:\n\n• ' + fieldNames;
        
        // Create a custom modal for better UX
        const modal = document.createElement('div');
        modal.className = 'modal fade';
        modal.id = 'validationModal';
        modal.innerHTML = `
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header bg-danger text-white">
                        <h5 class="modal-title">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            Required Fields Missing
                        </h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <p class="mb-3">Please fill in the following mandatory fields:</p>
                        <ul class="list-group">
                            ${missingFields.map(field => `<li class="list-group-item">• ${field}</li>`).join('')}
                        </ul>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">OK</button>
                    </div>
                </div>
            </div>
        `;
        
        document.body.appendChild(modal);
        const bootstrapModal = new bootstrap.Modal(modal);
        bootstrapModal.show();
        
        // Remove modal from DOM after it's hidden
        modal.addEventListener('hidden.bs.modal', function() {
            document.body.removeChild(modal);
        });
        
        // Highlight missing fields
        highlightMissingFields(missingFields);
        
        return false;
    }

    // Clear any previous error highlighting
    clearFieldErrors();
    
    return true;
}

// Function to highlight missing fields
function highlightMissingFields(missingFields) {
    missingFields.forEach(field => {
        const element = document.getElementById(field.id);
        if (element) {
            element.classList.add('is-invalid');
            element.style.borderColor = '#dc3545';
            element.style.boxShadow = '0 0 0 0.2rem rgba(220, 53, 69, 0.25)';
        }
    });
}

// Function to clear error highlighting
function clearFieldErrors() {
    const allFields = document.querySelectorAll('#addEmployeeForm input, #addEmployeeForm select');
    allFields.forEach(field => {
        field.classList.remove('is-invalid');
        field.style.borderColor = '';
        field.style.boxShadow = '';
    });
}
</script>