{% load static %}


<!-- Add New Contracts -->
<div class="offcanvas offcanvas-end offcanvas-large" tabindex="-1" id="offcanvas_add">
    <div class="offcanvas-header border-bottom">
        <h4>Advance Master</h4>
        <button type="button"
            class="btn-close custom-btn-close border p-1 me-0 d-flex align-items-center justify-content-center rounded-circle"
            data-bs-dismiss="offcanvas" aria-label="Close">
            <i class="ti ti-x"></i>
        </button>
    </div>
    <div class="offcanvas-body">
        <form method="post" action="{% url 'advance_master' %}">
            {% csrf_token %}
            <!-- Form fields -->
            <div class="row">
                <!-- Employee Code -->
                <div class="col-md-6">
                    <div class="mb-3">
                        <label class="col-form-label">Employee Code <span class="text-danger">*</span></label>
                        <select class="select2" name="emp_code" required>
                            <option value="">Choose</option>
                            <option value="E001">E001</option>
                            <option value="E002">E002</option>
                        </select>
                    </div>
                </div>

                <!-- Advance Code -->
                <div class="col-md-6">
                    <div class="mb-3">
                        <label class="col-form-label">Advance Code <span class="text-danger">*</span></label>
                        <select class="select2" name="advance_code" required>
                            <option value="">Choose</option>
                            <option value="A001">A001</option>
                            <option value="A002">A002</option>
                        </select>
                    </div>
                </div>

                <!-- Advance Reference -->
                <div class="col-md-6">
                    <div class="mb-3">
                        <label class="col-form-label">Advance Reference <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" name="advance_reference" required>
                    </div>
                </div>

                <!-- Reference Date -->
                <div class="col-md-6">
                    <div class="mb-3">
                        <label class="col-form-label">Reference Date <span class="text-danger">*</span></label>
                        <input type="text" class="form-control datetimepicker" name="reference_date"
                            placeholder="DD-MM-YYYY" required>
                    </div>
                </div>

                <!-- Total Amount -->
                <div class="col-md-6">
                    <div class="mb-3">
                        <label class="col-form-label">Total Amount <span class="text-danger">*</span></label>
                        <input type="number" class="form-control" name="total_amt" required>
                    </div>
                </div>

                <!-- Installment Amount -->
                <div class="col-md-6">
                    <div class="mb-3">
                        <label class="col-form-label">Installment Amount <span class="text-danger">*</span></label>
                        <input type="number" class="form-control" name="instalment_amt" required>
                    </div>
                </div>

                <!-- Paid Amount -->
                <div class="col-md-6">
                    <div class="mb-3">
                        <label class="col-form-label">Paid Amount <span class="text-danger">*</span></label>
                        <input type="number" class="form-control" name="paid_amt" required>
                    </div>
                </div>

                <!-- Total No. of Installments -->
                <div class="col-md-6">
                    <div class="mb-3">
                        <label class="col-form-label">Total No. of Installments <span
                                class="text-danger">*</span></label>
                        <input type="number" class="form-control" name="total_no_instalment" required>
                    </div>
                </div>

                <!-- Balance No. of Installments -->
                <div class="col-md-6">
                    <div class="mb-3">
                        <label class="col-form-label">Balance No. of Installments <span
                                class="text-danger">*</span></label>
                        <input type="number" class="form-control" name="balance_no_instalment" required>
                    </div>
                </div>

                <!-- Repayment From -->
                <div class="col-md-6">
                    <div class="mb-3">
                        <label class="col-form-label">Repayment From <span class="text-danger">*</span></label>
                        <input type="text" class="form-control datetimepicker" name="repayment_from"
                            placeholder="DD-MM-YYYY" required>
                    </div>
                </div>

                <!-- Next Repayment Date -->
                <div class="col-md-6">
                    <div class="mb-3">
                        <label class="col-form-label">Next Repayment Date <span class="text-danger">*</span></label>
                        <input type="text" class="form-control datetimepicker" name="next_repayment_date"
                            placeholder="DD-MM-YYYY" required>
                    </div>
                </div>

                <!-- Default Count -->
                <div class="col-md-6">
                    <div class="mb-3">
                        <label class="col-form-label">Default Count <span class="text-danger">*</span></label>
                        <input type="number" class="form-control" name="default_count" required>
                    </div>
                </div>

                <!-- Waiver Amount -->
                <div class="col-md-6">
                    <div class="mb-3">
                        <label class="col-form-label">Waiver Amount <span class="text-danger">*</span></label>
                        <input type="number" class="form-control" name="waiver_amt" required>
                    </div>
                </div>

                <!-- Waiver Date -->
                <div class="col-md-6">
                    <div class="mb-3">
                        <label class="col-form-label">Waiver Date</label>
                        <input type="text" class="form-control datetimepicker" name="waiver_date"
                            placeholder="DD-MM-YYYY">
                    </div>
                </div>
            </div>

            <!-- Is Active -->
            <div class="form-check">
                <input type="checkbox" class="form-check-input" name="is_active" value="true" id="is_active" checked>
                <label class="form-check-label" for="is_active">Is Active</label>
            </div>

            <!-- Buttons -->
            <div class="mt-3 d-flex justify-content-end">
                <button type="button" class="btn btn-light me-2" data-bs-dismiss="offcanvas">Cancel</button>
                <button type="submit" class="btn btn-primary">Create</button>
            </div>
        </form>
    </div>
</div>

<!-- /Add New Contracts -->

<!-- Edit Contract -->
<div class="offcanvas offcanvas-end offcanvas-large" tabindex="-1" id="offcanvas_edit">
    <div class="offcanvas-header border-bottom">
        <h4>Edit Contract</h4>
        <button type="button"
            class="btn-close custom-btn-close border p-1 me-0 d-flex align-items-center justify-content-center rounded-circle"
            data-bs-dismiss="offcanvas" aria-label="Close">
            <i class="ti ti-x"></i>
        </button>
    </div>
    <div class="offcanvas-body">
        <form method="post" action="#">
            {% csrf_token %}
            <input type="hidden" name="advance_id" id="edit-advance-id" value="">

            <div class="row">
                <!-- Employee Code -->
                <div class="col-md-6">
                    <div class="mb-3">
                        <label class="form-label">Employee Code <span class="text-danger">*</span></label>
                        <select class="select2" name="emp_code" required>
                            <option value="">Choose</option>
                            <option value="E001">E001</option>
                            <option value="E002">E002</option>
                        </select>
                    </div>
                </div>

                <!-- Advance Code -->
                <div class="col-md-6">
                    <div class="mb-3">
                        <label class="form-label">Advance Code <span class="text-danger">*</span></label>
                        <select class="select2" name="advance_code" required>
                            <option value="">Choose</option>
                            <option value="">Choose</option>
                            <option value="A001">A001</option>
                            <option value="A002">A002</option>
                        </select>
                    </div>
                </div>

                <!-- Advance Reference -->
                <div class="col-md-6">
                    <div class="mb-3">
                        <label class="form-label">Advance Reference <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" name="advance_reference" required>
                    </div>
                </div>

                <!-- Reference Date -->
                <div class="col-md-6">
                    <div class="mb-3">
                        <label class="form-label">Reference Date <span class="text-danger">*</span></label>
                        <div class="icon-form">
                            <span class="form-icon"><i class="ti ti-calendar-check"></i></span>
                            <input type="text" class="form-control datetimepicker" name="reference_date"
                                placeholder="DD/MM/YYYY" required>
                        </div>
                    </div>
                </div>

                <!-- Total Amount -->
                <div class="col-md-6">
                    <div class="mb-3">
                        <label class="form-label">Total Amount <span class="text-danger">*</span></label>
                        <input type="number" class="form-control" name="total_amt" required autocomplete="off">
                    </div>
                </div>

                <!-- Instalment Amount -->
                <div class="col-md-6">
                    <div class="mb-3">
                        <label class="form-label">Instalment Amount <span class="text-danger">*</span></label>
                        <input type="number" class="form-control" name="instalment_amt" required autocomplete="off">
                    </div>
                </div>

                <!-- Paid Amount -->
                <div class="col-md-6">
                    <div class="mb-3">
                        <label class="form-label">Paid Amount <span class="text-danger">*</span></label>
                        <input type="number" class="form-control" name="paid_amt" required autocomplete="off">
                    </div>
                </div>

                <!-- Total No of Instalments -->
                <div class="col-md-6">
                    <div class="mb-3">
                        <label class="form-label">Total No of Instalments <span class="text-danger">*</span></label>
                        <input type="number" class="form-control" name="total_no_instalment" required
                            autocomplete="off">
                    </div>
                </div>

                <!-- Balance No of Instalments -->
                <div class="col-md-6">
                    <div class="mb-3">
                        <label class="form-label">Balance No of Instalments <span class="text-danger">*</span></label>
                        <input type="number" class="form-control" name="balance_no_instalment" required
                            autocomplete="off">
                    </div>
                </div>

                <!-- Repayment From -->
                <div class="col-md-6">
                    <div class="mb-3">
                        <label class="form-label">Repayment From <span class="text-danger">*</span></label>
                        <div class="icon-form">
                            <span class="form-icon"><i class="ti ti-calendar-check"></i></span>
                            <input type="text" class="form-control datetimepicker" name="repayment_from"
                                placeholder="DD/MM/YYYY" required>
                        </div>
                    </div>
                </div>

                <!-- Next Repayment Date -->
                <div class="col-md-6">
                    <div class="mb-3">
                        <label class="form-label">Next Repayment Date <span class="text-danger">*</span></label>
                        <div class="icon-form">
                            <span class="form-icon"><i class="ti ti-calendar-check"></i></span>
                            <input type="text" class="form-control datetimepicker" name="next_repayment_date"
                                placeholder="DD/MM/YYYY" required>
                        </div>
                    </div>
                </div>

                <!-- Default Count -->
                <div class="col-md-6">
                    <div class="mb-3">
                        <label class="form-label">Default Count <span class="text-danger">*</span></label>
                        <input type="number" class="form-control" name="default_count" required autocomplete="off">
                    </div>
                </div>

                <!-- Waiver Amount -->
                <div class="col-md-6">
                    <div class="mb-3">
                        <label class="form-label">Waiver Amount <span class="text-danger">*</span></label>
                        <input type="number" class="form-control" name="waiver_amt" required autocomplete="off">
                    </div>
                </div>

                <!-- Waiver Date -->
                <div class="col-md-6">
                    <div class="mb-3">
                        <label class="form-label">Waiver Date <span class="text-danger">*</span></label>
                        <div class="icon-form">
                            <span class="form-icon"><i class="ti ti-calendar-check"></i></span>
                            <input type="text" class="form-control datetimepicker" name="waiver_date"
                                placeholder="DD/MM/YYYY" required>
                        </div>
                    </div>
                </div>

                <!-- Is Active -->
                <div class="col-md-12">
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" name="is_active" value="true" id="is_active">
                        <label class="form-check-label" for="is_active">Is Active</label>
                    </div>
                </div>
                <!-- Form Submit Buttons -->
                <div class="col-md-12 text-end mt-3">
                    <button type="button" data-bs-dismiss="offcanvas" class="btn btn-light me-2">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Changes</button>
                </div>
            </div>
        </form>
    </div>
</div>
<!-- /Edit Contracts -->

<!-- Delete Contracts -->
<div class="modal fade" id="delete_contracts" role="dialog">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-body">
                <div class="text-center">
                    <div class="avatar avatar-xl bg-danger-light rounded-circle mb-3">
                        <i class="ti ti-trash-x fs-36 text-danger"></i>
                    </div>
                    <h4 class="mb-2">Remove Advance Master</h4>
                    <p class="mb-0">Are you sure you want to remove<br> advance master you selected.</p>
                    <div class="d-flex align-items-center justify-content-center mt-4">
                        <a href="#" class="btn btn-light me-2" data-bs-dismiss="modal">Cancel</a>
                        <a href="#" class="btn btn-danger">Yes, Delete it</a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener("DOMContentLoaded", function () {
        document.querySelectorAll('.delete-button').forEach(button => {
            button.addEventListener('click', function () {
                const advanceId = this.getAttribute('data-id'); // Get the record ID
                
                // Show the confirmation modal
                const modal = new bootstrap.Modal(document.getElementById('delete_contracts'));
                modal.show();
                
                const confirmDeleteButton = document.querySelector('#delete_contracts .btn-danger');
                confirmDeleteButton.addEventListener('click', function () {
                    fetch(`/toggle-active-status/${advanceId}/`, {
                        method: 'POST',
                        headers: {
                            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                        }
                    })
                        .then(response => response.json())
                        .then(data => {
                            if (data.success) {
                                // Optionally, update the table dynamically
                                const row = button.closest("tr");
                                row.querySelector('.badge-status').className = 'badge badge-pill badge-status bg-danger';
                                row.querySelector('.badge-status').textContent = 'Inactive';
                            } else {
                                console.error("Error:", data.message);
                            }
                        })
                        .catch(error => console.error("Error:", error));
                    
                    // Close the modal after action
                    modal.hide();
                }, { once: true }); // Ensure the event listener is attached only once
            });
        });
    });
        
    
</script>


<script>
    document.addEventListener('DOMContentLoaded', function () {
        const editButtons = document.querySelectorAll('.edit-button');
        const editModal = document.querySelector('#offcanvas_edit');
        const updateForm = editModal.querySelector('form');

        // Attach click event listeners to edit buttons
        editButtons.forEach(button => {
            button.addEventListener('click', function () {
                const advanceId = this.getAttribute('data-id'); // Fetch Advance ID

                // Fetch advance details from the server
                fetch(`/get-advance-details/${advanceId}/`)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }
                        return response.json();
                    })
                    .then(data => {
                        if (!data.error) {
                            // Populate modal fields
                            for (const [key, value] of Object.entries(data)) {
                                const field = editModal.querySelector(`[name="${key}"]`);
                                if (field) {
                                    if (field.type === 'checkbox') {
                                        field.checked = value;
                                    } else {
                                        field.value = value;
                                    }
                                }
                            }

                            // Trigger select2 change events to display proper values in dropdowns
                            $('#offcanvas_edit .select2').trigger('change');
                        }
                    })
                    .catch(error => console.error('Error fetching advance details:', error));
            });
        });

        // Handle form submission for updating the record
        updateForm.addEventListener('submit', function (e) {
            e.preventDefault(); // Prevent default form submission behavior

            const formData = new FormData(updateForm); // Collect form data
            const advanceId = formData.get('advance_id');

            fetch(`/update-advance-details/${advanceId}/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': formData.get('csrfmiddlewaretoken'),
                },
                body: formData,
            })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.success) {
                        location.reload(); // Reload the page to reflect updated data
                    }
                })
                .catch(error => console.error('Error updating advance details:', error));
        });

        // Initialize Select2 and DatePicker components
        $(document).on('shown.bs.offcanvas', '#offcanvas_edit', function () {
            $('.select2', this).select2({ dropdownParent: $(this), width: '100%' });
            $('.datetimepicker', this).datepicker({ format: 'dd/mm/yyyy', autoclose: true });
        });

        // Clear modal data on close
        $(editModal).on('hidden.bs.offcanvas', function () {
            updateForm.reset(); // Clear form fields
            $('#offcanvas_edit .select2').val(null).trigger('change'); // Reset dropdowns
            $(this).find('.is-invalid').removeClass('is-invalid'); // Clear validation feedback
        });
    });
</script>


<script>
    $(document).ready(function () {
        $('.datetimepicker').datepicker({
            format: 'dd/mm/yyyy',
            autoclose: true
        });

        $('form').on('submit', function (e) {
            var isValid = true;
            $(this).find('input, select').each(function () {
                if ($(this).prop('required') && $(this).val() === '') {
                    $(this).addClass('is-invalid');
                    isValid = false;
                } else {
                    $(this).removeClass('is-invalid');
                }
            });
            if (!isValid) {
                e.preventDefault();
            }
        });
    });
</script>
