{% load static %}


<!-- Add New Contracts -->
<div class="offcanvas offcanvas-end offcanvas-large" tabindex="-1" id="offcanvas_add">
    <div class="offcanvas-header border-bottom">
        <h4>Advance Master</h4>
        <button type="button"
            class="btn-close custom-btn-close border p-1 me-0 d-flex align-items-center justify-content-center rounded-circle"
            data-bs-dismiss="offcanvas" aria-label="Close">
            <i class="ti ti-x"></i>
        </button>
    </div>
    <div class="offcanvas-body">
        <form method="post" action="{% url 'advance_master' %}">
            {% csrf_token %}
            <!-- Form fields -->
            <div class="row">
                <!-- Employee Code -->
                <div class="col-md-6">
                    <div class="mb-3">
                        <label class="col-form-label">Employee Code <span class="text-danger">*</span></label>
                        <select class="select2" name="emp_code" required>
                            <option value="">Choose</option>
                            {% for emp in employee_data %}
                                <option value="{{ emp.emp_code }}">{{ emp.emp_code }} - {{ emp.emp_name }}</option>
                            {% endfor %}
                        </select>                        
                    </div>
                </div>

                <!-- Advance Code -->
                <div class="col-md-6">
                    <div class="mb-3">
                        <label class="col-form-label">Advance Code <span class="text-danger">*</span></label>
                        <select class="select2" name="advance_code" required>
                            <option value="">Choose</option>
                            {% for deduction in deductions_data %}
                                <option value="{{ deduction.base_value }}">{{ deduction.base_value }} - {{ deduction.base_description }}</option>
                            {% endfor %}
                        </select>                        
                    </div>
                </div>

                <!-- Advance Reference -->
                <div class="col-md-6">
                    <div class="mb-3">
                        <label class="col-form-label">Advance Reference <span class="text-danger">*</span></label>
                        <textarea class="form-control" name="advance_reference" rows="2" required></textarea>
                    </div>
                </div>

                <!-- Reference Date -->
                <div class="col-md-6">
                    <div class="mb-3">
                        <label class="col-form-label">Reference Date <span class="text-danger">*</span></label>
                        <input type="date" class="form-control datetimepicker" name="reference_date"
                            placeholder="DD-MM-YYYY" required>
                    </div>
                </div>
{% comment %} 
                <!-- Total Amount -->
                <div class="col-md-6">
                    <div class="mb-3">
                        <label class="col-form-label">Total Amount <span class="text-danger">*</span></label>
                        <input type="number" class="form-control" name="total_amt" required>
                    </div>
                </div>

                <!-- Installment Amount -->
                <div class="col-md-6">
                    <div class="mb-3">
                        <label class="col-form-label">Installment Amount <span class="text-danger">*</span></label>
                        <input type="number" class="form-control" name="instalment_amt" required>
                    </div>
                </div>

                <!-- Paid Amount -->
                <div class="col-md-6">
                    <div class="mb-3">
                        <label class="col-form-label">Paid Amount <span class="text-danger">*</span></label>
                        <input type="number" class="form-control" name="paid_amt" required>
                    </div>
                </div>

                <!-- Total No. of Installments -->
                <div class="col-md-6">
                    <div class="mb-3">
                        <label class="col-form-label">Total No. of Installments <span
                                class="text-danger">*</span></label>
                        <input type="number" class="form-control" name="total_no_instalment" required>
                    </div>
                </div>

                <!-- Balance No. of Installments -->
                <div class="col-md-6">
                    <div class="mb-3">
                        <label class="col-form-label">Balance No. of Installments <span
                                class="text-danger">*</span></label>
                        <input type="number" class="form-control" name="balance_no_instalment" required>
                    </div>
                </div> {% endcomment %}
                <div class="col-md-6">
                    <div class="mb-3">
                        <label class="col-form-label">Total Amount <span class="text-danger">*</span></label>
                        <input type="number" class="form-control" id="totalAmount" name="total_amt" required>
                    </div>
                </div>

                <!-- Installment Amount -->
                <div class="col-md-6">
                    <div class="mb-3">
                        <label class="col-form-label">Installment Amount <span class="text-danger">*</span></label>
                        <input type="number" class="form-control" id="installmentAmount" name="instalment_amt" required>
                    </div>
                </div>

                <!-- Paid Amount -->
                <div class="col-md-6">
                    <div class="mb-3">
                        <label class="col-form-label">Paid Amount <span class="text-danger">*</span></label>
                        <input type="number" class="form-control" id="paidAmount" name="paid_amt" value="0" readonly>
                    </div>
                </div>

                <!-- Total No. of Installments -->
                <div class="col-md-6">
                    <div class="mb-3">
                        <label class="col-form-label">Total No. of Installments <span class="text-danger">*</span></label>
                        <input type="number" class="form-control" id="totalInstallments" name="total_no_instalment" readonly>
                    </div>
                </div>

                <!-- Balance No. of Installments -->
                <div class="col-md-6">
                    <div class="mb-3">
                        <label class="col-form-label">Balance No. of Installments <span
                                class="text-danger">*</span></label>
                        <input type="number" class="form-control" id="balanceInstallments" name="balance_no_instalment" readonly>
                    </div>
                </div>

                <!-- Repayment From -->
                <div class="col-md-6">
                    <div class="mb-3">
                        <label class="col-form-label">Repayment From <span class="text-danger">*</span></label>
                        <input type="date" class="form-control datetimepicker" name="repayment_from"
                            placeholder="DD-MM-YYYY" required>
                    </div>
                </div>

                <!-- Next Repayment Date -->
                <div class="col-md-6">
                    <div class="mb-3">
                        <label class="col-form-label">Next Repayment Date <span class="text-danger">*</span></label>
                        <input type="date" class="form-control datetimepicker" name="next_repayment_date"
                            placeholder="DD-MM-YYYY" required>
                    </div>
                </div>

                <!-- Default Count -->
                <!-- <div class="col-md-6">
                    <div class="mb-3">
                        <label class="col-form-label">Default Count <span class="text-danger">*</span></label>
                        <input type="number" class="form-control" name="default_count" required>
                    </div>
                </div> -->

                <!-- Waiver Amount -->
                <!-- <div class="col-md-6">
                    <div class="mb-3">
                        <label class="col-form-label">Waiver Amount <span class="text-danger">*</span></label>
                        <input type="number" class="form-control" name="waiver_amt" required>
                    </div>
                </div> -->

                <!-- Waiver Date -->
                <!-- <div class="col-md-6">
                    <div class="mb-3">
                        <label class="col-form-label">Waiver Date</label>
                        <input type="text" class="form-control datetimepicker" name="waiver_date"
                            placeholder="DD-MM-YYYY">
                    </div>
                </div> -->
            </div>

            <!-- Is Active -->
            <div class="form-check">
                <input type="checkbox" class="form-check-input" name="is_active" value="true" id="is_active" checked>
                <label class="form-check-label" for="is_active">Is Active</label>
            </div>

            <!-- Buttons -->
            <div class="mt-3 d-flex justify-content-end">
                <button type="button" class="btn btn-light me-2" data-bs-dismiss="offcanvas">Cancel</button>
                <button type="submit" class="btn btn-primary">Create</button>
            </div>
        </form>
    </div>
</div>

<!-- /Add New Contracts -->

<!-- Edit Contract -->
<div class="offcanvas offcanvas-end offcanvas-large" tabindex="-1" id="offcanvas_edit">
    <div class="offcanvas-header border-bottom">
        <h4>Edit Contract</h4>
        <button type="button"
            class="btn-close custom-btn-close border p-1 me-0 d-flex align-items-center justify-content-center rounded-circle"
            data-bs-dismiss="offcanvas" aria-label="Close">
            <i class="ti ti-x"></i>
        </button>
    </div>
    <div class="offcanvas-body">
        <form method="post" action="#">
            {% csrf_token %}
            <input type="hidden" name="advance_id" id="edit-advance-id" value="">

            <div class="row">
                <!-- Employee Code -->
                <div class="col-md-6">
                    <div class="mb-3">
                        <label class="form-label">Employee Code <span class="text-danger">*</span></label>
                        <select class="select2" name="emp_code" required>
                            <option value="">Choose</option>
                            {% for emp in employee_data %}
                                <option value="{{ emp.emp_code }}">{{ emp.emp_code }} - {{ emp.emp_name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>

                <!-- Advance Code -->
                <div class="col-md-6">
                    <div class="mb-3">
                        <label class="form-label">Advance Code <span class="text-danger">*</span></label>
                        <select class="select2" name="advance_code" required>
                            <option value="">Choose</option>
                            {% for deduction in deductions_data %}
                                <option value="{{ deduction.base_value }}">{{ deduction.base_value }} - {{ deduction.base_description }}</option>
                            {% endfor %}
                        </select>                        
                    </div>
                </div>

                <!-- Advance Reference -->
                <div class="col-md-6">
                    <div class="mb-3">
                        <label class="form-label">Advance Reference <span class="text-danger">*</span></label>
                        <textarea class="form-control" name="advance_reference" rows="3" required></textarea>
                    </div>
                </div>

                <!-- Reference Date -->
                <div class="col-md-6">
                    <div class="mb-3">
                        <label class="form-label">Reference Date <span class="text-danger">*</span></label>
                        <div class="icon-form">
                            <span class="form-icon"><i class="ti ti-calendar-check"></i></span>
                            <input type="date" class="form-control datetimepicker" name="reference_date"
                                placeholder="DD/MM/YYYY" required>
                        </div>
                    </div>
                </div>
{% comment %} 
                <!-- Total Amount -->
                <div class="col-md-6">
                    <div class="mb-3">
                        <label class="form-label">Total Amount <span class="text-danger">*</span></label>
                        <input type="number" class="form-control" name="total_amt" required autocomplete="off">
                    </div>
                </div>

                <!-- Instalment Amount -->
                <div class="col-md-6">
                    <div class="mb-3">
                        <label class="form-label">Instalment Amount <span class="text-danger">*</span></label>
                        <input type="number" class="form-control" name="instalment_amt" required autocomplete="off">
                    </div>
                </div>

                <!-- Paid Amount -->
                <div class="col-md-6">
                    <div class="mb-3">
                        <label class="form-label">Paid Amount <span class="text-danger">*</span></label>
                        <input type="number" class="form-control" name="paid_amt" required autocomplete="off">
                    </div>
                </div>

                <!-- Total No of Instalments -->
                <div class="col-md-6">
                    <div class="mb-3">
                        <label class="form-label">Total No of Instalments <span class="text-danger">*</span></label>
                        <input type="number" class="form-control" name="total_no_instalment" required
                            autocomplete="off">
                    </div>
                </div>

                <!-- Balance No of Instalments -->
                <div class="col-md-6">
                    <div class="mb-3">
                        <label class="form-label">Balance No of Instalments <span class="text-danger">*</span></label>
                        <input type="number" class="form-control" name="balance_no_instalment" required
                            autocomplete="off">
                    </div>
                </div> {% endcomment %}

                <div class="col-md-6">
                    <div class="mb-3">
                        <label class="col-form-label">Total Amount <span class="text-danger">*</span></label>
                        <input type="number" class="form-control" id="totalAmount" name="total_amt" required>
                    </div>
                </div>

                <!-- Installment Amount -->
                <div class="col-md-6">
                    <div class="mb-3">
                        <label class="col-form-label">Installment Amount <span class="text-danger">*</span></label>
                        <input type="number" class="form-control" id="installmentAmount" name="instalment_amt" required>
                    </div>
                </div>

                <!-- Paid Amount -->
                <div class="col-md-6">
                    <div class="mb-3">
                        <label class="col-form-label">Paid Amount <span class="text-danger">*</span></label>
                        <input type="number" class="form-control" id="paidAmount" name="paid_amt" value="0" readonly>
                    </div>
                </div>

                <!-- Total No. of Installments -->
                <div class="col-md-6">
                    <div class="mb-3">
                        <label class="col-form-label">Total No. of Installments <span class="text-danger">*</span></label>
                        <input type="number" class="form-control" id="totalInstallments" name="total_no_instalment" readonly>
                    </div>
                </div>

                <!-- Balance No. of Installments -->
                <div class="col-md-6">
                    <div class="mb-3">
                        <label class="col-form-label">Balance No. of Installments <span
                                class="text-danger">*</span></label>
                        <input type="number" class="form-control" id="balanceInstallments" name="balance_no_instalment" readonly>
                    </div>
                </div>

                <!-- Repayment From -->
                <div class="col-md-6">
                    <div class="mb-3">
                        <label class="form-label">Repayment From <span class="text-danger">*</span></label>
                        <div class="icon-form">
                            <span class="form-icon"><i class="ti ti-calendar-check"></i></span>
                            <input type="date" class="form-control datetimepicker" name="repayment_from"
                                placeholder="DD/MM/YYYY" required>
                        </div>
                    </div>
                </div>

                <!-- Next Repayment Date -->
                <div class="col-md-6">
                    <div class="mb-3">
                        <label class="form-label">Next Repayment Date <span class="text-danger">*</span></label>
                        <div class="icon-form">
                            <span class="form-icon"><i class="ti ti-calendar-check"></i></span>
                            <input type="date" class="form-control datetimepicker" name="next_repayment_date"
                                placeholder="DD/MM/YYYY" required>
                        </div>
                    </div>
                </div>

                <!-- Default Count -->
                <!-- <div class="col-md-6">
                    <div class="mb-3">
                        <label class="form-label">Default Count <span class="text-danger">*</span></label>
                        <input type="number" class="form-control" name="default_count" required autocomplete="off">
                    </div>
                </div> -->

                <!-- Waiver Amount -->
                <!-- <div class="col-md-6">
                    <div class="mb-3">
                        <label class="form-label">Waiver Amount <span class="text-danger">*</span></label>
                        <input type="number" class="form-control" name="waiver_amt" required autocomplete="off">
                    </div>
                </div> -->

                <!-- Waiver Date -->
                <!-- <div class="col-md-6">
                    <div class="mb-3">
                        <label class="form-label">Waiver Date <span class="text-danger">*</span></label>
                        <div class="icon-form">
                            <span class="form-icon"><i class="ti ti-calendar-check"></i></span>
                            <input type="text" class="form-control datetimepicker" name="waiver_date"
                                placeholder="DD/MM/YYYY" required>
                        </div>
                    </div>
                </div> -->

                <!-- Is Active -->
                <div class="col-md-12">
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" name="is_active" value="true" id="is_active">
                        <label class="form-check-label" for="is_active">Is Active</label>
                    </div>
                </div>
                <!-- Form Submit Buttons -->
                <div class="col-md-12 text-end mt-3">
                    <button type="button" data-bs-dismiss="offcanvas" class="btn btn-light me-2">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Changes</button>
                </div>
            </div>
        </form>
    </div>
</div>
<!-- /Edit Contracts -->

<!-- Delete Contracts -->
<div class="modal fade" id="delete_contracts" role="dialog">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-body">
                <div class="text-center">
                    <div class="avatar avatar-xl bg-danger-light rounded-circle mb-3">
                        <i class="ti ti-trash-x fs-36 text-danger"></i>
                    </div>
                    <h4 class="mb-2">Remove Advance Master</h4>
                    <p class="mb-0">Are you sure you want to remove<br> advance master you selected.</p>
                    <div class="d-flex align-items-center justify-content-center mt-4">
                        <a href="#" class="btn btn-light me-2" data-bs-dismiss="modal">Cancel</a>
                        <a href="#" class="btn btn-danger">Yes, Delete it</a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!--Delete script-->
<script>
    document.addEventListener("DOMContentLoaded", function () {
        document.querySelectorAll('.delete-button').forEach(button => {
            button.addEventListener('click', function () {
                const advanceId = this.getAttribute('data-id'); // Get the record ID
                
                // Show the confirmation modal
                const modal = new bootstrap.Modal(document.getElementById('delete_contracts'));
                modal.show();
                
                const confirmDeleteButton = document.querySelector('#delete_contracts .btn-danger');
                confirmDeleteButton.addEventListener('click', function () {
                    fetch(`/toggle-active-status/${advanceId}/`, {
                        method: 'POST',
                        headers: {
                            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                        }
                    })
                        .then(response => response.json())
                        .then(data => {
                            if (data.success) {
                                // Optionally, update the table dynamically
                                const row = button.closest("tr");
                                row.querySelector('.badge-status').className = 'badge badge-pill badge-status bg-danger';
                                row.querySelector('.badge-status').textContent = 'Inactive';
                            } else {
                                console.error("Error:", data.message);
                            }
                        })
                        .catch(error => console.error("Error:", error));
                    
                    // Close the modal after action
                    modal.hide();
                }, { once: true }); // Ensure the event listener is attached only once
            });
        });
    });
        
    
</script>

<!--date-->
<script>
    $(document).ready(function () {
        $('.datetimepicker').datepicker({
            format: 'dd/mm/yyyy',
            autoclose: true
        });

        $('form').on('submit', function (e) {
            var isValid = true;
            $(this).find('input, select').each(function () {
                if ($(this).prop('required') && $(this).val() === '') {
                    $(this).addClass('is-invalid');
                    isValid = false;
                } else {
                    $(this).removeClass('is-invalid');
                }
            });
            if (!isValid) {
                e.preventDefault();
            }
        });
    });
</script> 



<!--Add Script-->
<script>
    document.addEventListener('DOMContentLoaded', function () {
    const totalAmountInput = document.getElementById('totalAmount');
    const installmentAmountInput = document.getElementById('installmentAmount');
    const paidAmountInput = document.getElementById('paidAmount');
    const totalInstallmentsInput = document.getElementById('totalInstallments');
    const balanceInstallmentsInput = document.getElementById('balanceInstallments');

    // Function to update the calculated fields
    function updateFields() {
        const totalAmount = parseFloat(totalAmountInput.value) || 0;
        const installmentAmount = parseFloat(installmentAmountInput.value) || 0;
        const paidAmount = parseFloat(paidAmountInput.value) || 0;

        if (installmentAmount > 0) {
            const totalInstallments = Math.ceil(totalAmount / installmentAmount);
            const balanceInstallments = totalInstallments - Math.floor(paidAmount / installmentAmount);

            totalInstallmentsInput.value = totalInstallments || 0;
            balanceInstallmentsInput.value = Math.max(balanceInstallments, 0); // Ensure non-negative values
        } else {
            totalInstallmentsInput.value = 0;
            balanceInstallmentsInput.value = 0;
        }
    }

    // Attach event listeners to Total Amount and Installment Amount fields
    totalAmountInput.addEventListener('input', updateFields);
    installmentAmountInput.addEventListener('input', updateFields);

    // Simulate monthly payments (e.g., dynamic updates to Paid Amount)
    function payInstallment(paymentAmount) {
        const currentPaidAmount = parseFloat(paidAmountInput.value) || 0;
        paidAmountInput.value = currentPaidAmount + paymentAmount;
        updateFields(); // Recalculate fields after payment
    }

    // Example: Call payInstallment(100) when a payment is made
    // payInstallment(100);
     });
</script>         

{% comment %} <!--Edit Script-->
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const editModal = document.querySelector('#offcanvas_edit');
        const totalAmountInput = editModal.querySelector('#totalAmount');
        const installmentAmountInput = editModal.querySelector('#installmentAmount');
        const paidAmountInput = editModal.querySelector('#paidAmount');
        const totalInstallmentsInput = editModal.querySelector('#totalInstallments');
        const balanceInstallmentsInput = editModal.querySelector('#balanceInstallments');
        const editForm = editModal.querySelector('form');
    
        // Function to populate fields with server data
        function populateEditModal(advanceId) {
            fetch(`/get-advance-details/${advanceId}/`) // Replace with your endpoint
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        console.error('Error fetching advance details:', data.error);
                    } else {
                        for (const [key, value] of Object.entries(data)) {
                            const field = editModal.querySelector(`[name="${key}"]`);
                            if (field) {
                                if (field.type === 'checkbox') {
                                    field.checked = value;
                                } else {
                                    field.value = value;
                                }
                            }
                        }
                        updateFields(); // Recalculate fields when data loads
                    }
                })
                .catch(error => console.error('Error fetching advance details:', error));
        }
    
        // Function to calculate and update fields dynamically
        function updateFields() {
            const totalAmount = parseFloat(totalAmountInput.value) || 0;
            const installmentAmount = parseFloat(installmentAmountInput.value) || 0;
            const paidAmount = parseFloat(paidAmountInput.value) || 0;
    
            if (installmentAmount > 0) {
                const totalInstallments = Math.ceil(totalAmount / installmentAmount);
                const balanceInstallments = totalInstallments - Math.floor(paidAmount / installmentAmount);
    
                totalInstallmentsInput.value = totalInstallments || 0;
                balanceInstallmentsInput.value = Math.max(balanceInstallments, 0); // Avoid negative balance
            } else {
                totalInstallmentsInput.value = 0;
                balanceInstallmentsInput.value = 0;
            }
        }
    
        // Event listeners for dynamic calculations
        totalAmountInput.addEventListener('input', updateFields);
        installmentAmountInput.addEventListener('input', updateFields);
    
        // Trigger modal population on edit button click
        document.querySelectorAll('.edit-button').forEach(button => {
            button.addEventListener('click', function () {
                const advanceId = this.getAttribute('data-id'); // Replace with the appropriate attribute
                editModal.querySelector('#edit-advance-id').value = advanceId;
                populateEditModal(advanceId);
            });
        });
    
        // Clear modal fields on close
        $(editModal).on('hidden.bs.offcanvas', function () {
            editForm.reset(); // Reset form fields
            $(editModal).find('.select2').val(null).trigger('change'); // Clear select2 dropdowns
            $(editModal).find('.is-invalid').removeClass('is-invalid'); // Clear validation states
        });
    
        // Initialize datepickers and select2
        $(document).on('shown.bs.offcanvas', '#offcanvas_edit', function () {
            $('.select2', this).select2({ dropdownParent: $(this), width: '100%' });
            $('.datetimepicker', this).datepicker({ format: 'dd/mm/yyyy', autoclose: true });
        });
    
        // Form submission handler
        editForm.addEventListener('submit', function (e) {
            e.preventDefault(); // Prevent form submission
            const formData = new FormData(editForm);
            const advanceId = formData.get('advance_id');
    
            fetch(`/update-advance-details/${advanceId}/`, {
                method: 'POST',
                headers: { 'X-CSRFToken': formData.get('csrfmiddlewaretoken') },
                body: formData
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        location.reload(); // Reload the page after successful update
                    } else {
                        console.error('Error updating record:', data.message);
                    }
                })
                .catch(error => console.error('Error updating record:', error));
        });
    });
</script>     {% endcomment %}

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const editModal = document.querySelector('#offcanvas_edit');
        const totalAmountInput = editModal.querySelector('#totalAmount');
        const installmentAmountInput = editModal.querySelector('#installmentAmount');
        const paidAmountInput = editModal.querySelector('#paidAmount');
        const totalInstallmentsInput = editModal.querySelector('#totalInstallments');
        const balanceInstallmentsInput = editModal.querySelector('#balanceInstallments');
        const editForm = editModal.querySelector('form');
    
        // Function to populate fields with server data
        function populateEditModal(advanceId) {
            fetch(`/get-advance-details/${advanceId}/`) // Replace with your endpoint
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        console.error('Error fetching advance details:', data.error);
                    } else {
                        for (const [key, value] of Object.entries(data)) {
                            const field = editModal.querySelector(`[name="${key}"]`);
                            if (field) {
                                if (field.tagName === 'SELECT') {
                                    // Match the value to one of the options
                                    const option = Array.from(field.options).find(opt => opt.value === value);
                                    if (option) {
                                        field.value = value; // Set the selected value
                                        $(field).trigger('change'); // Required for select2 fields
                                    }
                                } else if (field.type === 'checkbox') {
                                    field.checked = value;
                                } else {
                                    field.value = value;
                                }
                            }
                        }
                        updateFields(); // Recalculate fields when data loads
                    }
                })
                .catch(error => console.error('Error fetching advance details:', error));
        }
    
        // Function to calculate and update fields dynamically
        function updateFields() {
            const totalAmount = parseFloat(totalAmountInput.value) || 0;
            const installmentAmount = parseFloat(installmentAmountInput.value) || 0;
            const paidAmount = parseFloat(paidAmountInput.value) || 0;
    
            if (installmentAmount > 0) {
                const totalInstallments = Math.ceil(totalAmount / installmentAmount);
                const balanceInstallments = totalInstallments - Math.floor(paidAmount / installmentAmount);
    
                totalInstallmentsInput.value = totalInstallments || 0;
                balanceInstallmentsInput.value = Math.max(balanceInstallments, 0); // Avoid negative balance
            } else {
                totalInstallmentsInput.value = 0;
                balanceInstallmentsInput.value = 0;
            }
        }
    
        // Event listeners for dynamic calculations
        totalAmountInput.addEventListener('input', updateFields);
        installmentAmountInput.addEventListener('input', updateFields);
    
        // Trigger modal population on edit button click
        document.querySelectorAll('.edit-button').forEach(button => {
            button.addEventListener('click', function () {
                const advanceId = this.getAttribute('data-id'); // Replace with the appropriate attribute
                editModal.querySelector('#edit-advance-id').value = advanceId;
                populateEditModal(advanceId);
            });
        });
    
        // Clear modal fields on close
        $(editModal).on('hidden.bs.offcanvas', function () {
            editForm.reset(); // Reset form fields
            $(editModal).find('.select2').val(null).trigger('change'); // Clear select2 dropdowns
            $(editModal).find('.is-invalid').removeClass('is-invalid'); // Clear validation states
        });
    
        // Initialize datepickers and select2
        $(document).on('shown.bs.offcanvas', '#offcanvas_edit', function () {
            $('.select2', this).select2({ dropdownParent: $(this), width: '100%' });
            $('.datetimepicker', this).datepicker({ format: 'dd/mm/yyyy', autoclose: true });
        });
    
        // Form submission handler
        editForm.addEventListener('submit', function (e) {
            e.preventDefault(); // Prevent form submission
            const formData = new FormData(editForm);
            const advanceId = formData.get('advance_id');
    
            fetch(`/update-advance-details/${advanceId}/`, {
                method: 'POST',
                headers: { 'X-CSRFToken': formData.get('csrfmiddlewaretoken') },
                body: formData
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        location.reload(); // Reload the page after successful update
                    } else {
                        console.error('Error updating record:', data.message);
                    }
                })
                .catch(error => console.error('Error updating record:', error));
        });
    
        // Add Input Validation
        function validateInput() {
            const totalAmount = parseFloat(totalAmountInput.value) || 0;
            const installmentAmount = parseFloat(installmentAmountInput.value) || 0;
            if (installmentAmount > totalAmount) {
                alert('Installment Amount cannot exceed Total Amount!');
                installmentAmountInput.value = '';
            }
        }
        installmentAmountInput.addEventListener('input', validateInput);
    });
</script>
<script>
    // input number postive
    document.addEventListener( "input", function(e){
        if (e.target.tagName === "INPUT" && (e.target.type === "number")) {
            if(e.target.value < 0){
                alert('Accept only postive values')
                e.target.value = '';
            }
        }
    }
    )
</script>

