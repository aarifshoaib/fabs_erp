{% load static %}

<!-- Add Gratuity Settlement Modal -->
<div class="offcanvas offcanvas-end offcanvas-large" tabindex="-1" id="addGratuityModal" style="width: 1000px !important;">
    <div class="offcanvas-header border-bottom">
        <h4>Add Gratuity Settlement</h4>
        <button type="button" class="btn-close custom-btn-close border p-1 me-0 d-flex align-items-center justify-content-center rounded-circle" data-bs-dismiss="offcanvas" aria-label="Close">
            <i class="ti ti-x"></i>
        </button>
    </div>
    <div class="offcanvas-body">
        <form action="{% url 'add_gratuity' %}" method="POST" enctype="multipart/form-data">
            {% csrf_token %}
            <div class="row">
                <!-- Employee Code -->
                <div class="col-md-6">
                    <div class="mb-3">
                        <label class="col-form-label">Employee Code <span class="text-danger">*</span></label>
                        <select class="form-control employee_code" name="employee_code" required>
                            <option value="">Select Employee Code</option>
                            {% for employee in employee_data %}
                                <option value="{{ employee.emp_code }}">{{ employee.emp_code }} - {{ employee.emp_name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                <!-- Category -->
                <div class="col-md-6">
                    <div class="mb-3">
                        <label class="col-form-label">Category</label>
                        <input class="form-control category" name="category" type="text" readonly>
                    </div>
                </div>
                <!-- Designation -->
                <div class="col-md-6">
                    <div class="mb-3">
                        <label class="col-form-label">Designation</label>
                        <input class="form-control designation" name="designation" type="text" readonly>
                    </div>
                </div>
                <!-- Date of Joining -->
                <div class="col-md-6">
                    <div class="mb-3">
                        <label class="col-form-label">Date of Joining <span class="text-danger">*</span></label>
                        <input class="form-control date_of_joining" name="date_of_joining" type="date" readonly>
                    </div>
                </div>
                <!-- Date of Exit -->
                <div class="col-md-6">
                    <div class="mb-3">
                        <label class="col-form-label">Date of Exit <span class="text-danger">*</span></label>
                        <input class="form-control date_of_exit" name="date_of_exit" type="date" required>
                    </div>
                </div>
                <!-- Total Years of Service -->
                <div class="col-md-6">
                    <div class="mb-3">
                        <label class="col-form-label">Total Years of Service</label>
                        <input class="form-control total_years_of_service" name="total_years_of_service" type="text" readonly>
                    </div>
                </div>
                <!-- Acrude Days -->
                <div class="col-md-6">
                    <div class="mb-3">
                        <label class="col-form-label">Acrude Days</label>
                        <input class="form-control acrude_days" name="acrude_days" type="number" readonly>
                    </div>
                </div>
                <!-- Last Drawn Basic Salary -->
                <div class="col-md-6">
                    <div class="mb-3">
                        <label class="col-form-label">Last Drawn Basic Salary <span class="text-danger">*</span></label>
                        <input class="form-control last_drawn_basic_salary" name="last_drawn_basic_salary" type="number" step="0.01" required readonly>
                    </div>
                </div>
                <!-- Eligible Gratuity -->
                <div class="col-md-6">
                    <div class="mb-3">
                        <label class="col-form-label">Eligible Gratuity</label>
                        <input class="form-control eligible_gratuity" name="eligible_gratuity" type="number" step="0.01" readonly>
                    </div>
                </div>
                <!-- Loss of Pay Days -->
                <div class="col-md-6">
                    <div class="mb-3">
                        <label class="col-form-label">Loss of Pay Days</label>
                        <input class="form-control loss_of_pay_days" name="loss_of_pay_days" type="number" step="0.01">
                    </div>
                </div>
                <!-- Gratuity Status -->
                <div class="col-md-6">
                    <div class="mb-3">
                        <label class="col-form-label">Gratuity Status</label>
                        <select class="form-control" name="gratuity_status">
                            <option value="Pending">Pending</option>
                            <option value="Approved">Approved</option>
                            <option value="Paid">Paid</option>
                        </select>
                    </div>
                </div>
                <!-- Leave Balance (Days) -->
                <div class="col-md-6">
                    <div class="mb-3">
                        <label class="col-form-label">Leave Balance (Days)</label>
                        <input class="form-control leave_balance_days" name="leave_balance_days" type="number" step="0.01">
                    </div>
                </div>  
                <!-- Leave Encashment Amount -->
                <div class="col-md-6">
                    <div class="mb-3">
                        <label class="col-form-label">Leave Encashment Amount</label>
                        <input class="form-control leave_encashment_amount" name="leave_encashment_amount" type="number" step="0.01">
                    </div>
                </div>
                <!-- Bonus Amount -->
                <div class="col-md-6">
                    <div class="mb-3">
                        <label class="col-form-label">Bonus Amount</label>
                        <input class="form-control bonus_amount" name="bonus_amount" type="number" step="0.01">
                    </div>
                </div>
                <!-- Other Allowances -->
                <div class="col-md-6">
                    <div class="mb-3">
                        <label class="col-form-label">Other Allowances</label>
                        <input class="form-control other_allowances" name="other_allowances" type="number" step="0.01">
                    </div>
                </div>  
                <!-- Deduction Amount -->
                <div class="col-md-6">
                    <div class="mb-3">
                        <label class="col-form-label">Deduction Amount</label>
                        <input class="form-control deduction" name="deductions" type="number" step="0.01">
                    </div>
                </div>
                <!-- Other Deduction -->
                <div class="col-md-6">
                    <div class="mb-3">
                        <label class="col-form-label">Other Deduction</label>
                        <input class="form-control other_deductions" name="other_deductions" type="number" step="0.01">
                    </div>
                </div>  
                <!-- Loan Recovery -->
                <div class="col-md-6">
                    <div class="mb-3">
                        <label class="col-form-label">Loan Recovery</label>
                        <input class="form-control loan_recovery" name="loan_recovery" type="number" step="0.01">
                    </div>
                </div>
                <!-- Notice Pay -->
                <div class="col-md-6">
                    <div class="mb-3">
                        <label class="col-form-label">Notice Pay</label>
                        <input class="form-control notice_pay" name="notice_pay" type="number" step="0.01">
                    </div>
                </div>
                <!-- Final Settlement Amount -->
                <div class="col-md-6">
                    <div class="mb-3">
                        <label class="col-form-label">Final Settlement Amount</label>
                        <input class="form-control final_settlement_amount" name="final_settlement_amount" type="number" step="0.01">
                    </div>
                </div>
                <!-- Payment Mode -->
                <div class="col-md-6">
                    <div class="mb-3">
                        <label class="col-form-label">Payment Mode</label>
                        <select class="form-control" name="payment_mode">
                            <option value="Bank Transfer">Bank Transfer</option>
                            <option value="Cheque">Cheque</option>
                            <option value="Cash">Cash</option>
                        </select>
                    </div>
                </div>
                <!-- Bank Name -->
                <div class="col-md-6">
                    <div class="mb-3">
                        <label class="col-form-label">Bank Name</label>
                        <input class="form-control" name="bank_name" type="text">
                    </div>
                </div>
                <!-- Bank Account No. -->
                <div class="col-md-6">
                    <div class="mb-3">
                        <label class="col-form-label">Bank Account No.</label>
                        <input class="form-control" name="bank_account_no" type="text">
                    </div>
                </div>
                <!-- Settlement Status -->
                <div class="col-md-6">
                    <div class="mb-3">
                        <label class="col-form-label">Settlement Status</label>
                        <select class="form-control" name="settlement_status">
                            <option value="Pending">Pending</option>
                            <option value="Approved">Approved</option>
                            <option value="Paid">Paid</option>
                        </select>
                    </div>
                </div>
                <!-- Settlement Date -->
                <div class="col-md-6">
                    <div class="mb-3">
                        <label class="col-form-label">Settlement Date</label>
                        <input class="form-control" name="settlement_date" type="date">
                    </div>
                </div>
                <!-- Supporting Docs -->
                <div class="col-md-6">
                    <div class="mb-3">
                        <label class="col-form-label">Supporting Documents</label>
                        <input class="form-control" name="supporting_docs" type="file" multiple>
                    </div>
                </div>
                <!-- Attachments -->
                <div class="col-md-6">
                    <div class="mb-3">
                        <label class="col-form-label">Attachments</label>
                        <input class="form-control" name="attachments" type="file" multiple>
                    </div>
                </div>
                <!-- Remarks -->
                <div class="col-md-12">
                    <div class="mb-3">
                        <label class="col-form-label">Remarks</label>
                        <textarea class="form-control" name="remarks" rows="2"></textarea>
                    </div>
                </div>
            </div>
            <!-- Buttons -->
            <div class="d-flex justify-content-end">
                <button type="button" class="btn btn-light me-2" data-bs-dismiss="offcanvas">Cancel</button>
                <button type="submit" class="btn btn-primary">Save</button>
            </div>
        </form>
    </div>
</div>
<!-- /Add Gratuity Settlement Modal -->

<!-- Edit Gratuity Settlement Modal -->
<div class="offcanvas offcanvas-end offcanvas-large" tabindex="-1" id="editGratuityModal" style="width: 1000px !important;">
    <div class="offcanvas-header border-bottom">
        <h4>Edit Gratuity Settlement</h4>
        <button type="button" class="btn-close custom-btn-close border p-1 me-0 d-flex align-items-center justify-content-center rounded-circle" data-bs-dismiss="offcanvas" aria-label="Close">
            <i class="ti ti-x"></i>
        </button>
    </div>
    <div class="offcanvas-body">
        <form id="edit_gratuity_form" action="{% url 'update_gratuity' %}" method="POST" enctype="multipart/form-data">
            {% csrf_token %}
            <input type="hidden" name="id" id="edit_id">
            <div class="row">
                <!-- Employee Code -->
                <div class="col-md-6">
                    <div class="mb-3">
                        <label class="col-form-label">Employee Code <span class="text-danger">*</span></label>
                        <select class="form-control employee_code" name="employee_code" id="edit_employee_code" required>
                            <option value="">Select Employee Code</option>
                            {% for employee in employee_data %}
                                <option value="{{ employee.emp_code }}">{{ employee.emp_code }} - {{ employee.emp_name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                <!-- Category -->
                <div class="col-md-6">
                    <div class="mb-3">
                        <label class="col-form-label">Category</label>
                        <input class="form-control category" name="category" id="edit_category" type="text" readonly>
                    </div>
                </div>
                <!-- Designation -->
                <div class="col-md-6">
                    <div class="mb-3">
                        <label class="col-form-label">Designation</label>
                        <input class="form-control designation" name="designation" id="edit_designation" type="text" readonly>
                    </div>
                </div>
                <!-- Date of Joining -->
                <div class="col-md-6">
                    <div class="mb-3">
                        <label class="col-form-label">Date of Joining <span class="text-danger">*</span></label>
                        <input class="form-control date_of_joining" name="date_of_joining" id="edit_date_of_joining" type="date" readonly>
                    </div>
                </div>
                <!-- Date of Exit -->
                <div class="col-md-6">
                    <div class="mb-3">
                        <label class="col-form-label">Date of Exit <span class="text-danger">*</span></label>
                        <input class="form-control date_of_exit" name="date_of_exit" id="edit_date_of_exit" type="date" required>
                    </div>
                </div>
                <!-- Total Years of Service -->
                <div class="col-md-6">
                    <div class="mb-3">
                        <label class="col-form-label">Total Years of Service</label>
                        <input class="form-control total_years_of_service" name="total_years_of_service" id="edit_total_years_of_service" type="text" readonly>
                    </div>
                </div>
                <!-- Acrude Days -->
                <div class="col-md-6">
                    <div class="mb-3">
                        <label class="col-form-label">Acrude Days</label>
                        <input class="form-control acrude_days" name="acrude_days" id="edit_acrude_days" type="number" readonly>
                    </div>
                </div>
                <!-- Last Drawn Basic Salary -->
                <div class="col-md-6">
                    <div class="mb-3">
                        <label class="col-form-label">Last Drawn Basic Salary <span class="text-danger">*</span></label>
                        <input class="form-control last_drawn_basic_salary" name="last_drawn_basic_salary" id="edit_last_drawn_basic_salary" type="number" step="0.01" required readonly>
                    </div>
                </div>
                <!-- Eligible Gratuity -->
                <div class="col-md-6">
                    <div class="mb-3">
                        <label class="col-form-label">Eligible Gratuity</label>
                        <input class="form-control eligible_gratuity" name="eligible_gratuity" id="edit_eligible_gratuity" type="number" step="0.01" readonly>
                    </div>
                </div>
                <!-- Loss of Pay Days -->
                <div class="col-md-6">
                    <div class="mb-3">
                        <label class="col-form-label">Loss of Pay Days</label>
                        <input class="form-control loss_of_pay_days" name="loss_of_pay_days" id="edit_loss_of_pay_days" type="number" step="0.01">
                    </div>
                </div>
                <!-- Gratuity Status -->
                <div class="col-md-6">
                    <div class="mb-3">
                        <label class="col-form-label">Gratuity Status</label>
                        <select class="form-control" name="gratuity_status" id="edit_gratuity_status">
                            <option value="Pending">Pending</option>
                            <option value="Approved">Approved</option>
                            <option value="Paid">Paid</option>
                        </select>
                    </div>
                </div>
                <!-- Leave Balance (Days) -->
                <div class="col-md-6">
                    <div class="mb-3">
                        <label class="col-form-label">Leave Balance (Days)</label>
                        <input class="form-control leave_balance" name="leave_balance" id="edit_leave_balance" type="number" step="0.01">
                    </div>
                </div>  
                <!-- Leave Encashment Amount -->
                <div class="col-md-6">
                    <div class="mb-3">
                        <label class="col-form-label">Leave Encashment Amount</label>
                        <input class="form-control leave_encashment_amount" name="leave_encashment_amount" id="edit_leave_encashment_amount" type="number" step="0.01">
                    </div>
                </div>
                <!-- Bonus Amount -->
                <div class="col-md-6">
                    <div class="mb-3">
                        <label class="col-form-label">Bonus Amount</label>
                        <input class="form-control bonus_amount" name="bonus_amount" id="edit_bonus_amount" type="number" step="0.01">
                    </div>
                </div>
                <!-- Other Allowances -->
                <div class="col-md-6">
                    <div class="mb-3">
                        <label class="col-form-label">Other Allowances</label>
                        <input class="form-control other_allowances" name="other_allowances" id="edit_other_allowances" type="number" step="0.01">
                    </div>
                </div>  
                <!-- Deduction Amount -->
                <div class="col-md-6">
                    <div class="mb-3">
                        <label class="col-form-label">Deduction Amount</label>
                        <input class="form-control deduction" name="deduction" id="edit_deduction" type="number" step="0.01">
                    </div>
                </div>
                <!-- Other Deduction -->
                <div class="col-md-6">
                    <div class="mb-3">
                        <label class="col-form-label">Other Deduction</label>
                        <input class="form-control other_deductions" name="other_deduction" id="edit_other_deduction" type="number" step="0.01">
                    </div>
                </div>  
                <!-- Loan Recovery -->
                <div class="col-md-6">
                    <div class="mb-3">
                        <label class="col-form-label">Loan Recovery</label>
                        <input class="form-control loan_recovery" name="loan_recovery" id="edit_loan_recovery" type="number" step="0.01">
                    </div>
                </div>
                <!-- Notice Pay -->
                <div class="col-md-6">
                    <div class="mb-3">
                        <label class="col-form-label">Notice Pay</label>
                        <input class="form-control notice_pay" name="notice_pay" id="edit_notice_pay" type="number" step="0.01">
                    </div>
                </div>
                <!-- Final Settlement Amount -->
                <div class="col-md-6">
                    <div class="mb-3">
                        <label class="col-form-label">Final Settlement Amount</label>
                        <input class="form-control final_settlement_amount" name="final_settlement_amount" id="edit_final_settlement_amount" type="number" step="0.01">
                    </div>
                </div>
                <!-- Payment Mode -->
                <div class="col-md-6">
                    <div class="mb-3">
                        <label class="col-form-label">Payment Mode</label>
                        <select class="form-control" name="payment_mode" id="edit_payment_mode">
                            <option value="Bank Transfer">Bank Transfer</option>
                            <option value="Cheque">Cheque</option>
                            <option value="Cash">Cash</option>
                        </select>
                    </div>
                </div>
                <!-- Bank Name -->
                <div class="col-md-6">
                    <div class="mb-3">
                        <label class="col-form-label">Bank Name</label>
                        <input class="form-control" name="bank_name" id="edit_bank_name" type="text">
                    </div>
                </div>
                <!-- Bank Account No. -->
                <div class="col-md-6">
                    <div class="mb-3">
                        <label class="col-form-label">Bank Account No.</label>
                        <input class="form-control" name="bank_account_no" id="edit_bank_account_no" type="text">
                    </div>
                </div>
                <!-- Settlement Status -->
                <div class="col-md-6">
                    <div class="mb-3">
                        <label class="col-form-label">Settlement Status</label>
                        <select class="form-control" name="settlement_status" id="edit_settlement_status">
                            <option value="Pending">Pending</option>
                            <option value="Approved">Approved</option>
                            <option value="Paid">Paid</option>
                        </select>
                    </div>
                </div>
                <!-- Settlement Date -->
                <div class="col-md-6">
                    <div class="mb-3">
                        <label class="col-form-label">Settlement Date</label>
                        <input class="form-control" name="settlement_date" id="edit_settlement_date" type="date">
                    </div>
                </div>
                <!-- Supporting Docs -->
                <div class="col-md-6">
                    <div class="mb-3">
                        <label class="col-form-label">Supporting Documents</label>
                        <input class="form-control" name="supporting_docs" id="edit_supporting_docs" type="file" multiple>
                    </div>
                </div>
                <!-- Attachments -->
                <div class="col-md-6">
                    <div class="mb-3">
                        <label class="col-form-label">Attachments</label>
                        <input class="form-control" name="attachments" id="edit_attachments" type="file" multiple>
                    </div>
                </div>
                <!-- Remarks -->
                <div class="col-md-12">
                    <div class="mb-3">
                        <label class="col-form-label">Remarks</label>
                        <textarea class="form-control" name="remarks" id="edit_remarks" rows="2"></textarea>
                    </div>
                </div>
            </div>
            <!-- Buttons -->
            <div class="d-flex justify-content-end">
                <button type="button" class="btn btn-light me-2" data-bs-dismiss="offcanvas">Cancel</button>
                <button type="submit" class="btn btn-primary edit-btn">Update</button>
            </div>
        </form>
    </div>
</div>
<!-- /Edit Gratuity Settlement Modal -->


<script>
    $(document).ready(function() {
        // Handle employee code selection
        $('.employee_code').on('change', function() {
            var employee_code = $(this).val();
            if (employee_code) {
                fetch_employee_details(employee_code);
            } else {
                clear_employee_fields();
            }
        });

        function fetch_employee_details(employee_code) {
            $.ajax({
                url: '{% url "get_emp_code" %}',
                type: 'GET',
                data: { emp_code: employee_code },
                success: function(response) {
                    if (response.status === 'success') {
                        $('.category').val(response.data.category);
                        $('.designation').val(response.data.designation);
                        $('.date_of_joining').val(response.data.date_of_joining);
                        $('.last_drawn_basic_salary').val(response.data.basic_salary);
                        if ($('.date_of_exit').val()) {
                            calculate_service_and_gratuity();
                        }
                    } else {
                        alert(response.message || 'Error loading employee details');
                        clear_employee_fields();
                    }
                },
                error: function(xhr, status, error) {
                    console.error('Error fetching employee details:', error);
                    alert('Error loading employee details. Please try again.');
                    clear_employee_fields();
                }
            });
        }

        // Trigger calculation when exit date or basic salary changes
        $('.date_of_exit, .last_drawn_basic_salary').on('change', function() {
            calculate_service_and_gratuity();
        });

        // Trigger calculation when any field affecting final settlement amount changes
        $('.date_of_exit, .last_drawn_basic_salary, .loss_of_pay_days, .leave_balance, .bonus_amount, .other_allowances, .deduction, .other_deduction, .loan_recovery, .notice_pay').on('change', function() {
            calculate_final_settlement_amount();
        });

        function calculate_service_and_gratuity() {
            var joinDate = $('.date_of_joining').val();
            var exitDate = $('.date_of_exit').val();
            var basicSalary = parseFloat($('.last_drawn_basic_salary').val());
            if (!joinDate || !exitDate) {
                $('.total_years_of_service').val('');
                $('.acrude_days').val('');
                $('.eligible_gratuity').val('');
                return;
            }
            var start = new Date(joinDate);
            var end = new Date(exitDate);
            if (end <= start) {
                $('.total_years_of_service').val('');
                $('.acrude_days').val('');
                $('.eligible_gratuity').val('');
                return;
            }
            // Calculate total years, months, days
            var years = end.getFullYear() - start.getFullYear();
            var months = end.getMonth() - start.getMonth();
            var days = end.getDate() - start.getDate();
            if (days < 0) {
                months -= 1;
                days += new Date(end.getFullYear(), end.getMonth(), 0).getDate();
            }
            if (months < 0) {
                years -= 1;
                months += 12;
            }
            var totalService = years + (months / 12) + (days / 365);
            $('.total_years_of_service').val(totalService.toFixed(2));

            // Acrude Days Calculation
            var acrudeDays = 0;
            if (years < 1 || (years === 1 && months === 0 && days === 0)) {
                acrudeDays = 0;
            } else {
                // Skip first year
                var serviceMonths = (years * 12 + months) - 12;
                if (serviceMonths > 0) {
                    var years_2_5 = Math.min(48, serviceMonths); // up to 4 years (2-5)
                    var years_above_5 = Math.max(0, serviceMonths - 48); // months above 5 years
                    acrudeDays += (years_2_5 / 12) * 21;
                    acrudeDays += (years_above_5 / 12) * 30;
                }
            }
            $('.acrude_days').val(Math.floor(acrudeDays));

            // Eligible Gratuity Calculation
            var eligibleGratuity = 0;
            if (acrudeDays > 0 && basicSalary > 0) {
                var perDayBasic = basicSalary / 30;
                eligibleGratuity = perDayBasic * acrudeDays;
            }
            $('.eligible_gratuity').val(eligibleGratuity.toFixed(2));
            

        }

        function calculate_final_settlement_amount() {
            var eligibleGratuity = parseFloat($('.eligible_gratuity').val()) || 0;
            var basicSalary = parseFloat($('.last_drawn_basic_salary').val()) || 0;
            var perDayBasic = basicSalary / 30;

            var lossOfPayDays = parseFloat($('.loss_of_pay_days').val()) || 0;
            var lossOfPayAmount = perDayBasic * lossOfPayDays;

            var leaveBalanceDays = parseFloat($('.leave_balance_days').val()) || 0;
            var leaveEncashmentAmount = perDayBasic * leaveBalanceDays;
            $('.leave_encashment_amount').val(leaveEncashmentAmount.toFixed(2));

            var bonusAmount = parseFloat($('.bonus_amount').val()) || 0;
            var otherAllowances = parseFloat($('.other_allowances').val()) || 0;
            var deduction = parseFloat($('.deductions').val()) || 0;
            var otherDeduction = parseFloat($('.other_deductions').val()) || 0;
            var loanRecovery = parseFloat($('.loan_recovery').val()) || 0;
            var noticePay = parseFloat($('.notice_pay').val()) || 0;

            var total = eligibleGratuity - lossOfPayAmount + leaveEncashmentAmount + bonusAmount + otherAllowances - deduction - otherDeduction - loanRecovery + noticePay;
            $('.final_settlement_amount').val(total.toFixed(2));
        }
    });
</script>


