<!-- Add Leave Modal -->
<div class="offcanvas offcanvas-end offcanvas-large" tabindex="-1" id="offcanvas_leave_add">
    <div class="offcanvas-header border-bottom">
        <h4>Add New Leave</h4>
        <button type="button" class="btn-close custom-btn-close border p-1 me-0" data-bs-dismiss="offcanvas" aria-label="Close">
            <i class="ti ti-x"></i>
        </button>
    </div>
    <div class="offcanvas-body">
        <form id="leave_add_form" action="{% url 'leave_transaction_add' %}" method="POST" enctype="multipart/form-data">
            {% csrf_token %}
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label class="col-form-label">Employee Code <span class="text-danger">*</span></label>
                    <select class="form-control" name="employee" id="add_employee_code" required>
                        <option value="">Select Employee</option>
                        {% for emp in employees %}
                        <option value="{{ emp.emp_code }}" 
                                data-name="{{ emp.emp_name }}"
                                data-department="{{ emp.department }}"
                                data-designation="{{ emp.designation }}"
                                data-join-date="{{ emp.date_of_join|date:'Y-m-d' }}"
                                data-rejoin-date="{{ emp.date_of_rejoin|date:'Y-m-d' }}">
                            {{ emp.emp_code }} - {{ emp.emp_name }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-6 mb-3">
                    <label class="col-form-label">Employee Name <span class="text-danger">*</span></label>
                    <input class="form-control" name="employee_name" id="add_employee_name" type="text" readonly>
                </div>
                <div class="col-md-6 mb-3">
                    <label class="col-form-label">Department</label>
                    <input class="form-control" name="department" id="add_department" type="text" readonly>
                </div>
                <div class="col-md-6 mb-3">
                    <label class="col-form-label">Designation</label>
                    <input class="form-control" name="designation" id="add_designation" type="text" readonly>
                </div>
                <div class="col-md-6 mb-3">
                    <label class="col-form-label">Date of Application <span class="text-danger">*</span></label>
                    <input class="form-control" name="date_of_application" id="add_date_of_application" type="date" required>
                </div>
                <div class="col-md-6 mb-3">
                    <label class="col-form-label">Leave Type <span class="text-danger">*</span></label>
                    <select class="form-control" name="leave_type" id="add_leave_type" required>
                        <option value="">Select Leave Type</option>
                        {% for leave in leave_types %}
                        <option value="{{ leave.base_value }}">{{ leave.base_value }} - {{ leave.base_description }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-6 mb-3">
                    <label class="col-form-label">Eligible Leave Days</label>
                    <input class="form-control" name="eligible_leave_days" id="add_eligible_leave_days" type="number" min="0" readonly>
                </div>
                <div class="col-md-6 mb-3">
                    <label class="col-form-label">Start Date <span class="text-danger">*</span></label>
                    <input class="form-control" name="start_date" id="add_start_date" type="date" required>
                </div>
                <div class="col-md-6 mb-3">
                    <label class="col-form-label">End Date <span class="text-danger">*</span></label>
                    <input class="form-control" name="end_date" id="add_end_date" type="date" required>
                </div>
                <div class="col-md-6 mb-3">
                    <label class="col-form-label">Total Leave Days</label>
                    <input class="form-control" name="total_leave_days" id="add_total_leave_days" type="number" min="0" readonly>
                </div>
                <div class="col-md-12 mb-3">
                    <label class="col-form-label">Reason for Leave</label>
                    <textarea class="form-control" name="reason_for_leave" id="add_reason_for_leave" rows="3"></textarea>
                </div>
                <div class="col-md-6 mb-3">
                    <label class="col-form-label">Contact During Leave</label>
                    <input class="form-control" name="contact_during_leave" id="add_contact_during_leave" type="text">
                </div>
                <div class="col-md-6 mb-3">
                    <label class="col-form-label">Leave Policy Agreed <span class="text-danger">*</span></label>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" name="leave_policy_agreed" id="add_leave_policy_agreed" required>
                        <label class="form-check-label">
                            I agree to the leave policy
                        </label>
                    </div>
                </div>
                <div class="col-md-6 mb-3">
                    <label class="col-form-label">Supporting Document</label>
                    <input class="form-control" name="supporting_document" id="add_supporting_document" type="file">
                </div>
                <div class="col-md-6 mb-3">
                    <label class="col-form-label">Delegate Person (if any)</label>
                    <input class="form-control" name="delegate_person" id="add_delegate_person" type="text">
                </div>
            </div>
            <div class="d-flex justify-content-end">
                <button type="button" class="btn btn-light me-2" data-bs-dismiss="offcanvas">Cancel</button>
                <button type="submit" class="btn btn-primary">Save</button>
            </div>
        </form>
    </div>
</div>

<!-- Edit Leave Modal -->
<div class="offcanvas offcanvas-end offcanvas-large" tabindex="-1" id="offcanvas_leave_edit">
    <div class="offcanvas-header border-bottom">
        <h4>Edit Leave</h4>
        <button type="button" class="btn-close custom-btn-close border p-1 me-0" data-bs-dismiss="offcanvas" aria-label="Close">
            <i class="ti ti-x"></i>
        </button>
    </div>
    <div class="offcanvas-body">
        <form id="leave_edit_form" action="{% url 'leave_transaction_edit' %}" method="POST" enctype="multipart/form-data">
            {% csrf_token %}
            <input type="hidden" name="leave_id" id="edit_leave_id">
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label class="col-form-label">Employee Code <span class="text-danger">*</span></label>
                    <select class="form-control" name="employee" id="edit_employee_code" required>
                        <option value="">Select Employee</option>
                        {% for emp in employees %}
                        <option value="{{ emp.emp_code }}" 
                                data-name="{{ emp.emp_name }}"
                                data-department="{{ emp.department }}"
                                data-designation="{{ emp.designation }}"
                                data-join-date="{{ emp.date_of_join|date:'Y-m-d' }}"
                                data-rejoin-date="{{ emp.date_of_rejoin|date:'Y-m-d' }}">
                            {{ emp.emp_code }} - {{ emp.emp_name }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-6 mb-3">
                    <label class="col-form-label">Employee Name <span class="text-danger">*</span></label>
                    <input class="form-control" name="employee_name" id="edit_employee_name" type="text" readonly>
                </div>
                <div class="col-md-6 mb-3">
                    <label class="col-form-label">Department</label>
                    <input class="form-control" name="department" id="edit_department" type="text" readonly>
                </div>
                <div class="col-md-6 mb-3">
                    <label class="col-form-label">Designation</label>
                    <input class="form-control" name="designation" id="edit_designation" type="text" readonly>
                </div>
                <div class="col-md-6 mb-3">
                    <label class="col-form-label">Date of Application <span class="text-danger">*</span></label>
                    <input class="form-control" name="date_of_application" id="edit_date_of_application" type="date" required>
                </div>
                <div class="col-md-6 mb-3">
                    <label class="col-form-label">Leave Type <span class="text-danger">*</span></label>
                    <select class="form-control" name="leave_type" id="edit_leave_type" required>
                        <option value="">Select Leave Type</option>
                        {% for leave in leave_types %}
                        <option value="{{ leave.base_value }}">{{ leave.base_value }} - {{ leave.base_description }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-6 mb-3">
                    <label class="col-form-label">Eligible Leave Days</label>
                    <input class="form-control" name="eligible_leave_days" id="edit_eligible_leave_days" type="number" min="0" readonly>
                </div>
                <div class="col-md-6 mb-3">
                    <label class="col-form-label">Start Date <span class="text-danger">*</span></label>
                    <input class="form-control" name="start_date" id="edit_start_date" type="date" required>
                </div>
                <div class="col-md-6 mb-3">
                    <label class="col-form-label">End Date <span class="text-danger">*</span></label>
                    <input class="form-control" name="end_date" id="edit_end_date" type="date" required>
                </div>
                <div class="col-md-6 mb-3">
                    <label class="col-form-label">Total Leave Days</label>
                    <input class="form-control" name="total_leave_days" id="edit_total_leave_days" type="number" min="0" readonly>
                </div>
                <div class="col-md-12 mb-3">
                    <label class="col-form-label">Reason for Leave</label>
                    <textarea class="form-control" name="reason_for_leave" id="edit_reason_for_leave" rows="3"></textarea>
                </div>
                <div class="col-md-6 mb-3">
                    <label class="col-form-label">Contact During Leave</label>
                    <input class="form-control" name="contact_during_leave" id="edit_contact_during_leave" type="text">
                </div>
                <div class="col-md-6 mb-3">
                    <label class="col-form-label">Leave Policy Agreed <span class="text-danger">*</span></label>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" name="leave_policy_agreed" id="edit_leave_policy_agreed" required>
                        <label class="form-check-label">
                            I agree to the leave policy
                        </label>
                    </div>
                </div>
                <div class="col-md-6 mb-3">
                    <label class="col-form-label">Supporting Document</label>
                    <input class="form-control" name="supporting_document" id="edit_supporting_document" type="file">
                    <div id="edit_document_preview" class="mt-2" style="display: none;">
                        <div class="btn-group">
                            <a href="#" class="btn btn-sm btn-info" id="edit_document_preview_btn" target="_blank">
                                <i class="ti ti-eye"></i> Preview
                            </a>
                            <a href="#" class="btn btn-sm btn-info" id="edit_document_download" target="_blank">
                                <i class="ti ti-download"></i> Download
                            </a>
                        </div>
                    </div>
                </div>
                <div class="col-md-6 mb-3">
                    <label class="col-form-label">Delegate Person (if any)</label>
                    <input class="form-control" name="delegate_person" id="edit_delegate_person" type="text">
                </div>
            </div>
            <div class="d-flex justify-content-end">
                <button type="button" class="btn btn-light me-2" data-bs-dismiss="offcanvas">Cancel</button>
                <button type="submit" class="btn btn-primary edit-btn">Update</button>
            </div>
        </form>
    </div>
</div>

<!-- Delete Leave Modal -->
<div class="modal fade" id="delete_leave" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Delete Leave</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete this leave transaction?</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-light" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirm_delete">Delete</button>
            </div>
        </div>
    </div>
</div>

<!-- Add jQuery -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Function to calculate eligible leave days
    function calculateEligibleDays(joinDate, rejoinDate) {
        var startDate = rejoinDate || joinDate;
        var today = new Date();
        var diffTime = Math.abs(today - new Date(startDate));
        var diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
        var months = Math.floor(diffDays / 30);
        return Math.floor(months * 2.5); // 2.5 days per month (30 days per year)
    }

    // Function to validate dates and total days
    function validateDates(startDate, endDate, eligibleDays, totalDaysInput) {
        var start = new Date(startDate);
        var end = new Date(endDate);
        var today = new Date();
        
        // Reset time part for accurate date comparison
        start.setHours(0, 0, 0, 0);
        end.setHours(0, 0, 0, 0);
        today.setHours(0, 0, 0, 0);
        
        if (start < today) {
            alert('Start date cannot be in the past');
            totalDaysInput.val('');
            return false;
        }
        
        if (start > end) {
            alert('End date must be greater than start date');
            totalDaysInput.val('');
            return false;
        }
        
        var diffTime = Math.abs(end - start);
        var diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1;
        
        if (diffDays > eligibleDays) {
            alert('Total leave days cannot exceed eligible days (' + eligibleDays + ' days)');
            totalDaysInput.val('');
            return false;
        }
        
        totalDaysInput.val(diffDays);
        return true;
    }

    // Function to handle employee selection
    function handleEmployeeSelection(employeeSelect, nameInput, departmentInput, designationInput, eligibleDaysInput) {
        var selectedOption = $(employeeSelect).find('option:selected');
        var joinDate = selectedOption.data('join-date');
        var rejoinDate = selectedOption.data('rejoin-date');
        
        // Debug log to check data
        console.log('Selected Option:', selectedOption);
        console.log('Data:', {
            name: selectedOption.data('name'),
            department: selectedOption.data('department'),
            designation: selectedOption.data('designation'),
            joinDate: joinDate,
            rejoinDate: rejoinDate
        });
        
        // Set the values
        $(nameInput).val(selectedOption.data('name') || '');
        $(departmentInput).val(selectedOption.data('department') || '');
        $(designationInput).val(selectedOption.data('designation') || '');
        
        var eligibleDays = calculateEligibleDays(joinDate, rejoinDate);
        $(eligibleDaysInput).val(eligibleDays);
    }

    // Handle employee selection for add form
    $('#add_employee_code').change(function() {
        handleEmployeeSelection(
            this,
            '#add_employee_name',
            '#add_department',
            '#add_designation',
            '#add_eligible_leave_days'
        );
    });

    // Handle employee selection for edit form
    $('#edit_employee_code').change(function() {
        handleEmployeeSelection(
            this,
            '#edit_employee_name',
            '#edit_department',
            '#edit_designation',
            '#edit_eligible_leave_days'
        );
    });

    // Set min date for start date inputs
    var today = new Date().toISOString().split('T')[0];
    $('#add_start_date, #edit_start_date').attr('min', today);

    // Handle start date change
    $('#add_start_date, #edit_start_date').change(function() {
        var formId = $(this).closest('form').attr('id');
        var startDate = $(this).val();
        var endDateInput = formId === 'leave_add_form' ? $('#add_end_date') : $('#edit_end_date');
        
        // Set min date for end date to be start date
        endDateInput.attr('min', startDate);
        
        // If end date is before new start date, clear it
        if (endDateInput.val() && endDateInput.val() < startDate) {
            endDateInput.val('');
            var totalDaysInput = formId === 'leave_add_form' ? $('#add_total_leave_days') : $('#edit_total_leave_days');
            totalDaysInput.val('');
        }
    });

    // Calculate total leave days when dates change (for both add and edit forms)
    $('#add_start_date, #add_end_date, #edit_start_date, #edit_end_date').change(function() {
        var formId = $(this).closest('form').attr('id');
        var startDate = formId === 'leave_add_form' ? $('#add_start_date').val() : $('#edit_start_date').val();
        var endDate = formId === 'leave_add_form' ? $('#add_end_date').val() : $('#edit_end_date').val();
        var totalDaysInput = formId === 'leave_add_form' ? $('#add_total_leave_days') : $('#edit_total_leave_days');
        var eligibleDays = formId === 'leave_add_form' ? $('#add_eligible_leave_days').val() : $('#edit_eligible_leave_days').val();
        
        if (startDate && endDate) {
            validateDates(startDate, endDate, eligibleDays, totalDaysInput);
        }
    });

    // Handle add form submission
    $('#leave_add_form').submit(function(e) {
        e.preventDefault();
        var startDate = $('#add_start_date').val();
        var endDate = $('#add_end_date').val();
        var eligibleDays = $('#add_eligible_leave_days').val();
        var totalDays = $('#add_total_leave_days').val();
        
        if (!validateDates(startDate, endDate, eligibleDays, $('#add_total_leave_days'))) {
            return;
        }
        
        var formData = new FormData(this);
        
        $.ajax({
            url: $(this).attr('action'),
            type: 'POST',
            data: formData,
            processData: false,
            contentType: false,
            success: function(response) {
                if (response.status === 'success') {
                    alert(response.message);
                    $('#offcanvas_leave_add').offcanvas('hide');
                    location.reload();
                } else {
                    alert(response.message);
                }
            },
            error: function(xhr, status, error) {
                alert('An error occurred while processing your request');
            }
        });
    });

    // Handle edit form submission
    $('#leave_edit_form').submit(function(e) {
        e.preventDefault();
        var startDate = $('#edit_start_date').val();
        var endDate = $('#edit_end_date').val();
        var eligibleDays = $('#edit_eligible_leave_days').val();
        var totalDays = $('#edit_total_leave_days').val();
        
        if (!validateDates(startDate, endDate, eligibleDays, $('#edit_total_leave_days'))) {
            return;
        }
        
        var formData = new FormData(this);
        
        $.ajax({
            url: $(this).attr('action'),
            type: 'POST',
            data: formData,
            processData: false,
            contentType: false,
            success: function(response) {
                if (response.status === 'success') {
                    alert(response.message);
                    $('#offcanvas_leave_edit').offcanvas('hide');
                    location.reload();
                } else {
                    alert(response.message);
                }
            },
            error: function(xhr, status, error) {
                alert('An error occurred while processing your request');
            }
        });
    });

    // Handle edit button click
    $('.edit-leave-btn').click(function(e) {
        e.preventDefault();
        var leaveId = $(this).data('id');
        
        $.ajax({
            url: '{% url "leave_transaction_edit" %}',
            type: 'GET',
            data: { id: leaveId },
            success: function(response) {
                if (response.status === 'success') {
                    var data = response.data;
                    $('#edit_leave_id').val(data.id);
                    $('#edit_employee_code').val(data.employee);
                    $('#edit_employee_name').val(data.employee_name);
                    $('#edit_department').val(data.department);
                    $('#edit_designation').val(data.designation);
                    $('#edit_date_of_application').val(data.date_of_application);
                    $('#edit_leave_type').val(data.leave_type);
                    $('#edit_eligible_leave_days').val(data.eligible_leave_days);
                    $('#edit_start_date').val(data.start_date);
                    $('#edit_end_date').val(data.end_date);
                    $('#edit_total_leave_days').val(data.total_leave_days);
                    $('#edit_reason_for_leave').val(data.reason_for_leave);
                    $('#edit_contact_during_leave').val(data.contact_during_leave);
                    $('#edit_leave_policy_agreed').prop('checked', data.leave_policy_agreed);
                    $('#edit_delegate_person').val(data.delegate_person);
                    
                    // Handle document preview
                    if (data.supporting_document) {
                        var documentUrl = data.supporting_document;
                        $('#edit_document_preview').show();
                        $('#edit_document_preview_btn').attr('href', documentUrl);
                        $('#edit_document_download').attr('href', documentUrl);
                        
                        // Debug log
                        console.log('Document URL:', documentUrl);
                        console.log('Preview Button:', $('#edit_document_preview_btn').attr('href'));
                        console.log('Download Button:', $('#edit_document_download').attr('href'));
                    } else {
                        $('#edit_document_preview').hide();
                    }
                    
                    $('#offcanvas_leave_edit').offcanvas('show');
                } else {
                    alert(response.message);
                }
            },
            error: function(xhr, status, error) {
                alert('An error occurred while fetching leave details');
            }
        });
    });

    // Handle delete button click
    $('.delete-btn').click(function(e) {
        e.preventDefault();
        var leaveId = $(this).data('leave-id');
        $('#confirm_delete').data('leave-id', leaveId);
    });

    // Handle delete confirmation
    $('#confirm_delete').click(function() {
        var leaveId = $(this).data('leave-id');
        
        $.ajax({
            url: '{% url "leave_transaction_delete" %}',
            type: 'POST',
            data: {
                leave_id: leaveId,
                csrfmiddlewaretoken: '{{ csrf_token }}'
            },
            success: function(response) {
                if (response.status === 'success') {
                    alert(response.message);
                    $('#delete_leave').modal('hide');
                    location.reload();
                } else {
                    alert(response.message);
                }
            },
            error: function(xhr, status, error) {
                alert('An error occurred while deleting the leave');
            }
        });
    });

    // Handle file input change for edit form
    $('#edit_supporting_document').change(function() {
        var file = this.files[0];
        if (file) {
            var reader = new FileReader();
            reader.onload = function(e) {
                $('#edit_document_preview').show();
                $('#edit_document_preview_btn').attr('href', e.target.result);
                $('#edit_document_download').attr('href', e.target.result);
            };
            reader.readAsDataURL(file);
        } else {
            $('#edit_document_preview').hide();
        }
    });

    // Reset forms when modals are closed
    $('#offcanvas_leave_add').on('hidden.bs.offcanvas', function() {
        $('#leave_add_form')[0].reset();
    });

    $('#offcanvas_leave_edit').on('hidden.bs.offcanvas', function() {
        $('#leave_edit_form')[0].reset();
        $('#edit_document_preview').hide();
    });
});
</script>