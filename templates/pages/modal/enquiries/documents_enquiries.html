{% extends 'partials/base.html' %}
{% load static %}

{% block content %}

<style>
    .bg-green { background-color: #d4edda !important; }  /* light green */
    .bg-yellow { background-color: #fff3cd !important; } /* light yellow */
    .bg-red { background-color: #f8d7da !important; }     /* light red */
    .bg-gray { background-color: #e2e3e5 !important; }    /* light gray */
</style>

<div class="page-wrapper" style="height: 100vh; display: flex; flex-direction: column;">
    <!-- Fixed Search Section -->
    <div class="content-header" style="padding: 20px; background-color: #f8f9fa; border-bottom: 1px solid #dee2e6;">
        <h1>Documents Enquiries</h1>

        <!-- Search Form -->
        <form method="get" action="{% url 'documents_enquiries' %}" class="mb-4">
            <div class="row">
                <div class="col-md-4">
                    <select name="category" id="category" class="form-control">
                        <option value="employee_document" {% if category == "employee_document" %}selected{% endif %}>Employee Documents</option>
                        <option value="dependent_document" {% if category == "dependent_document" %}selected{% endif %}>Dependent Documents</option>
                         <option value="license_and_passes" {% if category == "license_and_passes" %}selected{% endif %}>License and Passes</option>
                        <option value="camp_document" {% if category == "camp_document" %}selected{% endif %}>Camp Documents</option>
                        <option value="party_document" {% if category == "party_document" %}selected{% endif %}>Party Documents</option>
                    </select>
                </div>
                <div class="col-md-6">
                    <input type="text" name="keyword" class="form-control" placeholder="Search by Code or Document Type" value="{{ keyword }}">
                </div>
                <div class="col-md-2">
                    <button type="submit" class="btn btn-primary w-100">Search</button>
                </div>
            </div>
        </form>
    </div>

    <!-- Scrollable Content -->
    <div class="content" style="flex: 1; overflow-y: auto; padding: 20px;">
        <!-- Employee Documents -->
        {% if category == "employee_document" %}
        <h3>Employee Documents</h3>
        <div class="table-responsive">
            <table class="table table-bordered">
                <thead>
                    <tr>
                        <th>Employee Code</th>
                        <th>Document Type</th>
                        <th>Document File</th>
                    </tr>
                </thead>
                <tbody>
                    {% for doc in employee_documents %}
                    <tr>
                        <td>{{ doc.emp_code }}</td>
                        <td>{{ doc.document_type }}</td>
                        <td>
                            {% if doc.document_file %}
                            <a href="{{ doc.document_file.url }}" target="_blank" class="btn btn-sm btn-info">View</a>
                            {% else %}
                            No File
                            {% endif %}
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="3" class="text-center">No Employee Documents Found</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% endif %}

        <!-- Dependent Documents -->
        {% if category == "dependent_document" %}
        <h3>Dependent Documents</h3>
        <div class="table-responsive">
            <table class="table table-bordered">
                <thead>
                    <tr>
                        <th>Employee Code</th>
                        <th>Relationship</th>
                        <th>Document Type</th>
                        <th>Document File</th>
                        <th>Issued Date</th>
                        <th>Expiry Date</th>
                        <th>Days to Expiry</th>
                    </tr>
                </thead>
                <tbody>
                    {% for doc in dependent_documents %}
                    <tr>
                        <td>{{ doc.emp_code }}</td>
                        <td>{{ doc.relationship }}</td>
                        <td>{{ doc.document_type }}</td>
                        <td>
                            {% if doc.document_file %}
                            <a href="{{ doc.document_file.url }}" target="_blank" class="btn btn-sm btn-info">View</a>
                            {% else %}
                            No File
                            {% endif %}
                        </td>
                        <td>{{ doc.issued_date }}</td>
                        <td class="expiry-date">{{ doc.expiry_date|date:"Y-m-d" }}</td>
                        <td class="days-to-expiry"></td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="4" class="text-center">No Dependent Documents Found</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% endif %}

        <!-- Camp Documents -->
        {% if category == "camp_document" %}
        <h3>Camp Documents</h3>
        <div class="table-responsive">
            <table class="table table-bordered">
                <thead>
                    <tr>
                        <th>Camp Code</th>
                        <th>Document Name</th>
                        <th>Document File</th>
                    </tr>
                </thead>
                <tbody>
                    {% for doc in camp_documents %}
                    <tr>
                        <td>{{ doc.camp_code }}</td>
                        <td>{{ doc.document_name }}</td>
                        <td>
                            {% if doc.document_file %}
                            <a href="{{ doc.document_file.url }}" target="_blank" class="btn btn-sm btn-info">View</a>
                            {% else %}
                            No File
                            {% endif %}
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="3" class="text-center">No Camp Documents Found</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% endif %}

        <!-- Party Documents -->
        {% if category == "party_document" %}
        <h3>Other Documents</h3>
        <div class="table-responsive">
            <table class="table table-bordered">
                <thead>
                    <tr>
                        <th>Customer Code</th>
                        <th>Document Name</th>
                        <th>Document File</th>
                    </tr>
                </thead>
                <tbody>
                    {% for doc in party_documents %}
                    <tr>
                        <td>{{ doc.customer_code }}</td>
                        <td>{{ doc.document_name }}</td>
                        <td>
                            {% if doc.document_file %}
                            <a href="{{ doc.document_file.url }}" target="_blank" class="btn btn-sm btn-info">View</a>
                            {% else %}
                            No File
                            {% endif %}
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="3" class="text-center">No Other Documents Found</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% endif %}
        <!-- license_and_passes -->
        {% if category == "license_and_passes" %}
        <h3>Employee Documents</h3>
        <div class="table-responsive">
            <table class="table table-bordered">
                <thead>
                    <tr>
                        <th>Employee Code</th>
                        <th>Document Type</th>
                        <th>Document File</th>
                        <th>Emirate Issued By</th>
                        <th>Expiry Date</th>
                        <th>Days to Expiry</th>
                    </tr>
                </thead>
                <tbody>
                    {% for doc in license_and_passes %}
                    <tr>
                        <td>{{ doc.emp_code }}</td>
                        <td>{{ doc.document_type }}</td>
                        <td>
                            {% if doc.document_file %}
                            <a href="{{ doc.document_file.url }}" target="_blank" class="btn btn-sm btn-info">View</a>
                            {% else %}
                            No File
                            {% endif %}
                        </td>
                        <td>
                            {{ doc.emirate_issued_by }}
                        </td>
                        <td class="expiry-date">{{ doc.expiry_date|date:"Y-m-d" }}</td>
                        <td class="days-to-expiry"></td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="3" class="text-center">No Employee Documents Found</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% endif %}

    </div>
</div>
<script>
    document.addEventListener("DOMContentLoaded", function () {
      const rows = document.querySelectorAll("tbody tr");
  
      rows.forEach((row) => {
        const expiryCell = row.querySelector(".expiry-date");
        const daysCell = row.querySelector(".days-to-expiry");
        const expiryDateText = expiryCell.textContent.trim();
  
        if (expiryDateText) {
          const expiryDate = new Date(expiryDateText);
          const today = new Date();
          const timeDiff = expiryDate - today;
          const daysDiff = Math.ceil(timeDiff / (1000 * 60 * 60 * 24));
  
          daysCell.textContent = daysDiff >= 0 ? daysDiff + " days" : "Expired";
  
          if (daysDiff < 0) {
            daysCell.classList.add("bg-gray");
          } else if (daysDiff < 30) {
            daysCell.classList.add("bg-red");
          } else if (daysDiff < 60) {
            daysCell.classList.add("bg-yellow");
          } else {
            daysCell.classList.add("bg-green");
          }
        } else {
          daysCell.textContent = "N/A";
          daysCell.classList.add("bg-gray");
        }
      });
    });
  </script>
{% endblock %}